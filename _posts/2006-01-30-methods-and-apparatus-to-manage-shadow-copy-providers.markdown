---

title: Methods and apparatus to manage shadow copy providers
abstract: A data storage management system includes a virtual provider for interacting with a coordinator to receive shadow copy requests from a requestor and for interfacing with a plurality of providers that support various logical units on which data volumes can be stored. The virtual provider appears to the coordinator as a provider and can generate a shadow copy of a first one of the data volumes that spans multiple ones of the logical units, which are supported by different ones of the plurality of providers.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08150936&OS=08150936&RS=08150936
owner: EMC Corporation
number: 08150936
owner_city: Hopkinton
owner_country: US
publication_date: 20060130
---
As is known in the art conventional applications and services enable data storage systems to provide point in time replicas or shadow copies of a data volume which can be stored on logical units LUNs . Such applications can enable a user to recover an earlier version of a file for example. U.S. Patent Publication No. US 2005 0228832 to Ghotge et al. U.S. Patent Publication No. US 2005 0028026 to Shirley et al. and U.S. Pat. No. 6 708 227 to Cabrera et al. all of which are incorporated herein by reference disclose shadow copy systems.

Exemplary embodiments described herein provide a data storage management system including shadow copy functionality with a virtual provider that overcomes certain limitations of known systems. With this arrangement a copy coordinator is decoupled from providers that support various logical units to enhance the shadow copy functionality. While the various embodiments are primarily shown and described in conjunction with the volume shadow copy service of the WINDOWS SERVER 2003 platform by MICROSOFT corporation it is understood that the embodiments are applicable to applications and systems in general in which it is desirable to create and manage replicas of data volumes.

Before describing exemplary embodiments in detail some introductory material is presented. One platform that provides shadow copy capability is Microsoft Server 2003 by Microsoft Corporation of Redmond Wash. which includes a Volume Shadow Copy Service VSS and Virtual Disk Service VDS API Application Programming Interface . These technologies provide enhanced backup and recovery of data and improved storage visibility and management on the Microsoft Windows platform as compared with previous systems.

The Volume Shadow Copy Service VSS enables fast backup and recovery of system states and applications by coordinating with other components to generate consistent point in time copies which are referred to as shadow copies of the production data while the applications are online. While some copy services such as VSS support shadow copy functionality existing services have certain shortcomings. For example a volume can include more than one LUN. In known copy services a shadow copy of the volume cannot be taken with a given provider if all LUNs underneath the volume are not supported by the provider. For example a volume can be located on five LUNs where provider A supports the first four LUNs and provider B supports a fifth LUN. A shadow copy of the volume cannot be taken using provider A provider B or the combination of providers A and B since the volume spans multiple LUNs having different providers.

In addition a coordinator may process the first four LUNs before discovering that provider A does not work because of the fifth LUN which is supported by provider B. Then the coordinator must search for another provider and the whole process plays over again. The coordinator may end up using an inferior provider for the volume resulting in degraded performance or functionality. Or the coordinator may determine that a shadow copy of this volume cannot be taken.

While one may require a user to ensure that all LUNs in a volume are supported by the same hardware or software provider this is an undesirable burden on the user. It is preferable that a user not need to keep track of which LUN is supported by which provider.

Further there often exist multiple hardware providers each of which is capable of supporting a given set of LUNs. However the coordinator behavior may be undefined in selecting a hardware provider in such a situation. The unpredictable nature of the provider selection can lead to erratic performance and functionality.

When more than one hardware provider can support a given set of LUNs the coordinator may not have the ability to manage differentiate and or effectively use those providers. Suppose two hardware providers A B are both able to support a set of LUNs that make up a volume. Provider A has additional functionality but is slower while provider B has better performance. Because of strict timing requirements for example shadow copies taken using provider A may have a statistically higher failure rate than copies taken using provider B. However the coordinator cannot make the best use of either provider. For example it will not favor provider B to improve the success rate even if the additional functionality is not needed.

In addition in known copy applications the framework mandates that providers must respond to every requestor i.e. the component that initiates the shadow copy process. However there may exist some providers such as so called private or protected providers having superior performance and functionality that only respond to a predefined set of requesters. The enforcement of such a framework mandate would deem those providers unqualified and unusable and therefore would waste development time and investment in such providers.

In the illustrated embodiment the first provider provider A interacts with the first LUN and the third LUN . The second provider provider B interacts with the second and third LUNs . As can be seen the first volume volume X spans the first and second LUNs . As noted above the first LUN is supported by the first provider and the second LUN is supported by the second provider . That is the first volume is located on LUNs that are supported by different providers . The second volume volume Y is located on the third LUN which are supported by both the first and second providers . When creating a shadow copy of the second volume Volume Y a selection mechanism can be used by the virtual provider to select an optimal provider A or B for the third LUN as described more fully below.

In general a requester is an application that initiates the shadow copy creation backup process. In addition the requestor application can initiate other tasks such as importing a shadow copy to a backup server querying deleting and restoring the shadow copy. A requestor can also communicate with writers directly to gather information regarding shadow copy creation and usage. Examples of requesters include Networker RM and RMISE applications by EMC Corporation which are well known to those of ordinary skill in the art.

A writer is a part of an application or operating system service that ensures the consistency of a shadow copy. A writer also contains information about what to backup and how to restore. It can directly communicate this information to a requestor for more granular control of the backup and or restore process.

During the shadow copy creation backup process the writer freezes the application or service s I O activities for a brief period of time to guarantee the shadow copy s point in timeness. During the restore process the writer can also be involved to provide guidance on how what and where to restore the shadow copy and to avoid data inconsistency. Examples of writers include the Microsoft Exchange 2003 Writer the SQL 2000 Writer and the Registry and Event Log Writers that are part of Windows Server 2003.

A provider is the component that creates the point in time copy or shadow copy of the production data. The provider then maintains the shadow copy over its life cycle. Normally a provider can be a part of an application alternatively it can be run as a service. If a provider interacts with storage array hardware the provider is considered to be hardware based. Otherwise the provider is considered to be software based. One software based provider is the System Provider which is supplied as part of the Windows Server 2003.

In the conventional VSS framework the hierarchy for provider selection is in the following order 1 hardware provider 2 software provider and 3 system provider. However it lacks provider selection and management functionality as described more fully below. Examples of hardware providers include EMC Symmetrix VSS Provider EMC CLARiiON VSS Provider and RM SE s private VSS Provider.

The shadow copy coordinator provides the overall control and coordination among the components described above in the process of creating and managing shadow copies. In the existing VSS framework the coordinator is provided as the VSS coordinator of the WINDOWS operating system service. The coordinator prohibits direct communications a between a requestor and a provider and b between a writer and a provider . Communications are routed through the coordinator except that direct communications between a requester and a writer are allowed.

An exemplary embodiment includes a virtual provider that abstracts interaction with the various providers e.g. providers A B and C to enhance the user experience when creating and managing shadow copies. The virtual provider is located between the providers and the coordinator to manage and overcome certain limitations in conventional frameworks.

In one embodiment the virtual provider supports volume snapshots having LUNs not supported by only one provider. For example the first volume volume X spans the first and second LUNs . However the first provider provider A supports only the first LUNs . The second provider provider B supports the second LUN . The virtual provider facilitates the creation and management of the first volume across multiple LUNs having different providers.

Without the virtual provider the coordinator would be unable to create a shadow copy for the first volume since the coordinator does not allow multiple providers per volume.

Without the virtual provider the coordinator may attempt to process an access request for the first volume which is located on the first and second LUNs by first interacting with the first provider and then discovering that the first provider does not support access to the second LUN which is supported by the second provider provider B . Alternatively the user would have to ensure that all LUNs in a volume are supported by the same hardware or software provider which is an undesirable burden on the user.

The virtual provider implements the required shadow copy interfaces while appearing as a typical provider to the coordinator which communicates directly with the virtual provider . At the same time the virtual provider manages one or more physical providers underneath it.

The virtual provider maintains sufficient state information and invokes one or more physical providers under its control to take a shadow copy for a volume. Meanwhile the virtual provider interacts with the coordinator as a single provider and thus satisfies the single provider per volume requirement of conventional frameworks such as the Microsoft VSS framework.

In general the virtual provider intelligently manages hardware and software providers under its control by supplying functional flexibility and manageability and providing a unified interface to the coordinator . By decoupling the physical providers from the coordinator the virtual provider facilitates the addition of new features to providers under its management.

In one embodiment the virtual provider exposes a user interface element e.g. GUI graphical user interface or CLI command line interface or both that allows users to specify operational preferences and policies. Alternatively the virtual provider can use statistical information to aid in the decision making process. In one embodiment the virtual provider includes a provider selection mechanism for implementing user policies to select the optimal provider.

The virtual provider can have a statistics module to keep track of various provider performance metrics such as success versus failure statistics. The history and statistical information can also be used by the provider selection mechanism to select providers in various circumstances to ensure the best performance and success rate. Additionally state information for the virtual provider can include preferred requestor provider pairs for example.

For example if the first requestor requests access to the second volume which resides on the third LUN the virtual provider invokes the selection mechanism to select the best provider either or provider A or B for this request.

If multiple physical providers are equally capable then the virtual provider selects the most successful and or fastest provider for the request. It should be noted that all physical providers do not necessarily respond to every requester . The virtual provider functions as a normal provider to the coordinator and requestor . Due to the presence of the virtual provider the requestor and or coordinator do not necessarily need to know or care about the implementation details of the physical providers. And the requestor coordinator may not care about which physical provider actually fulfills the request.

Without the virtual provider in the case where there exist multiple hardware providers each capable of supporting a given set of LUNs the behavior of the coordinator may be inconsistent and or indeterministic. The unpredictability of the provider selection can lead to erratic performance and functionality and or operation failures due to provider mismatch.

As mentioned previously conventional frameworks mandate that any provider must respond to every requestor . However there may exist so called private or protected providers having superior performance and functionality that only respond to a predefined set of requestors. The enforcement of such a framework mandate deems those providers unqualified and unusable. On the other hand the virtual provider responds to any requester . It accepts the request from a requestor via coordinator and then forwards the request to a physical provider that is capable of handling such a request which may be a private or protected provider. The virtual provider can bridge the gap by accepting requests from any requester and forwarding those requests to appropriate providers including private providers under management. Therefore the virtual provider protects the development investment since private providers can still be used.

With regard to the third provider this provider directly communicates with the coordinator as prescribed by the existing VSS framework. Thus the virtual provider can co exist with conventional frameworks.

A statistics component can maintain a database of various performance metrics such as success and failure rate performance frequency of use etc. for each physical provider under management. A provider list keeps track of the physical providers under management. The list can be maintained in various formats well known to one of ordinary skill in the art such as a double linked list or other data structure. A snapshot information module maintains snapshot information as described more fully below.

The provider selection mechanism uses information from the policies component and the statistics module to intelligently select the optimal provider to perform a given task. When user policies are specified such policies will take precedence.

The exemplary sequences of steps for scenarios 1 2 and 5 above are described below as follows. In step it is determined whether LUN is supported by provider A. If so in step LUN is mapped to provider A. In step it is determined whether LUN is supported by provider A. If so then in step LUN is mapped to provider A and a flag i.e. AreLunsSupported is set to true in step . This is the case of scenario 1 above where both LUN and LUN are supported by provider A.

However if in step LUN was found not to be supported by provider A then in step it is determined whether LUN is supported by provider B. If so then in step LUN is mapped to provider B and a flag i.e. AreLunsSupported is set to true in step . This is the case for scenario 2 where LUN is supported by provider A and LUN is supported by provider B. Furthermore if LUN was found not to be supported by provider B then the flag is set to false in step . This falls under scenario 5 where LUN is supported by provider A but LUN is not supported by provider A or B.

It is apparent that exemplary sequences of steps for scenarios three and four can be constructed in the same fashion with the aid of however those steps are omitted herein for brevity. As noted above exemplary embodiments support the first four scenarios above where the existing VSS framework only supports scenarios one and four.

By using the virtual provider one can overcome a one provider per volume limitation of known frameworks. For instance the virtual provider can use provider A to support LUN and provider B to support LUN. To the coordinator the virtual provider acts as one provider that can support both LUN and LUN.

At step the coordinator calls the virtual provider to initiate BeginPrepareSnapshot. At step the virtual provider maps a target LUN SnapLUN to the source LUN LUN . This is performed with the aid of the mapped provider such as provider A or B. At step the virtual provider uses the mapped provider either A or B to prepare a snapshot for source LUN LUN . In step the virtual provider maps a further target LUN SnapLUN to a source LUN LUN . And in step the virtual provider uses the mapped provider A or B to prepare a snapshot for the target LUN LUN .

It is understood that this process can be repeated for additional LUNs and further volumes. At step the virtual provider sets the SnapshotSetID which is passed in by the coordinator. The SnapshotSetID uniquely identifies this particular snapshot set.

If it was determined in step that user policies are defined then in step provider selection is performed based on the user policies. For example components by the same vendor may be selected. It is understood that this selection mechanism is not limited to user policies and or statistics. In another embodiment after applying user policies in step step can be expanded to further refine the selection using statistics and historical information.

In one embodiment a configuration wizard allows a user to select from a list the physical providers that should be managed by the virtual provider. Alternatively the virtual provider can automatically discover register and manage installed physical providers. The virtual provider can discover installed physical providers and register and manage those physical providers that are made by a given vendor or a set of vendors.

It is understood that the exemplary embodiments described herein are applicable to a wide variety of systems having the ability to store and manage data. An exemplary data storage management system that can include a virtual provider is the EMC Information Replication IR system in which an IR Application client has shadow copy functionality. The EMC Information Replication system is shown and described in U.S. Patent Publication No. US2003 005120 A1 by Mutalik et al entitled Information Replication System Having Enhanced Error Detection And Recovery and incorporated herein by reference.

In the above detailed description of exemplary embodiments reference is made to the accompanied drawings which form a part hereof and which are shown by way of illustration specific exemplary embodiments. It is to be understood that other embodiments can be utilized and other changes can be made without departing from the spirit or scope of the illustrative embodiments shown and described herein. The above detailed description is therefore not to be taken in a limiting sense.

