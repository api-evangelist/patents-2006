---

title: Index mechanism for finding nearest matches in a computer system
abstract: A technique for finding the nearest match in a computer storage system is provided. A query statement includes a new operator that indicates that a user desires to access a set of rows that contain a value nearest to a target value. An index is accessed that is based at least in part on a column reference included in the statement. The index comprises a plurality of leaf nodes, where each leaf node comprises one or more entries, where each entry contains a key value, corresponding to the column reference, and a reference to a row in a table. Because leaf nodes in an index are ordered and linked to one another, a portion of the index need only be scanned once. The set of rows from the table are returned that are referenced by one or more entries whose column values are nearest to the target value.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08452757&OS=08452757&RS=08452757
owner: Oracle International Corporation
number: 08452757
owner_city: Redwood Shores
owner_country: US
publication_date: 20060324
---
The present invention relates to query execution and more particularly to executing a query for determining a nearest match.

The approaches described in this section are approaches that could be pursued but not necessarily approaches that have been previously conceived or pursued. Therefore unless otherwise indicated it should not be assumed that any of the approaches described in this section qualify as prior art merely by virtue of their inclusion in this section.

Relational databases store information in tables that are organized into rows and columns. In non relational terminology a row is a record and a column is a field. A user retrieves information from the tables by entering a request that is converted to queries by a database application which then submits the queries to a database server. In response to the queries the database server accesses the tables specified by the query to determine which information within the tables satisfies the queries. The information that satisfies the queries is then retrieved by the database server and transmitted to the database application and ultimately to the user.

For any given database application the queries to retrieve information from a table must conform to the rules of a particular query language. Most query languages provide users with a variety of ways to specify the information to be retrieved. For example in the Structured Query Language SQL the query select A from T where A

In order to process the exemplary query a full table scan may be implemented that reads all the rows from table . Thus the full table scan reads the data for all the columns in table even though only the information from column A was necessary to process the query. If the amount of the rows in a table and or the data for the columns not used in the query is very large then the full table scan methodology becomes very inefficient because of the unnecessary amount of disk input output.

Accordingly many database systems provide indexes to increase the speed of the data retrieval process. An index is a body of entries ordered by key values of a key. An index key may be for example a column of a table. Such a key is referred to herein as a key column. Each index entry identifies a record e.g. row .

One implementation of a database index is a B tree whose logical layout is illustrated in . A B tree index is a hierarchical arrangement of two types of nodes leaf nodes and branch nodes. Leaf nodes reside at the lowest level of the B tree hierarchy and contain values from the actual column or columns upon which the index is built and the rowid of the corresponding rows. Leaf nodes may comprise multiple entries that contain data for many rows e.g. 100 entries corresponding to 100 rows but for purposes of example leaf nodes are illustrated as containing a single entry. For example B tree index being built upon column A of table has leaf nodes collectively holding the values of column A . Specifically leaf node holds the index value 1 from column A and the rowid which identifies row of table . As another example leaf node contains an index value of 8 from column A and a rowid of 123 identifying row of table . Each leaf node contains a pointer or other link to a previous and subsequent leaf node if such a leaf node exists. For example leaf node which contains an index value of 7 points to leaf node which contains an index value of 8 and to leaf node which contains an index value of 6.

The non leaf nodes of a B tree index are branch nodes. Branch nodes contain information that indicate a range of values. In the illustrated B tree index nodes and are branch nodes and therefore each corresponds to a range of values. The range of values indicated by each branch node is such that all nodes that reside below a given branch node correspond to the values that fall within the range of values for the given branch node. For example node is a branch node that corresponds to the numerical range from 4 to 6. Consequently nodes and which all reside below node in the hierarchy correspond to values that fall within the range from 4 to 6.

A database server can perform an index range scan on B tree index to process the exemplary query select A from T where A

However there are many instances where a user does not know a priori the distribution of data of a particular column in a particular table. Because the distribution of data determines the range the user therefore does not know what range to include in a query of the database. The user may have an idea of a particular value to search for but most likely the user will not know if the applicable table contains that particular value.

For example a user may want to determine which employees have a salary nearest to a target value of 50 000 but the user is unaware of the data distribution i.e. unaware of whether or how many employees have salaries relatively near 50 000 . In that case a range scan is not efficient because the user may only desire the single nearest match i.e. one row from an employee information table . More importantly a range scan may not return the closest match since the closest match may be outside of the range provided by the user. For instance if the user submitted a query indicating rows in the employee information table that have salary values greater than 45 000 the nearest match to 50 000 may be outside that range such as 44 900.

The above approach suffers from two significant problems usability and performance. First the three step process is cumbersome. Second because two queries are being executed the index is accessed twice. Thus there is a need to provide a more efficient mechanism for retrieving a row in a table with a value nearest a target value.

In the following description for the purposes of explanation numerous specific details are set forth in order to provide a thorough understanding of the present invention. It will be apparent however that the present invention may be practiced without these specific details. In other instances well known structures and devices are shown in block diagram form in order to avoid unnecessarily obscuring the present invention.

A new operator is defined that instructs a query engine e.g. query engine of a database server to find one or more rows in a table whose values in a search column are nearest to a target value wherein the search column and target value are parameters to the new operator. An operator is a command that conforms to a computer language such as SQL or proprietary forms thereof and that identifies a particular function that is performed by a query engine when a query that includes the operator is submitted to the query engine. The new operator defined herein has at least the two operands or parameters mentioned above. An index whose key is based at least in part on the search column only has to be traversed once in order to reach the leaf nodes of the index. The entries of a leaf node and entries in other leaf nodes referenced by the leaf node if necessary are accessed to determine one or more rows whose key values corresponding to the search column are nearest to the target value. The query statement may also specify a number of rows m to return wherein each of the rows are the m nearest rows e.g. in terms of absolute difference to the target value.

According to one embodiment the new operator hereinafter referred to as the NEAREST TO operator has at least two parameters one parameter for a column reference and one parameter for a target value. The column reference specifies a search column from which a value nearest to the target value is retrieved. The target value may be of any data type including a number e.g. integer float a date e.g. dd mm yyyy yyyy mm and a string e.g. ASCII or Unicode .

For example a query to find the employee identifier of the employee with a salary nearest 50 000 may be the following 

where EmpID and Salary are columns in an employee table entitled Emp Salary is the search column in the NEAREST TO operator and 50000 is the target value.

According to an embodiment the search column is a key or a leading prefix of a composite key of an index. A composite key is an index key that consists of two or more columns. A given table may have multiple keys and may be associated with multiple indexes. An index upon which a composite key is built is ordered first by the first column i.e. the leading prefix of key and then by the second column and so forth until the last column of the composite key. If the search column is not an index key nor the leading prefix of a composite key then a full table scan is required. For example if Salary is neither the primary key nor the leading prefix of a composite key of any index on the Emp table referenced above then the NEAREST TO operator would have to perform a full table scan of the Emp table comparing each Salary column of each row to the target value.

The index is traversed to find one or more entries that are nearest to the target value. From the traversal through the branch nodes to the first leaf node step it is determined whether the first entry in the first leaf node contains a key value equal to the target value step . If so the row referenced by the first entry is returned step e.g. by using the rowid contained in the first entry. The following entries in the first leaf and if necessary entries in leaf nodes linked to by the first leaf node are examined in order to determine whether an entry contains a key value equal to the target value step . In one embodiment step is not performed and only the first row referenced by the first entry is returned indicating that the user only desires to see information pertaining to one employee. In that case the process ends after step .

If the next entry whether it is an entry in the first leaf node or an entry in a leaf node linked to by the first leaf node contains a key value equal to the target value then the row referenced by the next entry is returned step . This process continues until an entry is examined that contains a key value that is not equal to the target value.

If at step the first entry in the first leaf node does not contain a key value equal to the target value then according to many implementations of a B tree index that indicates that the key value of the first entry is less than the target value because many implementations order the key values in branch nodes and leaf node entries from smallest key value to largest key value. In these implementations the first entry in a leaf node does not contain a key value greater than the target value. This is so because branch nodes of a B tree index indicate a range of key values. The target value will always fall within a range of key values in an applicable branch node. If the target value falls within a particular range of key values of a branch node then a lower branch node pointed to by an entry in the particular branch node with the lower key value in the particular range is accessed. Thus the target value will never be outside the range i.e. less than or greater than any key value corresponding to the range .

According to other implementations the ordering is from largest key value to smallest key value i.e. descending order . The following description is based on an ascending ordering but embodiments are not limited to an ascending ordering.

A current value variable may be used to keep track of which entry contains a key value nearest to the target value. At step the current value variable is set to the key value contained in the first entry. Next it is determined whether the next entry whether it is an entry in the first leaf node or an entry in a leaf node linked to by the first leaf node contains a key value farther from the target value than the value indicated by the current value variable step . If so then because key values in subsequent entries are larger than the key value contained in the next entry and thus will only be farther away from the target value the row referenced by the current entry e.g. the first entry if this is the first iteration of step is returned step . If not then it is determined whether the next entry contains a key value nearer to the target value than the current value step .

If it is determined that the next entry of step contains a key value nearer to the target value than current value then at step current value is set to the key value contained in the entry after the next entry entry of step steps and . Thus next entry in subsequent iterations of step refers to the entry after the entry referred to as next entry in the immediately previous iteration of step .

If at step it is determined that the next entry of step contains a key value nearer to the target value than current value then the entry after next entry of step is examined.

In one embodiment all rows referenced by entries that fail the condition of step and are not succeeded by step are also returned. The following example illustrates such a case.

As an example of the above process given table suppose a user wanted to find the row or rows whose column A value is nearest to 5 in table of step . The statement may be the following 

Because the column A is the key of B tree index the B tree index is accessed step . B tree index is traversed step first by examining branch node followed by branch node until leaf node is reached. Because leaf node contains a key value i.e. 4 not equal to the target value i.e. 5 step and because each leaf node in B tree index contains only one entry leaf nodes to the right of leaf node indicating equal or higher key values are examined. Leaf nodes to the left of leaf node need not be examined to determine whether they also contain key values equal to the key value of the leaf node . This is so because as described above the target value must fall within the range indicated by branch node . Thus leaf nodes that fall outside the range indicated by branch node cannot include entries that contain key values nearest to the target value.

In step the current value variable is set to the key value contained in the first entry 4 . Next it is determined whether the next entry entry in leaf node contains a key value numerically farther from the target value than the value indicated by the current value variable step . Because 4 is not farther from 5 than 4 it is determined whether the next entry of step contains a key value numerically nearer to the target value than current value step . Because 4 is not numerically nearer to 5 than 4 the entry of leaf node is next examined.

The entry in leaf node contains a 6 as a key value which is not farther away from 5 than 4 second iteration of step nor is 6 nearer to 5 than 4 step . The entry of leaf node is next examined.

The entry of leaf node contains a 7 as a key value which is farther away from 5 than 4 third iteration of step . Therefore logic proceeds to step where the row referenced by the current entry i.e. entry corresponding to leaf node is returned. Also because entries corresponding to leaf nodes and failed the condition of step and were not succeeded by step the rows referenced by those entries may also be returned. Thus rows and from table corresponding to rowids and are returned.

According to one embodiment not only is the row or rows from a table with key values nearest to the target value returned but also a set of multiple rows all of which contain key values nearer to the target value than all other remaining rows in the table. For example the NEAREST TO operator may have a third parameter that indicates a number of rows with a key value nearest to the target value. A statement for returning the ten employee identifiers of employees with salaries nearest 50 000 may be the following 

Here ten rows corresponding to ten employees will be returned. As opposed to the previous example where entries in the leaf nodes were examined from left to right indicated an ascending order entries that contain key values less than the key value of the first entry of the first examined leaf node may be examined. Thus links from the first leaf node to leaf nodes to the logical left may be followed.

At step a returned of rows variable is set to zero. While returned of rows is less than the target number of rows specified in the query statement step the process continues to step . At step it is determined whether the value of the entry pointed to by the left cursor is nearer to the target value than the value of the entry pointed to by the right cursor.

If so the row referenced by the row pointed to by the left cursor is returned step . The left cursor is moved to point to the entry to the immediate left of the entry currently pointed to by the left cursor step . The return of rows variable is incremented by one step and the process continues back to step .

If the value of the entry pointed to by the left cursor is not nearer to the target value than the value of the entry pointed to by the right cursor step then the row referenced by the right cursor is returned step and the right cursor is moved to point to the entry to the immediate right of the entry currently pointed to by the left cursor step .

The search column again is A the target value is 4 and the number of rows to return is 4. B tree index which has a key of column A is selected to be examined step . As part of step branch node is examined. It is determined that the target value of 4 is within the range of 4 and 7 thus branch node is also examined. It is determined that the target value is within the range of 4 and 5 thus leaf node is examined.

In this example the left cursor will begin pointing at leaf node step and the right cursor will begin pointing at leaf node step . A returned of rows variable is set to zero step . Because returned of rows is less than four step the process continues to step .

The key value 4 of the entry pointed to by the left cursor is compared to the key value 4 of the entry pointed to by the right cursor. Because 4 is not nearer to the target value than 4 step the row referenced by the entry of leaf node i.e. rowid is returned step . The right cursor is moved to point to leaf node step . The returned of rows is incremented by one from zero to equal one step . Because one is less than four step the process continues to step .

The key value 4 of the entry pointed to by the left cursor is compared to the key value 6 of the entry pointed to by the right cursor. Because 4 is nearer to the target value than 6 step the row referenced by the entry of leaf node i.e. rowid is returned step . The left cursor is moved to point to leaf node step . The returned of rows is incremented by one to equal two step . Because two is less than four step the process continues to step .

The key value 3 of the entry pointed to by the left cursor is compared to the key value 6 of the entry pointed to by the right cursor. Because 3 is nearer to the target value than 6 step the row referenced by the entry of leaf node i.e. rowid is returned step . The left cursor is moved to point to leaf node step . The returned of rows is incremented by one to equal three step . Because three is less than four step the process continues to step .

The key value 3 of the entry pointed to by the left cursor is compared to the key value 6 of the entry pointed to by the right cursor. Because 3 is nearer to the target value than 6 step the row referenced by the entry of leaf node i.e. rowid is returned step . The left cursor is moved to point to leaf node step . The returned of rows is incremented by one to equal four step . Because four is not less than four step the process does not continue to step . The process of determining which entries are the four nearest entries in terms of key value to the target value is thus complete.

According to one embodiment the result set returned from the above statement is ordered by a distance function. One type of distance function is an absolute difference function where the result set is ordered by the absolute difference between the target value and the applicable key value of a particular row in the result set. For example suppose a query statement against B tree index is the following 

Because rows identified by leaf nodes contain key values that are the five nearest in terms of absolute difference to the target value 6 the result set may be the following 

According to one embodiment the NEAREST TO operator has other parameters that may limit the result ret. Another parameter may be one that indicates an absolute difference from the target value in which the applicable key value from each returned row must not exceed. For example the following statement 

indicates a desire by the user to see the ten employees whose salary is nearest to 50 000 but if any of the ten employees have salaries where the absolute difference with 50 000 is greater than 1 000 then the rows corresponding to those employees are not returned. Thus a maximum of ten employees based on the statement may be returned.

Computer system may be coupled via bus to a display such as a cathode ray tube CRT for displaying information to a computer user. An input device including alphanumeric and other keys is coupled to bus for communicating information and command selections to processor . Another type of user input device is cursor control such as a mouse a trackball or cursor direction keys for communicating direction information and command selections to processor and for controlling cursor movement on display . This input device typically has two degrees of freedom in two axes a first axis e.g. x and a second axis e.g. y that allows the device to specify positions in a plane.

The invention is related to the use of computer system for implementing the techniques described herein. According to one embodiment of the invention those techniques are performed by computer system in response to processor executing one or more sequences of one or more instructions contained in main memory . Such instructions may be read into main memory from another machine readable medium such as storage device . Execution of the sequences of instructions contained in main memory causes processor to perform the process steps described herein. In alternative embodiments hard wired circuitry may be used in place of or in combination with software instructions to implement the invention. Thus embodiments of the invention are not limited to any specific combination of hardware circuitry and software.

The term machine readable medium as used herein refers to any medium that participates in providing data that causes a machine to operation in a specific fashion. In an embodiment implemented using computer system various machine readable media are involved for example in providing instructions to processor for execution. Such a medium may take many forms including but not limited to non volatile media volatile media and transmission media. Non volatile media includes for example optical or magnetic disks such as storage device . Volatile media includes dynamic memory such as main memory . Transmission media includes coaxial cables copper wire and fiber optics including the wires that comprise bus . Transmission media can also take the form of acoustic or light waves such as those generated during radio wave and infra red data communications.

Common forms of machine readable media include for example a floppy disk a flexible disk hard disk magnetic tape or any other magnetic medium a CD ROM any other optical medium punchcards papertape any other physical medium with patterns of holes a RAM a PROM and EPROM a FLASH EPROM any other memory chip or cartridge a carrier wave as described hereinafter or any other medium from which a computer can read.

Various forms of machine readable media may be involved in carrying one or more sequences of one or more instructions to processor for execution. For example the instructions may initially be carried on a magnetic disk of a remote computer. The remote computer can load the instructions into its dynamic memory and send the instructions over a telephone line using a modem. A modem local to computer system can receive the data on the telephone line and use an infra red transmitter to convert the data to an infra red signal. An infra red detector can receive the data carried in the infra red signal and appropriate circuitry can place the data on bus . Bus carries the data to main memory from which processor retrieves and executes the instructions. The instructions received by main memory may optionally be stored on storage device either before or after execution by processor .

Computer system also includes a communication interface coupled to bus . Communication interface provides a two way data communication coupling to a network link that is connected to a local network . For example communication interface may be an integrated services digital network ISDN card or a modem to provide a data communication connection to a corresponding type of telephone line. As another example communication interface may be a local area network LAN card to provide a data communication connection to a compatible LAN. Wireless links may also be implemented. In any such implementation communication interface sends and receives electrical electromagnetic or optical signals that carry digital data streams representing various types of information.

Network link typically provides data communication through one or more networks to other data devices. For example network link may provide a connection through local network to a host computer or to data equipment operated by an Internet Service Provider ISP . ISP in turn provides data communication services through the world wide packet data communication network now commonly referred to as the Internet . Local network and Internet both use electrical electromagnetic or optical signals that carry digital data streams. The signals through the various networks and the signals on network link and through communication interface which carry the digital data to and from computer system are exemplary forms of carrier waves transporting the information.

Computer system can send messages and receive data including program code through the network s network link and communication interface . In the Internet example a server might transmit a requested code for an application program through Internet ISP local network and communication interface .

The received code may be executed by processor as it is received and or stored in storage device or other non volatile storage for later execution. In this manner computer system may obtain application code in the form of a carrier wave.

In the foregoing specification embodiments of the invention have been described with reference to numerous specific details that may vary from implementation to implementation. Thus the sole and exclusive indicator of what is the invention and is intended by the applicants to be the invention is the set of claims that issue from this application in the specific form in which such claims issue including any subsequent correction. Any definitions expressly set forth herein for terms contained in such claims shall govern the meaning of such terms as used in the claims. Hence no limitation element property feature advantage or attribute that is not expressly recited in a claim should limit the scope of such claim in any way. The specification and drawings are accordingly to be regarded in an illustrative rather than a restrictive sense.

