---

title: Image processing device and method of controlling the image processing device which estimates a state-transition sequence for a USB driver
abstract: An object of the invention is to provide an image processing device having a sub-system performing a power saving control to support the use of a USB device or provided to allow the supporting of the use of a USB device, in which operational mismatching which may occur at a start of a the power saving mode between the USB device and a USB device driver provided in the main system of the image processing device can be effectively suppressed. A state of the USB device driver before the mode of the image processing device is changed to the power saving mode is held, and, when the state of the USB device acquired after the mode of the image processing device returns from the power saving mode differs from the held state of the USB device driver, an estimated state-transition sequence for changing a state of the USB device driver is determined by an ACPI driver based on a result of comparison of the held state of the USB device driver and the acquired state of the USB device, thereby changing the state of the USB device driver according to the estimated state-transition sequence.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07765413&OS=07765413&RS=07765413
owner: Ricoh Company, Ltd.
number: 07765413
owner_city: Tokyo
owner_country: JP
publication_date: 20060726
---
This invention relates to an image processing device including an image input unit and an image processing unit which processes an input image data to generate an output image data or image data being outputted to a printer or an external device such as a printer a facsimile and a multi function peripheral having multiple functions including copier printer scanner and facsimile functions which are connectable to a network. More particularly this invention relates to an image processing device which is provided to have a power saving mode in which the image processing device is set in a power saving state.

A MFP multi function peripheral which has multiple functions including copier printer scanner and facsimile functions is widely used as an image processing device which performs image processing to process an input image data into an output image data. The MFP is connected to a network receives input image data of paper documents through the scanner of the MFP and receives other image data document from an external device via the communication I F interface of the MFP. After the inputted images are processed through the image processing to generate output image data the output images are printed out by the plotter of the MFP or the output image data are outputted to the external device connected with the MFP.

Conventionally the image processing device of the above type is provided with a power saving mode in order to reduce the power consumption of the device. When an idle state of the image processing device is detected the normal operating mode of the image processing device is changed to the power saving mode. And the image processing device returns from the power saving mode to the normal operating mode when a predetermined return condition is detected.

A control system of an image processing device which includes a sub system which operates in the power saving mode in order to realize the power saving function is known from the patent document 1 for example. This sub system manages the power supply of a main system which controls the whole image processing device during a normal operation and carries out operation of the power saving mode. That is in the power saving state the sub system turns off the CPU power supply of the main system performs the network response and the monitoring of the relevant units and when returning from the power saving state returns the main system to the normal operating mode again. This enables reduction of large power consumption for systems having a large CPU supply power.

In the control system of the patent document 1 an ASIC with a built in programmable sequencer which constitutes the sub system controls the sequences of the change to the power saving mode and the return from the power saving mode. For example the return from the power saving mode is initiated when pressing of the operation panel switch or opening of the device cover is performed as a return trigger.

In the control system of the patent document 1 reception of a signal transmitted via the network interface I F from an external device is disclosed an example of the return conditions from the power saving mode. However there is no disclosure in the patent document 1 of a USB universal serial bus interface which has recently been a general purpose I F for connecting peripheral devices to the image processing device of this kind MFP .

When a USB device which is an external device connected by the USB interface is attached to the image processing device of this kind MFP and the power supply to the attached USB device is turned on even in the power saving mode operational mismatching may occur at the start of the power saving mode between the USB device and the USB device driver provided in the main system whose power supply is turned OFF in the power saving mode. The problem of the mismatching remains unsolved by the conventional technology.

The reason why the above mentioned mismatching occurs is that when a change of the USB device itself or a change of the device state is effected by attaching or detaching of the USB device in the power saving mode the main system whose power supply is turned off in the power saving mode cannot recognize the change.

This invention is made in view of the above mentioned problems and an object of the invention is to provide an improved image processing device having a sub system performing a power saving control to support the use of a USB device or provided to allow the supporting of the use of a USB device in which mismatching which may occur at a start of the power saving mode between the USB device and the USB device driver provided in the main system of the image processing device can be effectively suppressed.

In an embodiment of the invention which solves or reduces one or more of the above mentioned problems there is provided an image processing device including a main control unit and a sub control unit the main control unit controlling each of an image input unit an image processing unit and an image output unit the sub control unit controlling power supply to the main control unit to change a mode of the image processing device to a the power saving mode and to cause the mode of the image processing device to return from the power saving mode and the sub control unit controlling response and transmission of a network interface and a USB device provided in the image processing device for inputting or outputting of image data the image processing device comprising a state holding unit holding a state of a USB device driver provided in the main control unit a state transition unit changing a state of the USB device driver and a state acquiring unit acquiring a state of the USB device wherein the state holding unit holds a state of the USB device driver before the mode of the image processing device is changed to the power saving mode and when the state of the USB device acquired by the state acquiring unit after the mode of the image processing device returns from the power saving mode differs from the held state of the USB device driver held by the state holding unit the state transition unit determines an estimated state transition sequence for changing a state of the USB device driver based on a result of comparison of the held state of the USB device driver and the acquired state of the USB device thereby changing the state of the USB device driver according to the estimated state transition sequence.

The above mentioned image processing device may be configured so that the state transition unit is provided to determine when the acquired state of the USB device is nearer to a communication permitted state than the held state of the USB device driver an estimated state transition sequence which indicates a state transition from the held state of the USB device driver to the acquired state of the USB device.

The above mentioned image processing device may be configured so that the state transition unit is provided to determine when the held state of the USB device driver is nearer to a communication permitted state than the acquired state of the USB device an estimated state transition sequence which indicates a state transition from an initial state to the acquired state of the USB device.

The above mentioned image processing device may be configured so that the image processing device is provided to stop performing direct memory access DMA for transferring data of the USB device when changing to the power saving mode and start when returning from the power saving mode performing the direct memory access DMA according to a state of the USB device driver after an end of the state transition.

The above mentioned image processing device may be configured so that the sub control unit is provided to cause the mode of the image processing device to return from the power saving mode when receiving of data input from the USB device is detected.

The above mentioned image processing device may be configured so that the sub control unit is provided to cause the mode of the image processing device to return from the power saving mode when hot swapping of the USB device is detected.

In an embodiment of the invention which solves or reduces one or more of the above mentioned problems there is provided a method of controlling an image processing device including a main control unit and a sub control unit the main control unit controlling each of an image input unit an image processing unit and an image output unit the sub control unit controlling power supply to the main control unit to change a mode of the image processing device to a the power saving mode and to cause the mode of the image processing device to return from the power saving mode and the sub control unit controlling response and transmission of a network interface and a USB device provided in the image processing device for inputting or outputting of image data the method comprising a state holding step of holding a state of a USB device driver provided in the main control unit a state transition step of changing a state of the USB device driver and a state acquiring step of acquiring a state of the USB device wherein a state of the USB device driver before the mode of the image processing device is changed to the power saving mode is held in the state holding step and when the state of the USB device acquired in the state acquiring step after the mode of the image processing device returns from the power saving mode differs from the held state of the USB device driver held in the state holding step an estimated state transition sequence for changing a state of the USB device driver is determined in the state transition step based on a result of comparison of the held state of the USB device driver and the acquired state of the USB device thereby changing the state of the USB device driver according to the estimated state transition sequence.

The above mentioned method of controlling the image processing device may be configured so that the state transition step is provided to determine when the acquired state of the USB device is nearer to a communication permitted state than the held state of the USB device driver an estimated state transition sequence which indicates a state transition from the held state of the USB device driver to the acquired state of the USB device.

The above mentioned method of controlling the image processing device may be configured so that the state transition step is provided to determine when the held state of the USB device driver is nearer to a communication permitted state than the acquired state of the USB device an estimated state transition sequence which indicates a state transition from an initial state to the acquired state of the USB device.

The above mentioned method of controlling the image processing device may be configured so that the image processing device is provided to stop performing direct memory access DMA for transferring data of the USB device when changing to the power saving mode and start when returning from the power saving mode performing the direct memory access DMA according to a state of the USB device driver after an end of the state transition.

The above mentioned method of controlling the image processing device may be configured so that the mode of the image processing device is caused to return from the power saving mode when receiving of data input from the USB device is detected.

The above mentioned method of controlling the image processing device may be configured so that the mode of the image processing device is caused to return from the power saving mode when hot swapping of the USB device is detected.

According to the embodiments of the image processing device and the controlling method of the invention the operation of returning from the power saving mode of the main control system is performed by detection of the data input from a USB device or detection of hot swapping of a USB device. In the image processing device to which the USB device is connected without causing mismatching between the state of the USB driver and the state of the USB device it is possible to make the mode of the main control system to change to the power saving mode and return from the power saving mode according to the return conditions and it is possible to improve the performance of the image processing device.

In addition the mismatching which may occur between the state of the USB device connected and the state of the USB device driver provided in the main control system is suppressed by the operation performed at the time of the power saving mode and the operational problem which may occur at the time of returning from the power saving mode can be avoided and proper operation can be ensured.

A description will now be given of an embodiment of the invention with reference to the accompanying drawings.

First a description will be given of an embodiment of the image processing device of the invention which is applied to an MFP multi function peripheral which has multiple functions including copier facsimile printer and scanner functions.

The basic composition of a control system in the MFP of this embodiment will be explained. This control system has the composition for realizing a power saving function which performs operations of changing to the power saving mode and returning from the power saving mode besides the multiple image processing functions of the MFP. The control system is configured so that it includes a main control system and a sub control system which controls operation of the power saving mode.

The main control system controls each of an image input unit which inputs an image from the scanner provided in the image input unit or the connected external device an image processing unit processing the input image to generate output image data and an image output unit outputting the image data. The sub control system controls the power supply to the main control system to change the mode of the image processing device to the power saving mode and cause the mode of the image processing device to return from the power saving mode. The sub control system controls response transmission of a network interface and a USB device provided for inputting or outputting of image data.

Next operation of the control system the hardware composition of which is shown in will be explained. In the following the operation is divided into each operation of 1 initialization 2 changing to the power saving mode and 3 returning from the power saving mode and a description of each operation will be given.

If the power supply is switched on each function is initialized by CPU initialization of the controller is performed and engine is set in a waiting state until it receives a processing request command. The flow of this initialization is carried out when changing the device to the normal operating state.

The initialization of the controller is based on the following steps. Pressing the power supply switch causes a reset signal to be inputted to ASIC . The ASIC which receives this input signal sends a reset signal to the power supply unit not shown so that electric power supply to a set of divided power supply groups is turned on in a given sequence.

As a result the reset signals sent from the power supply groups are distributed to the necessary devices. In the CPU the reset signal is asserted and negated and the CPU will fetch the command of a reset vector and sends the fetch signal the ASIC . The ASIC decodes the address when the fetch signal is received and asserts the CS signal of ROM in which the initializing program is stored so that the contents the instruction codes data at the address of the ROM requested by the CPU are read out and supplied to the CPU .

The CPU repeatedly requests the ASIC to read out the instructions and the ASIC passes the instruction codes data from the ROM to the CPU according to the relevant address. Thus the CPU can execute the initializing program.

The ASIC has the built in mechanism which enables reading out of instruction codes data directly from an SD card in the SD instead of the ROM . In the SD card a program is stored in the format that is the same as the program stored in the ROM . Generally an SD card is managed by a sector number but it can be accessed by converting the fetch request address from the CPU into a sector number and an offset address in the sector in a manner similar to that of the ROM.

By the read initializing program initialization of the CPU initialization of the memory which is connected to the ASIC and the ASIC initialization of two PCI buses from the ASIC initialization of the engine initialization of the operation panel initialization of the HDD and initialization of the network I F are carried out. And if needed the SLOT groups are initialized and then the application programs are started.

The access time of the ROM of the ASIC is dependent on the data bus width and in order to reduce the number of external terminals of ASIC as small as possible and in many cases the number of external terminals is set to be smaller than the width of the data bus of the CPU such as 16 bits 8 bits etc. If a 4 bit or 1 bit serial device SEEPROM SD card or a memory stick is used in some case the access time will become late.

In order to reduce terminals for exclusive use it is possible to connect the ROM the ROM and the NVRAM through the exterior LOGIC to the signals of the PCI sharing the terminals of the PCI bus. In this case it is possible to access the ROM the ROM or the NVRAM exclusively with the access to the PCI bus.

In the composition of this embodiment the ASIC performs with the host I F the return the control of the power supply and the operation of returning from the power saving mode while the ASIC performs the control of the CPU the MEM the HDD and the SD with the two PCI buses.

The optional composition of the two PCI buses of the ASIC can be assigned for setting of REQ GNT and this increases the flexibility of the system configuration. One of the two PCI buses is for exclusive use for connection with the engine and the other is for exclusive use for connection with the ASIC . The PCI bus to which the ASIC is connected can be operated at 66 MHz and it is specializing in order to connect the host I F. The option slots and are provided so that they may be connected with only the PCI bus connected with the engine at the time of 66 MHz operation.

Similarly interrupt signals can also be assigned one for the engine one for the ASIC and the remaining three signals for either of the PCI buses.

The CPU MIPS system reads out the boot configuration data in each ASIC. Fetch of the command is started after reset release. It is determined whether the initiation is cold reset or other. And initialization of the access timing of the local bus in each ASIC initialization of the cache in the CPU initialization of TLB and setup of exception vector and initialization of the coprocessor are performed.

It is checked whether the option memory exists before determining the parameters concerning the timing of the normally implemented memory also called standard memory . If the option memory exists the SEEPROM in which the information on the option memory is stored is accessed and the capacity of the memory the speed and the composition are read out. The standard memory timing is compared with the option memory timing and the slower timing is selected and it is set to the ASIC and initialization of the MEM is performed. Then setting of the interrupt vector table and setting of the initial value to the data area are performed.

The configuration register in the internal registers of each ASIC is used and all the devices existing on the PCI bus are searched. The type of each device is determined and if there is a bus bridge the devices on the following bus at the point will be searched. If listing of all the devices is completed mapping of the address space of the PCI is performed. The mapping is performed by setting the start address of the memory under ASIC management to as 0x0000.0000 making it 0x0000.0000 is not necessarily needed . The mapping of other devices is performed in the PCI memory space access window provided in the register space of the ASIC or the PCI I O space access window. If the mapping is completed the value 1 is set to the memory enabling bit the I O enabling bit and the bus master enabling bit of the command register of each device so that each device is set in the operable state. Since two PCI buses exist in the ASIC both the PCI buses are initialized similarly.

Communication between the engine and the controller is performed via the transmission buffer and the receive buffer provided in the engine side PCI device.

The operation panel and the ASIC are connected together via the operation panel I F and transmission and reception are performed in full duplex. A packet telecommunication is performed with a predetermined packet size and it is displayed on the operation panel to indicate that the system is initializing.

It is checked whether the HDD is connected and when the HDD is connected the information on the HDD is read out and management information is stored in the memory in order to use it later.

As mentioned above the portions depending on the CPU or each ASIC are absorbed in the device driver layer see the composition of the general purpose OS layer in below and this makes it easy to install a different CPU and a different ASIC therein.

The ASIC which constitutes the sub control system ASIC for I O as in the embodiment of has the CPU . That is by providing the CPU therein flexibility is given to the control system and the functions which suit the sub control system which manages the control power supply at the time of the power saving mode can be easily realized. On the other hand it is also possible to configure the sub control system by a hardware configuration.

Also in the composition of in which no CPU is provided the function of the ASIC for I O is the same as that of the composition of in which the CPU is provided and implementing this embodiment is possible. However since there are the problems such as increase of circuit size and less flexible system according to the composition without CPU only the illustration of this composition is given. And a detailed description of an embodiment of the sub control system which controls the power supply at the time of the power saving mode will be given below based on the composition with CPU .

When the initialization of various devices is completed the general purpose OS initiates the application programs based on the configuration information of the system. If the facsimile unit as an option is not provided the fax application is not initiated.

When the application programs are initiated the default operation screen of the copy application is displayed on the operation panel and the MFP is in a waiting state for receiving user instructions. The initial operation screen displayed at this time can be changed to a desired one of the application programs by setting it by the user.

Subsequently in response to the processing request instructions inputted by the user on the operation panel the normal processing is performed using the relevant ones of various kinds of the application programs. Usually if a predetermined mode change condition is met in the normal processing mode the mode of the MFP is changed to the power saving mode. Then if a predetermined return condition is met in the power saving mode the mode of the MFP is again returned to the normal operation mode.

As shown in after ON state of the main power supply the controller is set in an engine ready state through the initialization process which includes the initialization of CPU and the initialization of ASIC and ASIC as mentioned above. Through the initialization process including the initialization of CPU and each ASIC the engine communicates with the controller and notifies that the fixing unit not shown is warming up . The engine at this time tends to consume the electric power much more than the normal electric power to start the fixing unit as quickly as possible until the fixing unit is set at a constant temperature.

After the fixing unit is set at the target temperature the control is changed so that the temperature of the fixing unit is kept constant using the normal electric power. After the engine is set in the ready state the copy operation is started in response to the instructions of the user. The fixed electric power is consumed during the copy operation .

Simultaneously with the completion of the copy operation the MFP is set in the copy possible state . If the user does not access the MFP in this state for the fixed time the timeout of the watchdog timer for changing to the power saving mode occurs and the mode of the MFP is changed to the power saving mode . In the power saving mode the power supply to the MFP is turned off except for the portion having the monitoring function to check if the return condition is met so that the power dissipation is reduced to the low level.

A return trigger is sent out when the user performs pressing of the return key for returning from the power saving mode setting of a document onto the ADF automatic document feeder in order to perform a copy operation or lifting of the ADF to remove the ADF for starting the pressure plate reading or when the return instruction is received from the network. Then the return operation is started.

In the return operation the engine tends to consume the electric power much more than the normal electric power in order to raise the temperature of the fixing unit as quickly as possible. In the return operation the CPU is set in the state waiting for the engine ready through the initialization process including the initialization of each ASIC. Through the initialization process including the initialization of CPU and each ASIC the engine communicates with the controller and notifies that the fixing unit not shown is warming up and set under the return operation . The engine at this time tends to consume the electric power more than the normal electric power in order to start the fixing unit as quickly as possible until the fixing unit is set at the constant temperature.

After the fixing unit is set at the target temperature the control is changed and the temperature of the fixing unit is kept constant by using the normal electric power. After the engine is set in this ready state the copy operation is started in response to the instructions of the user . The fixed electric power is consumed during the copy operation . Simultaneously with the completion of the copy operation the MFP is set in the copy possible state . If the user does not access the MFP for the fixed time the timeout of the watchdog timer for changing to the power saving mode occurs. And the mode of the MFP is changed to the power saving mode .

In the state transition mentioned above the initialization process of the controller is usually performed at the time of starting from the main power supply ON to the normal processing state and at the time of returning from the power saving mode to the normal processing state. A description will be given later of the initialization processing which is performed at this time.

The starting time of the application programs and the general purpose OS of the controller depends on the access time of the program ROM in this example the ROM and the ROM are used . It is necessary to store the programs in the non compressed state in order to initiate the programs in the access time of the ROM. The amount of storage information of the non compressed programs is increased several times as large as that of the compressed programs and there is the problem that the cost becomes high.

It is desirable that both the time for starting from the main power supply ON and the time for returning from the power saving mode are very short. However there are various restrictions and actually the setting of the program ROM must be performed to have the conditioning which shortens the time for returning from the power saving mode more than the time for starting from the main power supply ON.

The program ROM is connected to the ASIC and in order to reduce the number of terminals of the ASIC the width of the data bus for accessing the program ROM is set to be smaller than the width of the data bus of the CPU .

Usually the command from the ROM is executed upon ON state of the main power supply and it is copied to the RAM in this example the memory is used in the midst of execution of the command. If the storage capacity of the RAM is enough all the programs of the ROM are copied to the RAM. If there is little storage capacity of the RAM the program portion which must surely be performed is copied at high speed to the RAM and it is performed. For this reason it takes too much time to copy the codes of the ROM to the RAM at the time of booting.

As shown in the boot processing is started with ON state of the power supply and ended with booting of the OS kernel. During the time of the boot processing each program of a monitor initialization step S a self diagnosis initialization step S a CPU test step S an ASIC memory test step S an engine interrupt test step S an operation panel initialization step S a KEY information receiving step S a diagnosis end process step S a PCI configuration step S and an OS kernel booting step S is performed.

Although the boot processing steps up to the OS kernel booting are explained loading of the drivers and loading of the application programs are needed after the OS kernel booting so that copying of the MFP and printing of the printer may be performed.

In the above boot processing the programs are not developed to the RAM. shows the boot processing in which the ROM wherein the compressed program is stored is accessed and the program is developed to the RAM at the time of booting. Although the boot processing shown in is essentially the same as that shown in an additional step of the OS kernel loading developing to RAM step S is provided between the PCI configuration step S and the OS kernel booting step S . Other steps than the step S are essentially the same as the corresponding steps in .

Therefore the time needed for the boot processing in this case is longer than that in the previous case by the time needed for the loading developing of the compressed program from the ROM to the RAM.

For this reason even in the case where the program is developed to the RAM at the time of booting by the ON state of the power switch the codes developed on the RAM remain in the stored condition when changing to the power saving mode which is called Suspend to RAM . If it is performed so the codes stored in the RAM are executed directly when returning from the power saving mode. The developing time can be saved the system can be started in a very short time and it is possible that the MFP having the copy and printer functions is set in copy possible and print possible state very speedily.

The ASIC which is the sub control system which manages the power supply control performs the control of returning from the power saving mode. shows the state of the control system in which the power supply is turned off in the power saving mode. As shown in the power supply to the half tone dotted portions is still ON active at the time of the power saving mode. Namely at the time of the power saving mode the power supply to other portions of the controller except the power supply control unit and the response monitoring unit to external inputs for example a user input operation and an input from the I F for connecting the external device is in OFF state.

Therefore the power supply control unit and the response monitoring unit to the external inputs the control units which must be provided in the ASIC see as the sub control system are maintained at the active state even in the power saving mode.

The ASIC which is also indicated as ASIC in shown in has the CPU provided therein and it is controlled by the software this software system will be mentioned as sub system . The sub system is realized by tasks on the built in OS such as iTron. The respective tasks carry out the control by communicating with each other by messages and communicating with the main system via the communication driver.

In addition each HISR high interrupt service routine of the above mentioned PM iFilter communication USB panel error interrupt and GIO is a routine which controls the hardware of the relevant task respectively.

An example of the operation of the power saving mode which is performed by the sub system having the above mentioned composition will be explained.

Each task is initialized after the sub system is started by the power on state of the whole MFP. Since the sub system is in the conduction active state even at the time of the power saving mode it operates continuously. Each task monitors the corresponding portion including the external peripheral device of the ASIC at the time of the power saving mode and when the monitored result satisfies the return conditions the MFP can return from the power saving state through the control of the PM power management .

For example the GIO which is the general purpose IO port is constituted as the hardware which may receive in the power saving state the detection signals such as key detection of the operation panel and detection of the pressure plate setting action in the scanner of the MFP. The GIO task detects changes of these lines in the power saving state and monitors changes of the state.

That is the state transition table shows that the task detects the event occurring in the sub system by receiving the message from each portion in this example it is mainly the message from the sub manager task which causes a state transition to occur and the task operates to transmit a message in connection with the state transition.

In the GIO task receives the message from the sub manager task and the MFP is set in the power saving mode. After that when interruption from the GIO port which is a return factor is detected in the power saving state the GIO task transmits a return factor detection message to the sub manager task .

Detection of the return factor during the power saving mode is performed not only by the GIO task but also by each task which supervises the USB response task the panel task the timer task the SW iFilter network task the error interruption task etc. The USB response task will be described later with reference to .

As shown in after the sub system is started it changes to the power saving mode through the normal operation in which the image input output processing is performed by the main control system. Then it is set in the state 4 during the power saving mode by control of the sub system. The return factor detection message the above mentioned message in sent from the GIO task is received in the state 4 . The sub manager task transmits the message of main return preparation request to each task in order to make the state change to the state 5 of main return. Then in the state 5 the message of main return execution request is transmitted. At this time the power management unit of the ASIC which is also indicated as ASIC in is operated by the PM power management task so that the ASIC which is also indicated as ASIC in which is the main control system is returned.

As shown in the PM power management task operates the registers the PM and the IREG in of the power management unit when the main return execution request is received so that a power saving return sequence is created. In this embodiment the hardware which receives the request from the main system performs the sequence of changing to the power saving mode.

In the state 4 during the power saving mode under the control of the sub system in the message of main return preparation request transmitted from the sub manager task is received. After it is set in the state 5 the main return execution request message refer to transmitted again is received so that the return processing of the main control system is performed by the PM power management task .

In the above embodiment the operation of the sub system has been described with the state transition of the related task by giving attention to the return operation from the power saving mode. In the following the main control system and the sub system are associated and the sequence of change return processing of the power saving mode will be explained.

In the change sequence of the respective steps are referred to as P P while in the return sequence of the respective steps are referred to as P P. The sequence of the processing steps is performed according to numerical order of the steps. In and the transmission and reception of messages performed between the respective parts correspond to the operations shown in the above mentioned state transition table of the sub manager the above mentioned state transition table of the GIO task and the above mentioned state transition table of the PM power management task .

The processing performed in each relevant part in the change sequence of includes the shift preparation processing P and the change execution operation P performed by each task in response to the request from the sub manager the change processing P performed by the main control system before requesting the sub manager to perform the change execution processing and the management processing P P P P performed by the sub manager using the timer.

The processing performed in each relevant part in the return sequence of includes the return factor detection P of each task the main return preparation processing P and the main return processing P performed by each task in response to the request from the sub manager the main starting processing P performed by the main control system according to the instructions from the PM task and the management processing P P P P performed by the sub manager using the timer.

In the above mentioned sequence the PM task is operated by the return factor detection by the GIO task so that the operation of returning from the power saving mode is performed. Similar to the GIO task the processing corresponding to each return factor can be performed by preparing the task which detects each hardware unit. In the following the return factor is detected by the panel task.

As shown in the panel task receives the message from the sub manager task . When the panel task is in the state under power saving return monitoring after the panel task is changed to the power saving mode interruption of key ON which is a return factor sent from the controller device of the operation panel is detected. The panel task at this time transmits the return factor detection message to the sub manager task .

This embodiment enables it to support the returning from the power saving mode by detection of the data input from a USB device peripheral device connected by USB . For this reason the USB response task is provided to detect the data input from the USB device as a return factor from the power saving mode.

Simultaneously return factor detection is started by the USB response task. When the data input from the USB device is detected as a return factor in the power saving mode of state 4 the USB response task transmits a return factor detection message to the sub manager task .

Similar to the other return factor detection mentioned above the sub manager task which receives the return factor detection message from the USB response task requests the PM power management task to perform the return processing of the main control system.

The USB under the control of the sub system which is formed by the ASIC or by the ASIC in connects the external peripheral device to the MFP as the general purpose I F and enables performing the plug and play operation. Therefore the USB is maintained in the active state conduction state even at the time of the power saving mode which allows the user to perform data input output using a USB device at any time without requiring special operation. Moreover the user can use various kinds of USB devices freely by the plug and play operation.

The above mentioned sub system is provided so that the operation of returning from the power saving mode of the main control system is performed by detection of the data input from a USB device. Similarly the sub system ASIC of the invention may be provided so that the operation of returning from the power saving mode of the main control system is performed by detection of hot swapping of a USB device.

That is when hot swapping of a USB device attaching or detaching of the USB cable is detected as a return factor in the power saving mode of state 4 the USB response task transmits a return factor detection message to the sub manager task . Similar to the other return factor detection mentioned above the sub manager task which receives the return factor detection message from the USB response task requests the PM power management task to perform the return processing of the main control system.

The MFP of this embodiment is provided with the main control system in which the mechanism for supporting the above mentioned use of the USB is implemented by the software composition.

The OS layer shown in manages the hardware resources and offers the interface to the upper layer. The ACPI driver is a driver provided for supporting the power saving mechanism of the hardware such as the CPU . The power saving state of the hardware is controlled by operation of this driver. It is feasible by implementing the functions equivalent to the ACPI realized by the IBM AT compatible architecture. Operation related to the USB driver will be explained later.

The USB driver manages the hardware of USB and offers the function to the process layer via the process I F . The network driver drives the network hardware and offers the network communication function independent of the hardware to the network protocol stack .

The main control system has the composition shown in in the OS layer which manages the hardware resources which enables the support of the power saving operation in which the power supply to the CPU in the main control system is turned OFF. That is in the power saving mode the CPU is in OFF state and the data on the RAM remain in the stored state and at the time of returning from the power saving mode the CPU works as if the control is returned the ACPI driver .

However the sub system formed by the ASIC or the ASIC in is always maintained in the active state conduction state and there is the possibility that the state of the hardware under control of the sub system is changed by the attaching or detaching of the USB device during the power saving mode.

In addition it may be necessary for a certain device that when changing to the power saving node the operation of changing to the power saving state is performed after the pre processing is performed. In the case of a USB driver when the state of USB is in a configured state transmission and reception of data to the end points such as bulk in out is made possible. However since receiving data in the power saving state is not desirable the DMA in the normal operation state is stopped. When receiving data is present at the bulk out port in the power saving mode NAK response is returned by the hardware. And after the operation of returning from the power saving state is performed the data receiving is performed.

When the above structure is provided the main control system USB driver conventionally cannot recognize change of the state of the USB device.

Since the USB driver cannot recognize change of the state of the USB device which may arise in the power saving mode there is a possibility that mismatching may arise between the state held by the main control system USB driver immediately before changing to the power saving mode and the state of the USB device which is changed during the power saving mode which may cause an error in operation after returning from the power saving mode.

To obviate the problem the USB device driver of this embodiment holds the state of the USB device at the time of changing to the power saving mode. After returning from the power saving mode the USB device driver compares the held state of the USB device at the time of changing to the power saving mode with the state of the hardware of the USB device actually loaded. If there is mismatching correction processing which makes a state transition of the USB device driver coincide with the actual state transition of the USB device is performed.

Even when power supply OFF ON of the device for example host PC connected by the USB or hot swapping of a USB cable is performed during the power saving mode the state transition of the USB device driver is thus corrected after returning from the power saving mode and performing the normal operation can be continued without error.

Suppose that a USB device which operates according to the state transition diagram of is in the state of Configured immediately before changing to the power saving mode and the state of the USB device is changed to the state of Powered after returning from the power saving mode. In this case there is no direct state transition and it is determined that detaching or attaching occurred during the power saving mode and the state of the USB device was returned to the state of Attached or Not Attached and then it was changed to the state of Powered . In this case there is also the possibility that detaching and attaching occurred repeatedly. Such operation may arise when the detection of hot swapping of the USB device is not the return factor from the power saving mode.

Although it is dependent on the structure of the USB device driver it can be estimated that the state of the USB device drive is returned according to the shortest state transition regardless of the actual state changes. Making the state of the USB device drive be returned according to the shortest state transition based on this assumption can suppress the mismatching between the state of the USB device driver and the state of the actual USB device if an estimated state transition sequence is created for the state of the USB device driver such that no conflict does not arise.

In this embodiment the following serial number is assigned for each state of a USB device as information indicating the specific state of the USB device 

In this regard since the state of Suspended is detected by the hardware only this state is disregarded by the software as not being relevant to the state change or return.

Bearing in mind the assignment of the above serial number for the USB device state suppose that x denotes the serial number indicating the state of a USB device before state change and y denotes serial number indicating the state of the USB device after returning from the state change. When x

The reason why the estimated state transition sequence mentioned above can be considered is as follows. If the after return state y is equal to 0 it can be considered that connection of the USB device is in the cut off state Not Attached 0 as a result of the state change whatever the before change state x is. As indicated in the state transition diagram of the state of the USB device after it is changed to the state of Disconnect can be changed to the state of Not Attached from any state. The USB device driver is provided so that the state of the USB device can be changed to the state of Not Attached 0 from any state.

Similarly if y indicates the state immediately before the state of Connect Attached 1 regardless of the number of x whatever state it was it can be considered that it is in the state with which hub resetting has occurred. As indicated in the state transition diagram of the state transition is either the direct change to the state of Attached 1 after the hub resetting state Hub Reset or Hub Deconfigure occurred or the changes from the state of Not Attached 0 to the state of Attached 1. In the latter case even if the direct change to the state of Attached 1 is estimated the mismatching between the state of the USB device and the state of the USB device driver can be suppressed. The mismatching can be suppressed by disregarding the difference between the two cases and presuming that it is changed to the state of Attached directly.

When y is equal to two or more and x y no state changes from a large number to a small state do not exist except for the state of Deconfigure as indicated in the state transition diagram of . Although special consideration may be given to the state of Deconfigure and direct state transition may be considered only for the state change from Configured 5 to Address 4 the changes to the state of Deconfigure are not common in the normal operation of the actual USB device. Thus at the time of y 2 and x y it is assumed that the state of the USB device is changed to the state of Attached 1 and then changed to the state of y. By this estimated state transition it is possible to suppress the mismatching between the state of the USB device driver and the state of the USB device.

In order to suppress the mismatching which may occur between the state of the USB device driver and the state of the actual USB device an estimated state transition sequence is generated based on the above mentioned conditions.

The USB device is set in a communication permitted state when it is in the state of Configured 5 and the outputting or inputting of data between the USB device and the MFP of this embodiment or the data transfer therebetween is permitted at this time.

When the condition x y is met it is a case where the state transition has not arisen and a vacant estimated state transition sequence is generated as the result step S . And the processing is ended.

On the other hand when the condition x y is not met it is a case where the state transition has arisen. In this case the processing is branched depending on whether the state changes returning from the state of Configured 5 to the state of Attached 1 or Not Attached 0 have arisen.

On the other hand when the condition x y is met or when the result of the determination at step S is negative it is a case where the changes returning from the state of Configured 5 to the state of Attached 1 or Not Attached 0 have arisen. In this case the processing is branched depending on whether the after return state y is the state of Attached 1 or the state of Not Attached 0.

It is determined whether the condition y 0 or y 1 is met step S . When the condition y 0 or y 1 is met or when the result of the determination at step S is affirmative an estimated state transition sequence y in which the serial number changes to y immediately is generated as the result step S . And the processing is ended.

On the other hand when the condition y 0 or y 1 is not met or when the result of the determination at step S is negative an estimated state transition sequence 1 . . . y in which the serial number is changed to 1 immediately and incremented to y is generated the result step S . And the processing is ended.

For example if the before change state prior to the power saving mode is the state of Configured 5 and the after return state is the state of Default 3 the result of an estimated state transition sequence based on the above mentioned conditions is set to 1 2 3.

According to the estimated state transition sequence generated as mentioned above the mismatching which may occur between the state of the USB driver and the state of the actual USB device can be suppressed.

The mismatching which may occur in the power saving control processing is suppressed in the following control processing by operation of the ACPI driver which controls the power saving state. The ACPI driver performs the above mentioned control processing as part of the change and return processing. In the change and return processing the processing needed to suppress the mismatching is performed at the time of changing to and returning from the power saving mode and the registering processing is also performed in which a change hook routine used for the processing of changing to the power saving mode and a return hook routine used for the processing of returning from the power saving mode are registered.

Upon start of the power saving mode change and return processing of the ACPI driver calls up prior to the change to the power saving mode the routine of change processing of a relevant device from the change hook routine registered in the change hook list step S .

In the registering processing the devices which are mounted by the respective device drivers including the USB driver of this embodiment at the time of initialization are registered as shown in the flowchart of . By adding the hook entry to the end of the change hook link list the registering processing entry is added to the change hook list step S .

Subsequently the power saving mode change processing is performed using the change hook routine called from those registered in the change hook list as mentioned above step S as shown in .

If the DMA direct memory access of the USB device of is stopped when it is in the data receivable state the USB control unit performs NAK response on the USB bus when a data packet is received and the USB device is in the state in which data is not received. If the data receiving state is detected which is considered as a return factor from the power saving mode the return processing is performed. After the return from the power saving mode it is necessary to start the DMA of the USB device in order to resume data receiving.

In the power saving mode change processing step S the state of the USB device prior to the power saving change see the state transition diagram of is recorded by the USB change hook routine of step S .

Subsequently the DMA is stopped so that the data transmitted from the USB device through the sub system may not be received step S and the control is shifted from the change hook routine.

The power saving mode return processing is performed at the time of returning from the power saving mode step S . At this time the routine of the return processing of the relevant device which is needed for the return processing is called up from the return hook routine registered into the return hook list step S .

The processing of registering the devices to the return hook list is performed according to the flowchart of . In the registering processing the devices which are mounted by the respective device drivers including the USB driver of this embodiment at the time of initialization are registered. By adding the hook entry to the end of the return hook link list the registering processing entry is added to the return hook list step S .

Subsequently the state of the USB device driver is changed according to the estimated state transition sequence generated at the step S and the mismatching between the state of the USB device drive and the current state of the USB device is suppressed by the changed state information step S .

Subsequently the DMA is started so that the data transmitted from the USB device through the sub system may be received according to the state step S . The control is shifted from the return hook routine and the change and return processing by the ACPI driver is ended.

Accordingly the mismatching of the device state between the USB device driver provided in the main control system and the USB device connected to the image processing device is suppressed by the operation performed at the time of the power saving mode and the operational problem which may occur at the time of returning from the power saving mode can be avoided and proper operation can be ensured.

This invention is not limited to the above described embodiments and variations and modifications may be made without departing from the scope of the invention.

This application is based upon and claims the benefit of priority of Japanese patent application No. 2005 218792 filed on Jul. 28 2005 Japanese patent application No. 2005 225240 filed on Aug. 3 2005 and Japanese patent application No. 2006 202443 filed on Jul. 25 2006 the entire contents of which are incorporated by reference.

