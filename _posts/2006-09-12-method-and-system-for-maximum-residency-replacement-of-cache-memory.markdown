---

title: Method and system for maximum residency replacement of cache memory
abstract: Techniques for use in CDMA-based products and services, including replacing cache memory allocation so as to maximize residency of a plurality of set ways following a tag miss allocation. Herein, steps and instructions provide for forming a first-in, first-out (FIFO) cache way listing of victim ways for the cache memory, wherein the depth of the FIFO cache way listing approximately equals the number of ways in the cache memory. The method and system place a victim way on the FIFO cache way listing only in the event that a tag miss results in a tag miss allocation, the victim way is placed at the tail of the FIFO cache way listing after any previously selected victim way. Use of a victim way on the FIFO cache way listing is prevented in the event of an incomplete prior allocation of the victim way by, for example, stalling a reuse request until such initial allocation of the victim way completes or replaying a reuse request until such initial allocation of the victim way completes.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07584326&OS=07584326&RS=07584326
owner: QUALCOMM Incorporated
number: 07584326
owner_city: San Diego
owner_country: US
publication_date: 20060912
---
This application is a continuation of Utility application Ser. No. 11 437 501 entitled METHOD ANS SYSTEM FOR MAXIMUM RESIDENCY REPLACEMENT OF CACHE MEMORY and filed on May 17 2006.

The disclosed subject matter relates to digital signal processing in support of communications products and services. More particularly this disclosure relates to a novel and improved method and system for maximum residency replacement of cache memory as may find use in a digital signal processor for a handset or other communications system.

Increasingly electronic equipment and supporting software applications involve digital signal processing. For example home theatre computer graphics medical imaging and telecommunications applications generally rely on digital signal processing technology. Digital signal processing requires fast math in complex but repetitive algorithms. Many such applications require computations in real time i.e. the signal is a continuous function of time which must be sampled and converted to binary data for numerical processing. The digital signal processor executes algorithms performing discrete computations on the samples as they arrive. The architecture of a digital signal processor or DSP is optimized to handle such algorithms. The characteristics of a good signal processing engine include fast flexible arithmetic computation units unconstrained data flow to and from the computation units extended precision and dynamic range in the computation units efficient program sequencing and ease of programming.

One promising application of DSP technology includes communications systems such as a code division multiple access CDMA system that supports voice and data communication between users over a satellite or terrestrial link. The use of CDMA processes in a multiple access communication system is disclosed in U.S. Pat. No. 4 901 307 entitled SPREAD SPECTRUM MULTIPLE ACCESS COMMUNICATION SYSTEM USING SATELLITE OR TERRESTRIAL REPEATERS and U.S. Pat. No. 5 103 459 entitled SYSTEM AND METHOD FOR GENERATING WAVEFORMS IN A CDMA CELLULAR TELEHANDSET SYSTEM both assigned to the assignee of the claimed subject matter.

A CDMA system is typically designed to conform to one or more telecommunications and now streaming video standards. One such first generation standard is the TIA EIA IS 95 Terminal Base Station Compatibility Standard for Dual mode Wideband Spread Spectrum Cellular System hereinafter referred to as the IS 95 standard. The IS 95 CDMA systems are able to transmit voice data and packet data. A newer generation standard that can more efficiently transmit packet data is offered by a consortium named 3rd Generation Partnership Project 3GPP and embodied in a set of documents including Document Nos. 3G TS 25.211 3G TS 25.212 3G TS 25.213 and 3G TS 25.214 which are readily available to the public. The 3GPP standard is hereinafter referred to as the W CDMA standard. There are also video compression standards such as MPEG 1 MPEG 2 MPEG 4 H.264 and WMV Windows Media Video as well as many others that such wireless handsets will increasingly employ.

In the operation of a DSP lower power consumption is of growing importance in data processing systems for example due to wide spread use of such portable and handheld applications. Many DSPs today use a smaller faster and more efficient memory sometimes referred to as a cache memory to reduce the number of accesses to main memory. Accesses to cache memory generally consume less power and result in reduced latencies as compared to accesses to other internal or external memories. By storing those items which will subsequently be requested again in the faster more efficient cache significant power reductions and performance increase may occur.

Cache memory also provides the processor with a way to fetch data quickly without incurring the wait states associated with main memory sources such as DRAM. Using cache memory typically improves computer system performance making commonly used data available to the processor without requiring paging cycles or the physical delays occurring from main memory s us of complex bus structures.

Typically cache memory is organized in sets or ways hereafter collectively referred to as cache ways . A cache way typically includes of a number of cache memory entry locations that may be accessed using a common address. A set associative cache is a type of cache memory that organizes data in cache ways that are assigned or mapped to a particular location within a main memory sources such as DRAM. A cache way is re mapped when data stored within that way is replaced by data from another location within main memory. Furthermore cache ways may be mapped to the same main memory location in order to help maintain in cache the most current version of data associated with a particular main memory location.

Now cache memory is typically smaller than main memory so cache ways need to be deleted to make room for newly accessed data which is not stored in the cache. Those cache ways to be replaced are known as victim ways. Data applied to the victim ways should be statistically more likely to be accessed again in the near future than is data that has been in the cache for some time. Typically the cache selects one or more cache entries which are eligible to store data corresponding to a given transaction and searches these entries to detect a hit or miss. In a set associative cache two or more entries are eligible to store the data based on the address of the data. The cache way of any one of the two or more entries could be evicted on a miss. Set associative caches employ a replacement policy to select one of the two or more eligible entries for eviction. A variety of replacement policies exist.

Two known types of cache replacement processes are the Least Recently Used LRU and Not Recently Used NRU cache replacement policies. Each of these cache replacement policies requires complex monitoring of the transactions presented to the cache along with detailed knowledge of the implemented replacement policy to determine the state of the replacement policy at any given point in time. Thus for each use of the cache way there is the need to update the storage bit associated with the cache way. This updating is expensive in terms of operational resource use and energy consumption.

Accordingly there is a need for a low cost highly efficient cache replacement process that achieves essentially the same performance of the NRU and LRU approaches. Low cost benefits preferably would therefore include reducing the storage requirements in the cache replacement process. Also reducing storage requirements promotes improved energy use during DSP operation.

Another consideration in use of the LRU and NRU processes is of particular relevance in a DSP performing multi threaded processing. In such a processor with the LRU and NRU cache replacement policies there is the recurring need to forward storage bit information from one pipeline to the next. The costs of forwarding the storage bit information from pipeline to pipeline can be excessive particularly when there is a limited time budget for each pipeline stage. That is the handling of the storage bit information from one pipeline stage to another may exact an undesirable cost during the multi threaded operation.

Also as mentioned above the handling of storage bits as is required in the LRU and NRU replacement policies generally entails the use of wide and large busses to convey storage bit information. Because the large busses that convey the storage bit information consume power and introduce performance delays there is the need to reduce or eliminate the conveyance of such storage bit information in a cache way replacement policy.

Accordingly a need exists to improve over the known LRU and NRU cache replacement policies. Particularly such a need exists in the operation of a multi threaded DSP or similar processor.

A further need exists to reduce the power consumption and performance delays that exist in known cache replacement processes for a DSP or similar processor.

In essence therefore a need exists to eliminate the handling of storage bit information during cache way replacement operations of a DSP or similar processor.

Techniques here disclosed provide for maximum residency replacement of cache memory in a digital signal processor which techniques improve both the operation of the processor and the efficient and more rapid processing of digital signal processor instructions. The present disclosure may for example benefit a multi threaded processor system in which a plurality of processor threads share cache memory in an n way set associative method where n is 2 or larger and more particularly to a replacement control technology that is applicable when a cache way miss occurs. Use of the disclosed subject matter permits increasingly robust software applications for personal computers personal digital assistants wireless handsets and similar electronic devices as well as increasing the processor speed and service quality.

According to one aspect of the disclosed subject matter there is provided a method and a system for replacing cache memory allocation so as to maximize residency of a plurality of set ways following a tag miss allocation. The disclosure includes forming a first in first out FIFO cache way listing of victim ways for the cache memory wherein the depth of the FIFO cache way listing approximately equals the number of ways in the cache memory.

The method and system place a victim way on the FIFO cache way listing only in the event that a tag miss results in a tag miss allocation the victim way is placed at the tail of the FIFO cache way listing after any previously selected victim way. Use of a victim way on the FIFO cache way listing is prevented in the event of an incomplete prior allocation of the victim way by for example stalling a reuse request until such initial allocation of the victim way completes or replaying a reuse request until such initial allocation of the victim way completes. In addition the present embodiment skips such ways on the FIFO cache way listing which present a reuse hazard. Thus if a potential victim way at the top of the FIFO cache way listing presents a reuse hazard then the present process chooses the next way in the FIFO cache way listing that does not present a reuse hazard. A counter associated with the process then increments to the next higher numbered cache way modulo the number of available cache ways . The incrementing here provided will continue until the process selects a useable cache way.

These and other aspects of the disclosed subject matter as well as additional novel features will be apparent from the description provided herein. The intent of this summary is not to be a comprehensive description of the claimed subject matter but rather to provide a short overview of some of the subject matter s functionality. Other systems methods features and advantages here provided will become apparent to one with skill in the art upon examination of the following FIGUREs and detailed description. It is intended that all such additional systems methods features and advantages that are included within this description be within the scope of the accompanying claims.

The disclosed subject matter of a method and system for maximum residency replacement of cache memory as here presented has use in a very wide variety of digital signal processing applications including those involving multi threaded processing. One such application appears in telecommunications and in particular in wireless handsets that employ one or more DSP circuits. Consequently the following FIGUREs describe a telecommunications DSP within which one may use the present teachings. Remember however that the implementation here described provides but one of a virtually limitless set of applications to which the disclosed subject matter may apply.

For the purpose of explaining how such a wireless handset may be used provides a simplified block diagram of communications system that may implement the presented embodiments of the disclosed data processing method and system. At transmitter unit data is sent typically in blocks from data source to transmit TX data processor that formats codes and processes the data to generate one or more analog signals. The analog signals are then provided to transmitter TMTR that modulates filters amplifies and up converts the baseband signals to generate a modulated signal. The modulated signal is then transmitted via antenna to one or more receiver units.

At receiver unit the transmitted signal is received by antenna and provided to receiver RCVR . Within receiver the received signal is amplified filtered down converted demodulated and digitized to generate in phase I and Q samples. The samples are then decoded and processed by receive RX data processor to recover the transmitted data. The decoding and processing at receiver unit are performed in a manner complementary to the coding and processing performed at transmitter unit . The recovered data is then provided to data sink .

The signal processing described above supports transmissions of voice video packet data messaging and other types of communication in one direction. A bi directional communications system supports two way data transmission. However the signal processing for the other direction is not shown in for simplicity. Communications system can be a code division multiple access CDMA system a time division multiple access TDMA communications system e.g. a GSM system a frequency division multiple access FDMA communications system or other multiple access communications system that supports voice and data communication between users over a terrestrial link. In a specific embodiment communications system is a CDMA system that conforms to the W CDMA standard.

IQ in IU keeps a sliding buffer of the instruction stream. Each of the six threads T T that DSP supports has a separate IQ where each entry may store one VLIW packet or up to four individual instructions. Decode and issue circuitry logic is shared by all threads for decoding and issuing a VLIW packet or up to two superscalar instructions at a time as well as for generating control buses and operands for each pipeline SLOT SLOT. PLC is also shared by all threads for resolving exceptions and detecting pipeline stall conditions such as thread enable disable replay conditions maintains program flow etc.

In operation general register file GRF and control register file CRF of a selected thread is read and read data is sent to execution data paths for SLOT SLOT. SLOT SLOT in this example provide for the packet grouping combination employed in the present embodiment. Output from SLOT SLOT returns the results from the operations of DSP .

The subject matter here disclosed deals with the cache replacement policy of a single thread. A single thread sees a complete uni processor DSP with all registers and instructions available. Through coherent shared memory facilities this thread is able to communicate and synchronize with other threads. Whether these other threads are running on the same processor or another processor is largely transparent to user level software.

Turning to the present micro architecture for DSP includes control unit CU which performs many of the control functions for processor pipeline . CU schedules threads and requests mixed 16 bit and 32 bit instructions from IU . CU furthermore schedules and issues instructions to three execution units shift type unit SU multiply type unit MU and load store unit DU . CU also performs superscalar dependency checks. Bus interface unit BIU interfaces IU and DU to a system bus not shown .

SLOT and SLOT pipelines are in DU SLOT is in MU and SLOT is in SU . CU provides source operands and control buses to pipelines SLOT SLOT and handles GRF and CRF file updates. CU accepts external inputs such as interrupts and reset and supports emulation unit EU . CU also handles exceptions due to protection violations occurring during address translations. Mixed 16 and 32 bit instructions can be issued in parallel up to four at a time in one embodiment of micro architecture . However many different variations of 16 bit 32 bit and other length instructions may be implemented in other embodiment all within the scope of the disclosed subject matter. Micro architecture furthermore may also support moving two 64 bit double words from CU for each cycle.

DSP using micro architecture specifically supports the following classes of applications 1 communications signal processing e.g. modems 2 video processing e.g. H.264 format 3 image processing 4 audio processing 5 3 D graphics front end software and 6 supporting control code protocol stacks RTOS etc. As such DSP issues both VLIW instruction packets as well as individual superscalar issue instructions. Issue width for individual instructions can range from one instruction per issue slot to maximum VLIW packet. As an example DSP may issue as many as four instructions in a VLIW packet per issue slot. Also DSP may issue one or two instructions using superscalar issue.

DCU includes SRAM state array circuit store aligner circuit CAM tag array SRAM data array and load aligner circuit . To further explain the operation of DU wherein the claimed subject matter may operate reference is now made to the basic functions performed therein according to the several partitions of the following description. In particular DU executes load type store type and 32 bit instructions from ALU .

DU receives up to two decoded instructions per cycle from CU in the DE pipeline stage including immediate operands. In the RF pipeline stage DU receives general purpose register GPR and or control register CR source operands from the appropriate thread specific registers. The GPR operand is received from the GPR register file in CU . In the EX pipeline stage DU generates the effective address EA of a load or store memory instruction. The EA is presented to MMU which performs the virtual to physical address translation and page level permissions checking and provides page level attributes. For accesses to cacheable locations DU looks up the data cache tag in the EX pipeline stage with the physical address. If the access hits DU performs the data array access in the EX pipeline stage.

For cacheable loads the data read out of the cache is aligned by the appropriate access size zero sign extended as specified and driven to CU in the WB pipeline stage to be written into the instruction specified GPR. For cacheable stores the data to be stored is read out of the thread specific register in the CU .

DU also executes cache instructions for managing DCU . The instructions allow specific cache ways to be locked and unlocked invalidated and allocated to a GPR specified cache way. There is also an instruction to globally invalidate the cache. These instructions are pipelined similar to the load and store instructions. For loads and stores to cacheable locations that miss the data cache and for uncacheable accesses DU presents requests to BIU . Uncacheable loads present a read request. Store hits misses and uncacheable stores present a read write request. DU tracks outstanding read and line fill requests to BIU . DU also allows accesses by other threads while one or more threads are blocked pending completion of outstanding load requests. That is DU supports read write requests both to and from the DSP core processor. BIU therefore provides a bi directional interface to the bus for these operations.

Generally speaking two types of stores may occur in cache memories applicable to the present disclosure. The write back store simply stores in cache memory to update cache memory in the event of cache way hit. If a cache way miss occurs then data simply will not be available for cache memory update purposes. Write back stores are not communicated via BIU to a bus. On the other hand write through stores change cache memory data as well as are communicated back to a bus. For writ through stores data may yet be communicated back to a bus in the event of a cache miss. Regardless of the particular type of cache memory store occurring the presently disclosed subject matter provides an improved method and system for maximum replacement of cache memory.

The disclosed subject matter therefore provides a first in first out or FIFO listing process for cache replacement operations during digital signal processing such as those occurring in DU . A technical advantage of the disclosed process is the avoidance of the need to track which cache way has been most recently used. With the present FIFO cache replacement process there is only the need to determine the presence of available cache resources. There is no requirement to maintain a running record of the access patterns to cache memory.

The disclosed subject matter updates the cache way listing only in the event that a cache way miss occurs. Thus when many misses occur the process of the disclosed subject matter will operate continually to identify cache ways for use replacement on the FIFO cache way listing. On the other hand if cache misses do not occur then the process here disclosed does not continuously update. The present FIFO cache replacement process waits until a next cache miss occurs.

The FIFO cache replacement process bases the next cache way to replace according to the cache ways that have been replaced from the FIFO cache way listing. Accordingly if no way is being replaced the FIFO cache way listing of cache ways to replace will not change. The oldest cache way on the FIFO cache way listing on the other hand will be least likely to be used and the most likely to be removed from the FIFO cache way listing. With the disclosed subject matter when a request lookup receives a cache tag miss one of the set ways must be replaced. The cache way that is selected for replacement is referred to as the victim way since in certain cases the cache contents of the victim way must be removed from the cache to make room for the tag miss allocation. These cases arise when the contents in the cache are for one reason or another different from the contents in the DSP main memory. For example if a store in a line occurs the contents may change thereby requiring the need for replacement.

In order to maximize the time each way remains in the cache the victim way is placed on the tail of a set based FIFO cache way listing following a cache miss. The depth of the replacement FIFO cache way listing is equal to the number of ways in the cache memory thereby maximizing the time or residency of miss allocation before the same way is evicted again. Subsequent tag misses to the same set will likewise generate a victim way and be placed on the tail of the set FIFO. Each new victim forces earlier victims towards the replacement FIFO cache way listing head. When the number of same set victims equal the number of cache ways a victim way is reused on the next tag miss.

The implementation of the FIFO replacement policy as herein disclosed maximizes cache residency based on the number of ways in each set. This policy also makes use of the data according to its age on the FIFO cache way listing. The disclosed process replaces from the FIFO cache way listing the cache way that was earliest listed. So that the FIFO cache way listing only includes those most recently used cache ways. If an outstanding allocation request already exists for an earlier tag miss the current tag miss does not update the FIFO cache way listing.

In the instance when a victim way is placed on the FIFO cache way listing tail it is possible that the same way will reach the head and be reused before the initial allocation completes. This hazard may lead to incoherency between the tag and data caches if the victim way reuse is not corrected. Several possible solutions to this hazard exist. One solution may be to stall or replay the reuse request or reading the FIFO cache way listing head a second time after the reuse way is placed on the FIFO cache way listing tail.

With this introduction two implementations will be described in . These implementations may be used in a digital signal processor such as DSP in IU process of and DU process of . First consider process wherein IU runs a tag lookup beginning at step and a tag miss may occur at step . In such case the request address is compared at step to the active requests stored in an outstanding request buffer ORB . If the lookup address is unique at step the request is considered a primary miss PM at step . If the request is a primary miss then the process references the FIFO buffer for a possible victim way to use for replacement at step . At step the FIFO cache way listing is read for a victim way. If in step ORB detects that request address is not unique the request is considered a secondary miss SM at step . In this case the replacement FIFO cache way listing is not read and cache residency is maximized at step .

From step process flow goes to both steps and . At step the FIFO cache way listing head is placed at the listing tail and at step the victim way is stored in a last way buffer. With this step the FIFO cache way listing head exposes a new victim way from the sequential listing which listing is modulo the number of available ways e.g. modulo in the event of 16 available cache ways . At step process flow determines the presence of a victim way reuse hazard. This includes comparing the current incoming victim way to other lastway buffers at step after which a query of whether a hit is detected occurs at step . Also the set address of the incoming primary miss is compared against other thread set addresses at step after which a query of whether a hit is detected occurs at step . If a hit is detected at query and at query then process flow continues to AND step . AND step in response to each of queries and detecting a hit provides input to step at which point process replays the current incoming thread. That is if a hit is detected at both queries and then a reuse hazard exists. Process flow then returns to step at which IU runs a tag look up. In the event of either no hit detected at query or query then process flow goes to step at which it is determined that a reuse hazard does not exist. If no reuse hazard exists then process flow continues to final step for use of the selected cache way.

By pipelining the replacement FIFO cache way listing access behind the determination for a victim way allocation IU can immediately move the victim way from the head to the tail of the FIFO cache way listing in the same clock. This allows IU to support back to back multi thread accesses in the replacement FIFO cache way listing without replays.

IU may implement the replacement FIFO cache way listing as a simple 4 bit counter. Each primary miss reads the replacement set counter and increments the set counter by one. The set counter is always incremented on a primary miss clearing the reuse hazard before the thread that hit the hazard is replayed. There may be other ways of implementing the disclosed subject matter on an IU or similar circuitry that may exist on a DSP such as DSP .

Query then determines whether the obtained victim way is pointed in a reserved state. If the victim way points to a reserved state then process goes to step at which a victim way reuse hazard is detected. At step process replays the thread and increments the FIFO cache way listing. Thereafter process returns to step for again reading the tag and state.

If query determines that the victim way does not point in a reserved state then process goes to step . At step the obtained victim way is used for refill. Then the refill request is executed at step and at step the FIFO cache way listings incremented and updated. Returning to query if a tag hit is detected i.e. an address match occurs then process goes to query . Query tests whether the state of the hitting cache way is valid or dirty. If valid or dirty i.e. the data associated with the cache way differs from the corresponding data in core memory then process goes to step at which point the determination is made that a cache hit has occurred. Otherwise query continues process flow to query . At query a test of whether a reserved state for the hitting cache way exists. If so then process flow goes to step at which it is determined that a secondary miss exists. If query determines that a reserved state does not exist then a primary miss exists and process goes back to step at which it is determined that a primary miss exists since the state has now been determined as invalid. Then process flow may proceed as previously described from step above.

With the present embodiment DU may update the replacement FIFO cache way listing and maintain maximum cache residency and cache coherency. Other implementations of the disclosed subject matter however may not support back to back multi thread accesses in the replacement FIFO cache way listing as described above. Such may occur where the addition of state and replacement bypass serves to maintain accurate state and FIFO cache way listing information until they are written back to their set. There may be other ways to implement the presently disclosed subject matter in DU and similarly functioning portions of a DSP such as DSP .

The disclosed subject matter therefore provides a method for replacing one of a plurality of set ways of a cache memory in the event of a cache tag miss. The disclosure includes the step of selecting a victim way as the cache way that is to be replaced by placing the victim way on the tail of a FIFO cache way listing following the cache misses wherein the depth of the FIFO approximately equals the number of ways in the cache memory. Next the process places at the end of the FIFO cache way listing subsequent cache tag misses to the cache memory. The process then involves reusing a victim way on a next cache tag miss in the event that the number of victim ways for the cache memory equals the number of cache memory ways. Reuse of a victim way is prevented until initial allocation of the victim way completes. This avoids incoherency between the cache tag and the cache memory. Moreover the process prevents reuse of a victim way until initial allocation of the victim way completes by stalling a reuse request until such initial allocation of the victim way completes. The process also prevents reuse of a victim way until initial allocation of the victim way completes by replaying a reuse request until such initial allocation of the victim way completes. By performing this process and ones substantially similar to it the disclosed subject provides an efficient cache way replacement policy that together with the implementing circuitry avoids the existing limitations of the known LRU and NRU algorithms.

The processing features and functions described herein can be implemented in various manners. For example not only may DSP perform the above described operations but also the present embodiments may be implemented in an application specific integrated circuit ASIC a microcontroller a microprocessor or other electronic circuits designed to perform the functions described herein. The foregoing description of the preferred embodiments therefore is provided to enable any person skilled in the art to make or use the claimed subject matter. Various modifications to these embodiments will be readily apparent to those skilled in the art and the generic principles defined herein may be applied to other embodiments without the use of the innovative faculty. Thus the claimed subject matter is not intended to be limited to the embodiments shown herein but is to be accorded the widest scope consistent with the principles and novel features disclosed herein.

