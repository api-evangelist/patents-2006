---

title: SAR restart and going home procedures
abstract: Described are techniques used in performing data replication processing. Data is replicated on a recovery site from a production site. When a disaster occurs, the state of the replication processing is determined and a restart copy of the data is made available from the recover site. Processing continues based on whether protection mode is desired such that the system executes using the recovery site as the restart with a replicated copy of the data. Data is propagated from the recovery site to the production site to resume operations and replication processing originating from the production site.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07607037&OS=07607037&RS=07607037
owner: EMC Corporation
number: 07607037
owner_city: Hopkinton
owner_country: US
publication_date: 20060815
---
This application is a continuation of U.S. patent application Ser. No. 10 224 918 now U.S. Pat. No. 7 117 386 filed on Aug. 21 2002 which is incorporated by reference herein.

This application generally relates to computer systems and more particularly to computer data storage.

Computer systems may include different resources used by one or more host processors. Resources and host processors in a computer system may be interconnected by one or more communication connections. These resources may include for example data storage devices such as the Symmetrix family of data storage systems manufactured by EMC Corporation. These data storage systems may be coupled to one or more host processors and provide storage services to each host processor. An example data storage system may include one or more data storage devices such as those of the Symmetrix family that are connected together and may be used to provide common data storage for one or more host processors in a computer system.

A host processor may perform a variety of data processing tasks and operations using the data storage system. For example a host processor may perform basic system I O operations in connection with data requests such as data read and write operations and also administrative tasks such as data backup and mirroring operations.

Host processor systems may store and retrieve data using a storage device containing a plurality of host interface units disk drives and disk interface units. Such storage devices are provided for example by EMC Corporation of Hopkinton Mass. and disclosed in U.S. Pat. No. 5 206 939 to Yanai et al. U.S. Pat. No. 5 778 394 to Galtzur et al. U.S. Pat. No. 5 845 147 to Vishlitzky et al. and U.S. Pat. No. 5 857 208 to Ofek. The host systems access the storage device through a plurality of channels provided therewith. Host systems provide data and access control information through the channels to the storage device and storage device provides data to the host systems also through the channels. The host systems do not address the disk drives of the storage device directly but rather access what appears to the host systems as a plurality of logical disk units. The logical disk units may or may nor correspond to the actual disk drives. Allowing multiple host systems to access the single storage device unit allows the host systems to share data stored therein.

A computer system may utilize techniques in connection with data storage to provide for multiple copies of data that are as current as possible to be used for example in the event of a system disaster at a data storage site.

Referring to shown is an example of a prior art system utilizing data replication techniques. The host communicates with the primary data storage to perform data processing operations such as data read and write operations. The system includes a mirror copy of the data of device in device . The mirror copy may be stored locally or within close proximity to device rather than at a remote other geographic location. The device may be a master storage device having one or more slave storage devices such as and . Device may be remotely located with respect to and . The data storage devices may communicate using the Remote Data Facility RDF product as provided by EMC Corporation. The devices may be one or more Symmetrix data storage systems. RDF may be used facilitate copying of data between storage devices. The host interacts with the device but data updates may be automatically propagated to devices and using RDF. The devices and may be connected by a data link such as an ESCON link or Fibre Channel link. The RDF functionality may be facilitated with an RDF adapter RA provided within each storage device 

When is remote with respect to devices and communicate in a synchronous mode such that the host receives an acknowledgement that a write operation is complete when it has been written to both devices. Device may send the host an acknowledgement that the data operation is complete after receiving a completion acknowledgement from device . Devices and may communicate using an asynchronous communication mode.

It may be that the copy of data to be used for example in connection with performing data recovery operations is remotely located such as device rather than locally located such as device . Communications with such remote devices may performed asynchronously as described above. If a remote device is used in connection with for example data recovery operations the remote device may not contain an up to date copy of the data of device

Another technique may utilize Business Continuance Volumes BCVs . BCVs and data operations used in connection therewith are described in U.S. Pat. No. 6 101 497 filed on Apr. 25 1997 which is incorporated by reference herein. Referring again to the data storage system may include a BCV device for each standard device to which the host may perform data operations. A standard device may be characterized as a device configured for use with host applications. The BCV may be attached to a standard device. Subsequently the BCV may be split consistently from the associated STD device to provide a copy of the data on the BCV device for some other purpose. In other words after the BCV is attached and achieves a state of synchronism with the standard device R the BCV may be split or detached from the standard device. The copy of data on the BCV device may then be available for use by other applications for example an ancillary application such as a backup or remote copy application that copies data from the device . The BCV allows for a consistent copy of data on the standard device to be maintained and then independently allows another application to act on the data copy while letting the host perform continued data operations to the standard device. However this technique may also have the drawback that the copy of the data on the device may not be an up to date copy of the data in the standard device.

Thus it may be desirous and advantageous to have an efficient technique which provides automated data replication processing to provide one or more consistent copies of data wherein a copy of data is as current as possible. It may also be desirable and advantageous to provide a copy of data that is restartable from a remote data storage site different from a local data storage site for example in the event of a disaster at the local data storage site. It may be desirable that such techniques be automated and may be used in connection with one or more groups of devices.

In accordance with another aspect of the invention is a method executed in a computer system for recovering data from a target site upon the occurrence of a disaster at a primary site comprising performing data replication processing propagating consistent point in time copies of data from a primary site to a target site performing restart processing that determines a processing state of said data replication processing at a time of said disaster and propagating a most recent one of said consistent point in time copies of data from said target site to said primary site wherein said performing data replication processing is performed from a first host computer connected to said primary site and said performing restart processing and said propagating are automatically performed from a second host computer connected to said target site.

In accordance with another aspect of the invention is a computer program product a computer product for recovering data from a target site upon the occurrence of a disaster at a primary site comprising machine executable code that performs data replication processing propagating consistent point in time copies of data from a primary site to a target site machine executable code that performs restart processing that determines a processing state of said data replication processing at a time of said disaster and machine executable code that propagates a most recent one of said consistent point in time copies of data from said target site to said primary site wherein said data replication processing is performed from a first host computer connected to said primary site and said restart processing and said propagating are automatically performed from a second host computer connected to said target site.

Referring now to shown is an example of an embodiment of a computer system according to the present invention. The computer system includes a data storage system connected to host systems and a data manager system through communication medium . In this embodiment of the computer system the N hosts and the data manager system may access the data storage system for example in performing input output I O operations or data requests. The communication medium may be any one of a variety of networks or other type of communication connections as known to those skilled in the art. The communication medium may be a network connection bus and or other type of data link such as a hardwire or other connections known in the art. For example the communication medium may be the Internet an intranet network or other connection s by which the host systems and the data manager system may access and communicate with the data storage system and may also communicate with others included in the computer system .

Each of the host systems the data manager system and the data storage system included in the computer system may be connected to the communication medium by any one of a variety of connections as may be provided and supported in accordance with the type of communication medium . The processors included in the host computer systems and the data manager system may be any one of a variety of commercially available single or multi processor system such as an Intel based processor IBM mainframe or other type of commercially available processor able to support incoming traffic in accordance with each particular embodiment and application.

It should be noted that the particulars of the hardware and software included in each of the host systems and the data manager system as well as those components that may be included in the data storage system are described herein in more detail and may vary with each particular embodiment. Each of the host computers as well as the data manager system may all be located at the same physical site or alternatively may also be located in different physical locations. Examples of the communication medium that may be used to provide the different types of connections between the host computer systems the data manager system and the data storage system of the computer system may use a variety of different communication protocols such as SCSI Small Computer System Interface ESCON Fibre Channel or GIGE Gigabit Ethernet FICON and the like. Some or all of the connections by which the hosts data manager system and data storage system may be connected to the communication medium may pass through other communication devices such as a Connectrix or other switching equipment that may exist such as a phone line a repeater a multiplexer or even a satellite.

Each of the host computer systems as well as the data manager system may perform different types of data operations in accordance with different types of administrative tasks. In the embodiment of any one of the host computers may issue a data request to the data storage system to perform a data operation. For example an application executing on one of the host computers may perform a backup or other administrative operation and may do so while performing data requests to the data storage system .

Referring now to shown is an example of an embodiment of the data storage system that may be included in the computer system of . Included in the data storage system of are Symmetrix storage systems as manufactured by EMC Corporation of Hopkinton Mass. In this particular example each of the Symmetrix storage systems may be inter connected not shown as well as to the host and data manager systems through any one or more communication connections that may vary with each particular embodiment and device in accordance with the different protocols used in a particular embodiment. Additionally the type of communication connection used may vary with certain system parameters and requirements such as those related to bandwidth and throughput required in accordance with a rate of I O requests as may be issued by the host computer systems for example to the data storage system . In this example as described in more detail in following paragraphs reference is made to the more detailed view of element . It should be noted that a similar more detailed description may also apply to any one or more of the other elements such as but have been omitted for simplicity of explanation. It should also be noted that an embodiment may include other types of data storage systems in combination with one or more Symmetrix systems. Each of may be resources included in an embodiment of the computer system to provide storage services to for example host computer systems and or the data manager system.

Each of the Symmetrix systems such as may include a plurality of disk devices or volumes such as the arrangement consisting of n rows of disks or volumes . In this arrangement each row of disks or volumes may be connected to a disk adapter DA or director responsible for the backend management of operations to and from a portion of the disks or volumes . In the SymMetrix system a single DA such as may be responsible for the management of a row of disks or volumes such as row . Each of the DAs are connected for example by a bus to a cache that includes a particular portion designated as global memory . The DAs may perform data operations to and from the cache that may be included in the global memory for example in communications with other disk processors or directors and other components of the system . Generally the global memory may be used in facilitating communications between components in the system . The other portion is that portion of memory that may be used in connection with other designations that may vary in accordance with each embodiment.

An embodiment of the Symmetrix system may include a service processor used to manage and monitor the system . In one embodiment the service processor may be used in collecting performance data for example regarding the I O performance in connection with system . This performance data may relate to for example performance measurements in connection with a data request as may be made from the different host computer systems . This performance data may be gathered and stored for example in the global memory and or other storage area.

The system may also include one or more host adapters HAs or directors . Each of these HAs may be used to manage communications and data operations between one or more host systems and the global memory.

The particular data storage system as described in this embodiment such as a Symmetrix system by EMC Corporation or a disk should not be construed as a limitation. Other types of commercially available data storage systems as well as processors and hardware controlling access to these particular devices may be also be included in an embodiment.

Also shown in the storage system is an RA or remote adapter . The RA may be hardware including a processor used to facilitate communication between data storage systems such as between two Symmetrix data storage systems. The RA may be used with the Remote Data Facility RDF product provided by EMC Corporation of Hopkinton Mass.

Host systems provide data and access control information through channels to the storage systems and the storage systems may also provide data to the host systems also through the channels. The host systems do not address the disk drives of the storage systems directly but rather access to data may be provided to one or more host systems from what the host systems view as a plurality of logical devices or logical volumes LVs . The LVs may or may not correspond to the actual disk drives. For example one or more LVs may reside on a single physical disk drive. Data in a single storage system may be accessed by multiple hosts allowing the hosts to share the data residing therein. The HAs may be used in connection with communications between a Symmetrix data storage system and a host system. The RAs may be used in facilitating communications between two Symmetrix data storage systems. The DAs may be used in connection with facilitating communications to the associated disk drive s and LV s residing thereon.

The DA may cause I O operations to be performed on a volume or device. In the following description data may be accessed by LV in which a single DA manages data requests in connection with I O operations in connection with multiple LVs that may reside on a disk. The DA may accomplish this by creating job records for the different LVs associated with the particular DA. These different job records may be associated with the different LVs in a data structure stored and managed by each DA.

Referring now to shown is an example of an embodiment of a computer system that includes elements of the previously described computer system of . It should be noted that elements of the computer system are a simplified view of those previously described in connection with the system of . In this example one of the hosts such as performs data operations to a local storage system . Data from a local storage system may be copied to a remote storage system for example using an RDF connection or other type of link such that the data of the remote storage system is identical to the data in a local storage system

It should be noted that there may be a time delay between the transfer of data from the local storage system to the remote storage system . Therefore at certain points in time the data in may not be identical to that which is contained in . Data storage device communication between Symmetrix data storage systems using RDF is described for example in U.S. Pat. Nos. 5 742 792 and 5 544 347 both of which are incorporated by reference herein. As described elsewhere herein the storage systems and may communicate using RDF as facilitated by an RDF adapter unit or RA that may be included in each of the storage systems and . RAs may be included in each of the local and remote storage systems and respectively and may be coupled via the RDF link used to transfer data between the local and remote storage systems.

In the example the host reads and writes data to and from logical devices that may be included in the local storage system . RDF may be used to cause any data modifications to be transferred from the local storage system to the remote storage system using RAs included in each of the local storage systems and also using the RDF link .

In the following paragraphs a logical device on the local storage system that may be accessed by the host may be referred to as the R volume or just R . A logical device on the remote storage system that contains a copy of the data of the R volume may be referred to as the R volume or just R . The host may read and write data to and from the R volume. RDF will handle the automatic copying and updating of the data from the R volume to the R volume.

As described herein RDF is software that provides an on line host independent data storage system solution for duplicating production site data on one or more physically separated target Symmetrix data storage systems. A local RDF device also referred to as the source or R device as described herein may be configured in a pairing relationship with a remote or target R device forming an RDF pair. While the R device is mirrored with the R device the R device may be write disabled and not ready from a host s point of view. In this example a not ready status means that a device is disabled for both read and writes with respect to operations issued from the host. After the R device becomes synchronized with its R device the R device may be suspended from the R device making the R device fully accessible again to its host. After the split the R device contains valid data and may be used in connection with other tasks.

The TimeFinder software product by EMC Corporation works by configuring multiple independently addressable on line business continuance volumes or BCVs for information storage. The BCV in this example may be a Symmetrix data storage device having special attributes created when the Symmetrix data storage system is configured. The BCV may function either as an additional mirror or alternatively as an independent host addressable volume.

Establishing and splitting BCV devices as mirrors of active production volumes allows for separate tasks to run simultaneously. The principal or main device as described herein may also be referred to as the standard device STD that remains on line for the regular Symmetrix data storage device operations from the original server. When a BCV is established as a mirror of a standard device such as STD described herein that relationship may also be referred to as a BCV pair. The BCV may be temporarily inaccessible to its host until the BCV pair is split as in connection with a split operation described herein.

It should be noted that additional details as to the local storage system and the remote system in one particular embodiment are described in more detail in following paragraphs in connection with steps for performing storage automated replication SAR processing. It should also be noted that although the local and remote storage systems and described herein may be referred to as Symmetrix data storage systems techniques described herein may be used in connection with other types of data storage systems and are not limited to the particulars set forth herein.

In SAR processing steps described herein various data structures may be used that are stored in the host and or the data storage devices. Information included in these data structures may be communicated to an application using Application Programming Interface API calls. For example in one embodiment a Symmetrix data storage system may include a track status block or table of information regarding the validity of data storage tracks. An API request such as may be included in part of the underlying system software may communicate data included in the table to an executing application. The techniques of providing and storing information used in connection with SAR processing steps may vary in accordance with each embodiment.

Various commands and terms are used herein such as BCVs and associated commands such as ESTABLISH SPLIT RE ESTABLISH and RESTORE are described in U.S. Pat. No. 6 101 497 which is herein incorporated by reference. Additionally the TimeFinder product by EMC Corporation and the CONSISTENT SPLIT CONSISTENT SNAP commands for BCVs are described in U.S. patent application Ser. No. 09 613 118 filed on Jul. 10 2000 which is herein incorporated by reference. CONSISTENT SPLIT operations may also be performed using techniques as described in U.S. patent application Ser. No. 10 134 420 filed on Apr. 29 2002 entitled Method and Apparatus for Enhancing Operations in Disk Array Storage Devices which is incorporated by reference herein. Consistency groups and consistency group trip events are described in U.S. patent application Ser. No. 09 388 328 filed on Sep. 1 1999 which is herein incorporated by reference.

What will now we described is a SAR technique that facilitates setting up and controlling repeated cycles of consistent SPLITs against remotely mirrored BCVs in an RDF configuration. The SAR technique may provide a restartable image of data at a remote site that is as current as possible in the event of a disaster at a production site such as the local storage system. SAR ensures that a dependent write consistent i.e. restartable image of data is perpetually propagated to the recovery site such as a remote storage system in an automated fashioned under the control of the Symmetrix Control Facility SCF address space that may be included for example in the TimeFinder product set by EMC Corporation. These and other components that may be included in a host system are described elsewhere herein in more detail.

It should be noted that SAR techniques that will be described herein may be utilized in connection with a single hop or a multi hop RDF configuration.

When using a multi hop configuration the SAR techniques described herein may be coupled with the consistency group. An embodiment may also use the techniques described in U.S. patent application Ser. No. 10 134 420 filed on Apr. 29 2002 entitled Method and Apparatus for Enhancing Operations in Disk Array Storage Devices in maintaining consistent copies of data. The coupling of the multi hop configuration with the consistency group may be used to create a robust disaster restart infrastructure.

As will be described herein the SAR techniques may utilize the consistent SPLIT functionality which performs a consistent SPLIT across the plurality of devices such as those in a consistency group requested in the same SPLIT command sequence level. The execution of the consistent SPLIT suspends all host I O operations to the devices that are being split. The techniques that will be described herein extend the functionality of this consistent SPLIT functionality by automatically repeating and monitoring consistent SPLIT cycles. Additionally the technique described herein may be used with multiple Symmetrix data storage system configurations.

An embodiment implementing SAR techniques described herein may use processes that each control a group of devices to be SPLIT consistently. Multiple processes may be defined. Each of the named processes which are SAR processes may be started stopped and restarted at particular points in time. The control structures for each of the processes may be retained until the process is deleted. A SAR process may therefore be stopped and restarted sometime later. Control structures necessary for the execution of a particular SAR process may be loaded as each of the SAR processes are restarted for example in connection with performing a context switch of a process. These are described in more detail elsewhere herein.

The data copy created by the SAR processing is a consistent copy. The term consistent as described herein refers to the concept of dependent write I O operations. A dependent write may be referred to as a write that will not be issued by an application unless some prior write I O has completed. Applications such as database management systems DBMS have dependent write logic embedded in them to ensure data integrity in the event that a failure occurs in the host processor software or storage subsystem. For example consider a database update. When a DBMS updates a database it first writes to the disk containing the log. The DBMS then subsequently writes the data to the actual database data set and then again finally writes to the log volume to indicate that the database update was made. These three write I O operations to the log to the database and then once again to the log are related and each I O operation is not issued until the prior I O operation has successfully completed. Consistent split operations as described herein prevent dependent I O operations from being issued by an application during the split process thus ensuring integrity and consistency of the data on the BCV copy. This results in a copy of the data that is restartable or dependent write consistent .

In connection with performing a consistent split as may be executed from the host system using the TimeFinder software commands described herein the TimeFinder software may provide for suspending any host I Os to the entire group of devices as may be included in the same consistency group defined in the same command sequence level execute an instant split of the BCV devices and then release any I Os to the standard devices. In the foregoing SAR configuration the BCVs may also be configured as R devices. After an instant split operation is executed RDF immediately starts an incremental synchronization of the RBCVs with the corresponding R devices. In connection with devices as described herein for one embodiment all devices that are used by a common application are part of the same consistency group. Multiple consistency groups may be defined which may require the use of multiple SAR processes to be defined. This technique may be used when the applications are independent and when the business recovery is not affected by time differences among the multiple consistency groups. When there is an interrelationship among applications or when the business recovery requires a common time of recovery a single consistency group may be considered. It should be noted that a consistency group may span multiple Symmetrix data storage systems and that a single consistency group may be created for an entire production environment.

What will now be described in more detail are steps that may be included in an embodiment of the SAR process. The SAR process may be divided into a series of steps. It should be noted that it is possible to stop a cycle at the end of a step and than later restart from that particular point on. The particular example described in following paragraphs may be referred to as a single hop embodiment rather than a multi hop embodiment which is described in more detail elsewhere herein.

Referring now to shown is an example of data storage systems and that may be included in a computer system. In this example the data storage system may be a local data storage system accessed for example by a host computer not shown . It should be noted that the systems and may also be referred to as respectively source and target data storage systems. The source data storage system may be referred to as having source devices and the target data storage system may be referred to as having target devices. The data storage system may be a remote data storage system that is used as a secondary site for the data contained in the data storage device . R may be the remote device corresponding to the device STD or R in storage system . The data storage system may communicate with data storage system in this and following processing steps using one or more RDF connections .

The first step illustrated by the example is that all source devices are validated. All source BCV pairs are correctly established such that there is an association for example between the STD and the RBCV as demonstrated by arrow . This may be performed using the ESTABLISH command. In one embodiment all source BCV pairs are correctly established if splits are not in progress there are no invalid tracks and the BCV is not held or allocated for another use within the system configuration.

The ESTABLISH command may be characterized as effectively connecting the RBCV as a mirror volume of STD. The RBCV volume synchronizes with the device STD.

Referring now to shown is an example of the data storage system devices and where the target devices are validated such that all target BCV pairs are SPLIT and have a relationship to the STD device specified in the input. For example the device R may be a mirror of the device RBCV. This SPLIT between R and the BCV included in the storage system is illustrated by line . The foregoing step may be performed using the SPLIT command. The SPLIT command effectively unlinks or disconnects the BCV of the system from the device R.

Referring now to shown is an example that illustrates the next SAR step in which a CONSISTENT SPLIT is performed on the source BCVs. This is illustrated by the line which splits the STD from the RLBCV. The CONSISTENT SPLIT operation ensures that a group of BCVs with a common data set or application can be SPLIT with the assurance that the data on all the SPLIT BCV devices will be dependent write consistent and restartable. As described in more detail herein the CONSISTENT SPLIT operation may be used in connection with performing a CONSISTENT SPLIT of a set of devices such that write I O operations to this set of devices are suspended and then a split of the devices is performed. The set of devices may form a consistency group. Although the descriptions herein such as in connection with show only a single device in the systems and this is for illustration purposes. An embodiment may include a plurality of such source and target devices and pairings as described herein in connection with such that for example the operation of a CONSISTENT SPLIT is performed with respect to all the source devices included in the same consistency group.

Referring now to shown is an example illustrating the next subsequent steps in the SAR process in which there is a wait for the source RBCVs to synchronize with the target R device. In this embodiment the devices may transfer data using an RDF connection.

Referring now to shown is an example of the next SAR processing steps where the source BCVs are RE ESTABLISHED for example as indicated by arrow . Additionally the target BCVs are RE ESTABLISHED as indicated by arrow . There is a waiting period within which the R devices synchronize with their BCVs. In other words data is copied from R to R s BCV as indicated in the system where data is copied from device to . A RE ESTABLISH operation enables a reconnection or association of a device such as source device STD and an associated BCV such as re establishing the RBCV s previous mirror status with respect to STD.

Referring now to shown is an illustration of the next steps in the SAR process. The target BCVs are SPLIT as indicated by the line in the system between R and the BCV included therein. Subsequently there is a waiting time period to ensure that the source BCV RBCV is synchronized with STD in the storage system . There is also a waiting time period so that the target BCV mirror synchronization may occur. In other words there may be a wait such that the BCV device may synchronize with its mirror devices.

At this point in processing the current time is obtained for example such as using a system clock and a wait interval is calculated specifying the amount of time until a next cycle of the SAR process may start. A CYCLE TIME specifying a predetermined time interval for a cycle may be specified using a command subscribed elsewhere herein. If the CYCLE TIME specified is greater than the actual amount of time that has elapsed for this current cycle that has just been performed there is a wait interval before the next cycle has begun. However if the specified CYCLE TIME is actually less than the amount of time that has elapsed for processing the current cycle the next cycle may start immediately if so specified for example using command options described elsewhere herein. Otherwise the next SAR processing cycle may start at the next predetermined time interval. The SAR process may be repeated for example as specified in connection with until a STOP command issued or until the number of specified cycles that may be specified in connection with a command described elsewhere herein has elapsed. It should be noted that the STOP command and others are described in more detail in following paragraphs. An embodiment may determine the start of SAR cycle in accordance with other criteria. For example an embodiment may START a SAR cycle when a threshold level number of tracks have changed.

Referring now to shown is a flowchart of steps of the SAR process previously described herein. Generally the steps of the flowchart summarize the steps illustrated in connection with other figures in performing the SAR process. At step a determination is made as to whether processing is complete. Processing may be determined as complete for example if a STOP command has been issued or if a predetermined number of cycles has elapsed. If so control proceeds to step to stop the SAR process. Otherwise control proceeds to step where source and target devices may be validated. This is described for example in connection with in which all source and target BCV pairs are ESTABLISHed.

At step a CONSISTENT SPLIT is performed on the source BCVs. At step there is a wait for the RBCV to synchronize with the R device. In other words data is copied from the RBCV device on the production or local storage system to the remote or secondary storage site having device R. At step it has been determined that the source BCV is ready after the data resynchronization of step has occurred. At step the source BCVs may be RE ESTABLISHed. At step the target BCVs may also be RE ESTABLISHed. At step there is a wait for the target R device to synchronize with the corresponding BCV in the remote target system. In other words within the remote system such as there is a synchronization process that occurs between the R device and its corresponding BCV. Step specifies that control does not proceed to the next subsequent step until these two devices have data synchronization.

At step the target BCVs may be split. At step it is ensured that source BCVs are synchronized. In other words a time period may elapse to ensure that source BCVs are synchronized with the corresponding STD device within a production site or local data storage system such as . At step there may be a wait for target BCV mirror synchronization to occur.

At step the current time may be obtained and a wait interval may be calculated. The wait interval is the amount of time to elapse before the next SAR cycle processing may start. At step a determination is made as to whether the cycle time is greater than the actual time that has elapsed in processing for the current cycle. If the cycle time is greater than the actual time control proceeds to step where processing waits until the next cycle time interval elapses. Subsequently control proceeds from step to step where a determination is to whether processing is complete. If processing is not complete control proceeds to set to begin the next SAR cycle.

If a determination is made at step that the cycle time is not greater than the actual time that has elapsed for the current cycle control proceeds to step where a determination is made as to whether the next SAR cycle should start immediately or wait until occurrence of the next CYCLE TIME. If an indication has been made such as with an IMMEDIATE command qualifier as described elsewhere herein control proceeds to step . Otherwise control proceeds from step to step where there is a wait until the next cycle time interval period. Subsequently control proceeds to step .

The continuous processing of the steps of flowchart provide for repeated cycles of consistent updates to provide a restartable image of data at a remote site that is as current as possible in the event of a disaster of the production site.

Although the SAR process described above included only a single BCV associated with a standard device an embodiment may include and associate a plurality of BCVs with the standard device. Additionally data that is on the remote site may also be further propagated to another site such as in a multi hop configuration. Once data is copied from R to the second BCV on system the second BCV on the remote site may be used as a save point for example in the event of a failure on the production or local site

An embodiment may choose to perform step to wait for a target BCV synchronization at the beginning of the next SAR cycle such as for example prior to completion of step where the source BCVs are re established. In other words rather than stop the processing at step to wait for the target BCV mirror synchronization an embodiment may choose to perform the determination as to whether BCV mirror synchronization has occurred at the beginning of the next cycle rather than hold up the processing of the current SAR cycle such that the BCV mirror synchronization is determined as complete prior to re establishing the source BCVs in connection with step

It should be noted that an embodiment may perform the steps of in a different order. For example an embodiment may choose to perform step prior to step . An embodiment may also choose to perform step prior to step

Referring now to shown is an example of the system of a multi hop configuration . shows a multi hop configuration that may use consistency group technology to provide protection of the production site in an offsite secondary site or bunker site . This may be used to ensure the integrity of production data at the secondary or bunker site during a production site disaster. SAR processing may be configured controlled and monitored by a host connected to the production site but is managing the SAR process operating between the secondary and target sites. This may be achieved using the multi hop command support across links A A B and B. This technique and configuration provides for consistent restartable copies at a remote restart site cyclically using RDF adaptive copy techniques and CONSISTENT SPLITs of the remote BCVs in the bunker site . BCVs at the target site provide protection during the adaptive copy session between the secondary and restart site by ensuring preservation of restartable image of the data.

In the event of a consistency group trip event the secondary or bunker site contains a consistent restartable image of the production site on the Rs. A final split of the secondary site RBCVs followed by their resynchronization to the Rs at the restart site produces a restartable environment at long distances with data current to the point of disaster. A consistency group trip event may be characterized as a result of a failure to remotely mirror an I O operation on a consistency group protected volume marking the beginning for example of an unplanned outage.

The ability to produce consistent point in time copies of information spanning multiple volumes as well as multiple data storage systems such as multiple Symmetrix data storage systems is important to business continuance. This capability is provided through the CONSISTENT SPLIT command as described elsewhere herein. Creating a consistent copy of all the necessary data objects provides the restartable image on remote BCVs. In one embodiment a batch interface may be included in the TimeFinder software and may be used to create consistent restartable images one at a time. It may be desirable for an embodiment to perform this process in an automated fashion to provide for the continual creation of consistent copies of data as may be achieved with automation support.

Accordingly what will now be described are different commands that may be used in connection with performing the foregoing SAR process steps for example to define volumes to be managed specified cycle characteristics and provide for cycle control and querying. These commands may be included in an embodiment s job control language JCL using any one of a variety of different format and parameters. Although a particular embodiment and associated commands will now be described it should be noted that an other embodiment may include different commands as well as different formats.

Referring now to shown are three commands that may be used in implementing the SAR process described herein. The ADD command defines the process name used to control the SAR processing amongst one or more devices. In one embodiment for example there may be a process name associated with single hop mode processing and multi hop mode processing. If the process name is already defined within an embodiment the ADD request statement may be rejected. It should be noted that in one embodiment the ADD command does not actually start the process but rather only defines the name and processing type to the EMC Symmetrix Control Facility SCF address space that is shipped with the TimeFinder product set as described elsewhere herein.

What will now be described are various parameters that may be associated with the ADD command as shown in . The process name as specified sets forth the name of the process. In one embodiment a maximum number of 20 characters may be used however another embodiment may include another maximum number of characters for the process name. HOP type specifies the type of long running process to be defined to EMCSCF. The two options in one embodiment are SINGLE and MULTI to correspond to the single and multi hop modes. MAXGRP specifies the maximum number of SAR processes. MAXDev specifies the maximum number of SAR devices for each controller and MAXMsg specifies the maximum SAR message buffers. It should be noted that these parameters as well as others described herein may have default values. For example in one embodiment MAXGRP may be a value between 1 and 9 999 having the default value of 64. MAXDev may be a value between 1 and 64 000 having the default value of 4 096. MAXMSG may be a value between 1 and 9 999 having the default value of 256.

The DELETE command removes a particular process name from EMCSCF. The process name is in a stopped state for the command to function otherwise it may be rejected in one embodiment.

The MODIFY command includes the following parameters that will now be described process name DEFINE RESTART START STOP and QUERY. The process name specifies the name of the process to which this command applies. If the name is not defined the statement fails. In one embodiment only a single START RESTART or STOP action is allowed on a single sequence level. Sequence level numbers may be used to control parallelization of command processing as may be included in the TimeFinder product by EMC Corporation.

The DEFINE parameter or action defines the devices and attributes of the process. As many DEFINE actions may occur for a process as required to define the total set of devices to be operated upon by the process. Device lists in one embodiment may not span data storage systems such as Symetrix data storage systems. If multiple data storage devices are used to create a restartable remote image multiple DEFINE actions with device lists for each Symmetrix data storage system may be used. To change a configuration in one embodiment the configuration may be deleted and then redefined to the desired configuration. The last setting for CYCLE CYCLE Overflow and TIMEOUT on a DEFINE action are used. The DEVice list parameter includes the SRCRLBCV specifying the source BCV devices. SRCSTD specifies the standard devices. TGTBCV specifies the target BCV data storage system devices. Cuus specifies a BCV device and cuus cuus specifies a range of BCV devices where the first cuus is the starting BCV device and the second cuus specifies the last BCV in the range. It should be noted that in one embodiment the entire range of BCV devices is included in the same physical control unit. or data storage system such as with reference to . Cuup specifies a standard device and cuup cuup specifies a range of standard devices similar to the cuus cuus range described above. Cuug is an optional parameter that may be used to specify an alternate device to issue the commands against. Seq specifies a sequence number that is a decimal number 1 128 that indicates in what order the specified command is executed. All actions having the same sequence level may be executed in parallel in one embodiment having this capability. Symdv specifies the Symmetrix data storage system device number. In one embodiment this is a 4 digit value. Symdv Symdv specifies a range of Symmetrix system device numbers. CYCle may be used in defining the cycle time and optionally the number of cycles to perform. The cycle time specifies the time frequency for starting each cycle of a process such as every four hours. If the actual cycle time exceeds the cycle time the CYCle Overflow action may be used to specify the desired behavior. If the number of cycles to be performed is specified as 0 or left unspecified then the cycle process runs until a STOP command is issued. To run a SAR process indefinitely for example in one embodiment the following may be used CYCLE 00 00 00 0 CYCLE OVERFLOW IMMED . CYCle Overflow specifies processing behavior when a cycle actually takes longer than the time specified in the cycle time. NEXT specifies a wait time until the next calculated cycle time to begin a new cycle. IMMED specifies that a new cycle is to be immediately started after conclusion of the current cycle. The start time of the new cycle is the basis for the next calculated start time. TIMEOUT specifies the maximum amount of time to hold I O processing during consistent split processing. In one embodiment the timeout may be specified in seconds. If the maximum timeout specified is exceeded then the process is stopped and a message is issued. If this occurs only the BCVs at the secondary or remote site contain consistent images of the last successfully completed cycle and intervention may be needed. RESTART may not be available under this condition. The process should have a new START action issued. In one embodiment the default TIMEOUT is 15 seconds. MSGOPT specifies message handling options. BUFfered holds messages in the memory buffer. The messages may be displayed using the QUERY statement. WTO nn optionally issues the text as a Write to Operator with the optional route code nn. If WTO is specified without a route code a default of 11 is used. In this particular embodiment a routing code of 11 may be used to indicate that messages are routed to the master console. However an embodiment may alter the assignment of routing codes for example in accordance with installation options providing a way to change the routing assignment.

The START action begins the process at the beginning of the cycle. In connection with the STOP action NORMAL specifies that the cycle continue until it reaches the normal end of cycle. STEP specifies stopping the cycle when the current cycle step completes. FORCE specifies immediate stop regardless of the state of the cycle. The process is active for the STOP to take effect. RESTART restarts a stopped process. The RESTART point is determined by the STOP request. If the STOP action specified FORCE restart may not be possible. In connection with the QUERY action STATUS specifies to display the cycle step cycles performed changed track accumulation current settings etc. DEVices displays the list of devices defined to the process. MSG lists message buffers associated with the process. After an MSG display the message queue may be emptied. The process specified may be active or stopped.

Referring now to shown is an example of an embodiment of the STOP command . Jobname specifies the EMCSCF jobname SAR specifies the SAR facility and process name the SAR process defined by the ADD command described elsewhere herein. Also shown in is the STOP parameter to indicate STOPping the specified process at the completion of the current cycle. STEP indicates that the process is to be stopped at the end of the current step. FORCE stops the specified process immediately.

What will now be described are some examples of the foregoing commands used in connection with the SAR process. Consider the following sequence of commands that may be used in connection with defining a SAR process in connection with the embodiment set forth in 

The ADD statement at sequence level creates a new process named PROCESSONE. Devices in data storage system SYMM are specified in the device list of the first MODIFY statement at sequence level . The standard devices at addresses A through A and their respective RBCVs on addresses A through A are protected on the BCVs in the remote data storage system SYMM. The Symmetrix data storage system device numbers identify these BCVs. Similarly the standard devices on the data storage system SYMM on addresses B through B and their respective RBCVs on addresses B through B are also protected on the BCVs in the remote SYMM. As described and used elsewhere herein protected refers to having a replicated or backup copy of data. Since the SRCRBCV specifies RBCV devices the RA group used to send remote commands is known. RAs are shown in as . Additional elements that may be included in a data storage system such as described previously in connection with have been omitted for sake of clarity but may also be included. Cycle 0 specifies that the process will run until an explicit stop is issued for the process. Each subsequent cycle begins immediately after the previous one has completed. The timeout value of 15 seconds specifies that maximum time I O is held waiting for the consistent split command to complete. The START statement at sequence level begins the process PROCESSONE.

In the foregoing example it should be noted that if the timeout value is exceeded the process stops with an error. If this does occur the consistent splits did not complete within the allotted time. The consistency of the local BCV data in this example cannot be determined without user intervention. Valid data is at the remote the BCVs from the previous successful SAR cycle.

Referring now to shown is an embodiment of a system that may be used in connection with the previous example command sequence in which one remote Symmetrix data storage system SYMM is used to protect standard devices in two local Symmetrix data storage systems SYMM and SYMM.

In an embodiment using the foregoing commands the following may be submitted in a job to issue MODIFY PROCESSONE STOP

To determine if the process PROCESSONE is stopped one or more jobs may be run issuing the following MODIFY PROCESSONE QUERY STATUS 

Using the foregoing sequence of commands the process is stopped and queried for its status and then the process is RESTARTED.

The foregoing commands stop and delete the PROCESSONE process. PROCESSONE is redefined as in another example described elsewhere herein in but with one additional volume on local SYMM identified as A. After the process is started queries are issued one for any outstanding messages from the process and one for the status of the process.

Referring now to shown is an embodiment of system that may be used in connection with the foregoing sequence of commands. The system is similar to that as set forth in with the additional local STD volume noted as in of the system .

The SAR process provides for propagation of data changes from a local system such as from device RLBCV in to a remote system such as on device R. Subsequently the data from the device R may be copied to another BCV such as in system to create a next save point for the data which may also be further propagated.

An embodiment may choose to execute the SAR process cycle steps causing a data replication to occur at various points in time or in response to certain predefined conditions. For example using the foregoing CYCLETIME an embodiment may cause a SAR cycle at predetermined time periods. An embodiment may trigger a SAR cycle in response to a threshold level of data changes occurring such that the SAR cycle may be triggered in response to for example a number of write operations the amount of changed data tracked by a data storage system such as and the like.

Referring now to shown is an example of software that may be included in a host computer system such as one of the hosts included in the system of and as described elsewhere herein.

Included in the example is an area of common memory an SCF or Symmetrix Control Facility a SAR plug in and TimeFinder software . Additionally residing on a host may be other client software . The other client software may vary in accordance with each particular embodiment. The common memory or storage area may include memory storage of those data structures such as control blocks used in connection with executing the SAR processing described herein. In this particular embodiment the SAR plug in runs in the SCF process address space . It should be noted that in this particular embodiment the SAR plug in may include machine executable instructions that control the SAR processing as described elsewhere herein.

The SAR plug in may begin execution and invoke the TimeFinder software to create and initialize data structures included in the common storage in accordance with various commands to define the SAR processing steps. The TimeFinder software includes the machine executable code to define SAR processing commands for example START RESTART and QUERY as described in connection with . Once the various commands as defined in accordance with the SAR plug in have been set up by the TimeFinder software the TimeFinder software may be unloaded and control may be passed to the SCF Software . The SCF Software may execute the SAR processing steps as set up and initialized by the SAR plug in and the TimeFinder software. In other words the SAR plug in and the TimeFinder software may be characterized as initializing and setting up the necessary commands for SAR processing. When control is transferred from TimeFinder software to the SCF the actual SAR processing steps described for example in connection with are executed.

An embodiment may also implement functionality described herein in connection with SAR processing using alternatives to the SAR plug in . An embodiment may use automation tools such as a scripting or job control language that may vary with the availability in each embodiment and command functionality available for use with the TimeFinder product. Such tools and languages may include for example REXX as available on the MVS OS 390 and z OS operating systems by IBM Corporation and the Perl programming language. The TimeFinder product by EMC Corporation includes commands such as for example SPLIT RESTORE ESTABLISH and RE ESTABLISH. These TimeFinder commands and a command programming or scripting language may be used to implement the functionality described herein for SAR processing in an embodiment using the Symmetrix data storage systems.

It should be noted that in connection with SAR processing data being copied from a local storage system such as to the remote storage system may be copied a first time such that all of the data is copied initially from the local storage system to the remote storage system . If there are other intervening nodes or data storage systems between the local system and the remote system the first time data is copied to the remote system a complete set of data is copied. Additionally other steps may also be performed such as configuration checking and the like the first time data is copied to the remote system . The first or initial push of data to the remote storage system may also be referred to as initialization or initializing the system as used in connection with a SAR process with data. In subsequent SAR processing steps an embodiment may copy the data which has been changed or modified. This may be referred to as the continuous SAR processing cycle. The continuous SAR processing cycle may be characterized as a system in a steady state. All of the data may be copied at the initialization stage. Subsequently a certain amount of data may be modified in accordance with a particular time period and this amount of data may then be propagated through the system rather than for example copying all of the data as in the initialization stage.

It should be noted that although a local and remote storage system have been described the techniques described herein in connection with SAR processing may also be applied to the local storage system and the remote storage system with one or more intervening storage systems or nodes therebetween. In other words data may be propagated from the local to the remote storage system through one or more intervening nodes within the data storage system as described for example in connection with the system of . Thus in propagating data from an initial local storage system to disaster recovery site the SAR processing steps may be executed multiple times between different intervening nodes to propagate data to the remote storage system. In one embodiment the host may control the SAR processing by issuing commands directly to both the local and the remote storage system as well as intervening nodes. The host may issue such commands for example using the multi hop system call as described in U.S. patent application Ser. No. 09 591 827 filed on Jun. 12 2000 entitled Multihop System Calls which is incorporated by reference herein.

When performing the system restart for example in connection with part of the going home processing to return to the primary or local site an embodiment may select to run in protected or unprotected mode. An embodiment running in protected mode may be characterized as running with a back up copy of data. In contrast running in unprotected mode means running without a back up copy of data. This distinction is described elsewhere herein.

As described in more detail elsewhere herein an embodiment running in a multi hop configuration may run in unprotected mode after restarting at the remote site. This is because running in protected mode requires an intermediate site near to the remote site so as to enable a new multi hop configuration with the primary site acting as a new remote site. Such an additional fourth site may not be available. If such an additional fourth site is available an embodiment may run in protected mode after restart at the remote site by defining a new SAR process.

The foregoing provides for data replication. If there exists a failure for example of the local system there may be a need to perform a system restart making the SAR restart volumes available for use.

Referring now to shown is an example of an embodiment illustrating a disaster as may occur on the primary or production site. In the event of a production site disaster it is assumed that the host system has failed as well. A remote system such as may be used in connection with performing the restart operations. The remote host may be connected to the target site and is able to communicate to data storage systems in performing the restart processing described elsewhere herein.

Software included in a host computer system such the EMC SRDF Host Component makes the restart site available by issuing commands to change the states of remote volumes. The foregoing SAR process as may be included in the TimeFinder product creates point in time consistent copies of volumes. First it is decided as to whether the data recovery and subsequent restart operations use the R devices or their partner BCVs as included in the system for example. It may be necessary to determine the current state of the R and its partner BCVs. This may be determined for example by executing QUERY commands from a remote host using the TimeFinder product by EMC Corporation. An embodiment may select the device having the most current data. The most current data location may vary depending on whether there is a multi hop or single hop embodiment. In a multi hop embodiment as described elsewhere herein in more detail the most current data is included in the bunker or secondary site.

If the device R in the remote site is selected as the start point data may be RESTOREd from the partner BCV to R. In an embodiment it may be preferred to use a particular one of the R and its partner BCV as the restart. For example in one embodiment it may be preferred that the R device be used as the restart device due to other ongoing operations in accordance with a particular embodiment. The BCV devices may be used in connection with performing other operations such as in connection with other software that may be included in the host system. An embodiment may select to start off of the R devices for example since it may be easier to set up a reverse SAR.

Once the restart device R or associated BCV are determined the SAR configuration may be in one of 3 possible states as a result of the SAR processing described herein. Each of the different states may utilize a different recovery procedure as described elsewhere herein as PROCEDURES . A first state is that all the target R devices are SPLIT from their partner BCV device PROCEDURE . A second state is that none of the target R devices are SPLIT from their partner BCV device PROCEDURE . A third state is that some of the R devices are SPLIT from their partner BCV device PROCEDURE .

It should be noted that the 3 SAR recovery procedures for each of the three states above may be tested by causing any one of the three states to occur by issuing commands as follows 

MODIFY STOP NORMAL issued to a SAR process results in an ALL SPLIT state on the target or remote data storage system since the SAR process continues to the start point for a new cycle.

MODIFY STOP STEP issued to a SAR process results in ALL or NONE SPLIT state depending on which step is executing at the time the command is issued.

To create the some SPLIT state on the target or remote data storage system some RDF links may be taken offline such as by executing a host component command during step of the SAR process such as at step while target R volumes are being RE ESTABLISHED with their BCV mirrors.

The following procedures utilize commands issued either at the host with access to the source STD device or at the host with access to the target R devices. An embodiment may also include an option for redirecting commands across an RDF link using the RMT command providing the benefit that all commands may be entered from the same host and redirected as appropriate to remote data storage systems.

Prior to executing any of PROCEDURES steps may be taken to determine the state of all BCV volumes as INUSE or AVAILable at the restart site which in this example is the remote site . This may be performed using commands of the TimeFinder product running on a remote host. Additionally any data storage system locks associated with SAR devices may be cleared. When an RDF link failure interrupts a SAR process the devices at a RESTART site such as may be marked as still belonging to the SAR process. Since the SAR process is no longer executing upon failure TimeFinder located on the remote host may be notified and made aware of the SAR configuration. In one embodiment this may be performed by having the host query all data storage system control units. Each data storage system such as a Symmetrix data storage system previously described in connection with may include information about the SAR configuration. For example the data storage system may store SAR configuration information in a portion of its global memory such as a cross system communication area. The configuration information may identify which particular devices for the data storage system are involved in the SAR configuration as well as what additional data storage systems such as and are also involved. Using this information as may be stored in each data storage system the SAR process executing on the remote host may be used to query each individual data storage system to determine the data storage systems and their devices and volumes used in the SAR configuration. Other embodiments may store this information in other locations and utilize other techniques to determine the SAR configuration using the remote site. It should be noted that this determination may be automated by having a process automatically generate the commands to query and retrieve data from each data storage system.

Depending on the value of the status bits for the BCV devices at the restart site which may be in this example a different one of other procedures may be executed in accordance with the three states.

Referring now to shown is a flowchart of steps of one embodiment for performing steps as described above where the BCV state determination is made of BCVs in the restart site. At step status bits for all BCVs are obtained. At step a determination is made as to whether all the bits indicate that the BCVs are all available. If so control proceeds to step where it is determined that all the BCVs are SPLIT in accordance with the BCV status bits. Control proceeds to step where PROCEDURE is called. Otherwise if at step all status bits do not indicate that all BCVs are available control proceeds to step where a determination made as to whether all the bits indicate that all the BCVs are USE. If so control proceeds to step since this indicates that all BCVs are ESTABLISHED or in the process of being ESTABLISHED. At step PROCEDURE is invoked. Otherwise if at step all status bits are not INUSE control proceeds to step since this indicates that the some BCVs are ESTABLISHED and some are also SPLIT. At step PROCEDURE is invoked. Additionally it should be noted that links to the R volume may be offline to prevent the local system RBCV from inadvertent resynchronization.

If PROCEDURE is selected such that all target R devices are SPLIT from their BCVs the SAR step being executed when failure occurred was synchronizing the local or production site s RBCV with the restart site s R. If the synchronization is complete such as may be determined where there are no invalid tracks on the R devices indicating that data is yet to copied to R from RBCV the R device holds the most recent point in time consistent copy. If any one of the R devices has an invalid track then R s partner BCV on holds the most recent point in time consistent copy.

Referring now to shown is an example of an embodiment of a flowchart of steps of an embodiment of the PROCEDURE as may be executed from a host at the restart site. At step a determination is made as to whether the restart device is the BCV or R. If the restart device is the BCV control proceeds to step where a determination is made as to whether there are any invalid tracks on R. If there are invalid tracks on R control proceeds to step since R s BCV has the most recent copy. At step R s data is restored from it s partner BCV such as using the RESTORE command. There is a WAIT until R and its BCV are resynchronized. Control proceeds to step where R and its partner BCV are SPLIT. Now R and its BCV contain the same set of data and are SPLIT such that the BCV may be used for RESTART operations.

If at step it is determined that no R device has any invalid tracks control proceeds to step . At this point R has the most current copy of the data. At step R and its BCV are RE ESTABLISHED such that R data is copied to R s BCV. At step there is a wait for R and its BCV to synchronize. This state may be detected for example by using a QUERY command to examine track status information about the devices. In one embodiment a QUERY command issued by a host may return track status information. The tracks of the devices may be synchronized when there is an invalid track count of 0 and a status of INUSE for R s BCV. This information may be stored for example in an invalid track table which may be obtained using function calls in accordance with defined APIs application programming interfaces . Control proceeds to step where R and its partner BCV are split and the BCV is ready for RESTART.

If at step a determination is made that the restart device is R control proceeds to step where a determination is made as to whether there are any invalid tracks on the R device. If there are invalid tracks control proceeds to step where data is RESTOREd from R s partner BCV. Once the data has been RESTOREd to R control proceeds to step where R is SPLIT from its partner BCV. Once R is read write enabled with the SRDF Host Component R devices are ready for RESTART.

If at step a determination is made that R has no invalid tracks control proceeds to step where the connection between R and its partner BCV are RE ESTABLISHED. At step data is copied from R to its BCV partner. Control proceeds to step where R and its partner BCV are SPLIT. The R device is ready for RESTART.

PROCEDURE is executed if none of the target R devices of the remote system are SPLIT from their partner BCV such as may be indicated for example by a status of INUSE at the time of failure the SAR step that was executing when failure occurred was synchronizing R and the partner BCV. Once the synchronization is complete between R and its partner BCV such that the devices are fully established both R and the BCV hold the most recent point in time copy of data.

Referring now to shown is a flowchart of steps of an embodiment for PROCEDURE . At step there is a wait for R and its BCV to synchronize. This may be determined in one embodiment using a QUERY command that may be issued from a host to receive device information such as which tracks of the BCV are still invalid. When there is an invalid track count of 0 and a status of INUSE the synchronization is complete. Other embodiments may use other techniques in performing this and other processing steps. At step R and its partner BCV may be SPLIT. At step a determination is made as to whether the restart device is R or its partner BCV. If it is the BCV control proceeds to step where the BCV is used in the RESTART. Otherwise control proceeds to step where the R device is used in the RESTART.

PROCEDURE may be executed if it is determined that some of the target R devices are split from their partner BCVs indicating that when failure occurred the SAR step executing was splitting or re establishing R and its partner BCV. This command may have been issued to a subset of the control units. SPLIT commands are issued to the remote BCVs by the SAR process to preserve a restartable copy that has been successfully propagated to the R device. The most recent restartable copy of data in this instance is on R when only some of the BCVs are in an AVAIL status such as when control is passed to PROCEDURE .

Referring now to shown is a flowchart of steps of one embodiment of PROCEDURE . At step all BCVs having an AVAILable status are RE ESTABLISHED with their R partners. At step there is a wait for the data synchronization to complete with the BCVs having a status of INUSE. At step R and its corresponding BCV are SPLIT. At step a determination is made as to whether the RESTART device is the BCV. If so control proceeds to step where the BCV is used as the RESTART device. Otherwise control proceeds to step where the R device is used as the RESTART device. It should be noted that in the instance where the R device is selected for RESTART step may be omitted and performed if a copy of the data at this point in time is desired for future use.

The foregoing describes how to use the save point data in a remote or recovery site in the event of a failure of a production or local site for a system restart operation. In other words while the SAR process steps are being executed there may be a failure on the production site and the foregoing sets forth the steps that may be performed in an embodiment in connection with recovering a recent consistent set of data. The foregoing describes how to make the data available for example in connection with recovery operations.

An embodiment may also use the recovery site as its new or temporary primary site. In this instance the recovery site effectively functions as the previously described primary site. For a single hop the primary site may effectively function as the new or temporary recovery site. The primary and recovery sites may be reconfigured accordingly as described in following paragraphs and the SAR process may be performed once this reconfiguration is complete. At this point the SAR processing may be characterized as a reverse SAR process with respect to the direction in which the data is propagated.

What will now be described are general processing steps that may be included in an embodiment when there has been a failure detected at a production site such as the local system described elsewhere herein in connection with other figures. What is described herein is a process that may be used in an embodiment for performing data replication such as may be included in a disaster or recovery site used when a production site becomes unavailable or goes off line such as for example when a disaster occurs at the local system . Once a disaster occurs such that the production site is off line or unavailable a backup copy of replicated data may be made available in connection with restarting data operations in a computer system such as the system of described elsewhere herein. As part of the restart process the state of the system may be assessed to determine where a most recent copy of data exists. This is described elsewhere herein based on the states of the different devices of the different data storage systems such as the remote storage system . Once this has been determined the replicated or backup data volumes formed through the SAR processing steps are used in restarting data operations in a system from a particular point.

In connection with performing a restart operation data operations may be restarted off of either the R or the BCV device of the recovery site such as the system . Once the system restarts using either the R or BCV device of the recovery site the techniques that will now be described may use data from the disaster recovery site to resume SAR processing with a goal of returning home to the local or production site. In other words the techniques that will be described in following paragraphs restart data operations from a particular point using the disaster recovery point as our new or temporary production site. SAR operations may be resumed and processing may be continued with the intent of restoring a system configuration with the original production site running as the main or local system

Referring now to shown is a flowchart of steps of an embodiment where a restart operation is performed in connection with performing reverse SAR processing in a going home scenario such that the production site may resume operations.

At step a determination is made as to whether an embodiment executes with a backup copy of data and hence be in a protected mode. If a determination is made at step that there is a current protection mode desired control proceeds to step where a determination is made as to whether the restart operation is using the R or the BCV device as the restart device. If a determination is made at step that the BCV device is being used as the restart device control proceeds to step to perform a reconfiguration of various devices included in the remote and local system are performed using the BCV as the restart device. The reconfiguration at step may be characterized as reconfiguring devices in connections included in the remote and local system such as and such that reverse SAR processing may be performed using the remote system such as as the starting point of the SAR processing reaching an end point which in this instance may be the production site such as the local system . Control proceeds to step where the SAR process as may be included in a host system is redefined to execute using the recovery site as the starting point and the primary site or local storage device as the end point. An initialization procedure is performed to initially copy data from the starting point through the system beginning with the recovery site to the primary site as the target and restart the SAR processing steps to further propagate copies of data to the original production site while maintaining a protected copy. At step SAR processing may be shut down and there is a return to using the primary site as the new start point in the SAR processing. At this point control proceeds to step where the various devices included in the system of data storage devices such as the local and remote data storage systems and respectively are reconfigured such that the system once again performs SAR processing originating from the production site. Subsequently control proceeds to step where the initialization procedure is performed again and the SAR processing is resumed using the primary site as the start point.

If at step a determination is made that the R device used on the recovery or remote system is to be used as the restart device control proceeds to step where a reconfiguration is performed of the various devices and connections therebetween. This reconfiguration at step may be characterized as reconfiguring the various devices within the data storage system such as the remote and local data storage systems respectively and to use the disaster recovery site such as the remote data storage system as the start point with the production site or the local data storage system as described herein as the end point. Control proceeds to step where the SAR process as may be included in a host system is redefined to execute from the recovery to the primary system in accordance with the configuration performed at step . Subsequently the initialization procedure is performed by initially propagating data through the system from the start point to the end point and SAR processing is restarted. Control proceeds to step where there is a shutdown of the SAR processing and a return to the primary or production site. At step the system is accordingly reconfigured such that the SAR processing may resume using the primary site or production site such as the local system as the start point. Control subsequently proceeds to step .

If at step a determination is made that there is no protection mode with no replicated data copy control proceeds to step where a determination is made as to whether the R or the BCV device is used as the restart device. If at step a determination is made that the BCV device is used as the restart device control proceeds to step where data is sent back to the production or primary site. Subsequently the recovery site or system such as is shut down and a return is made to the primary system using the BCV as the starting point. Subsequently control proceeds to step where a reconfiguration of the primary site for SAR processing based on using the BCV as the restart device with the no protection may be performed. Control subsequently proceeds to step to initialize and start SAR processing from the primary or production site such as the local system

At step if a determination is made that the R device is used as the restart device control proceeds to step where data is sent or propagated to the primary site. Subsequently the recovery site is shut down to return to the primary or production site. This is performed by using the R as the starting point. In this embodiment no reconfiguration is needed when no protection is selected unless dynamic RDF is used to return to the primary site. Control proceeds to step where the initialization procedure is performed and SAR processing is resumed beginning at the production site such as from the local system

In connection with shutting down the SAR process running in the reverse direction and returning to the primary site such as in connection with the processing steps of and applications on a host system may be shut down for example such that data operations do not continue. Using various commands such as the STOP and START commands described elsewhere herein the host may stop SAR processing which is running currently in the reverse direction. Any data which is in the data pipe running from the recovery site to the production site is propagate to the end point or to the production site to empty or drain the data pipe . Subsequently the STD and the RBCV of the recovery site are now split.

Referring now to shown is an example illustrating a first step in reconfiguration for performing the reverse SAR. The recovery BCV is reconfigured as the RBCV.

Referring now to shown is an example illustrating a second step in reconfiguration for performing the reverse SAR. The primary RLBCV is reconfigured as the remote or recovery R device.

Referring now to shown is an example illustrating a third step in reconfiguration for performing the reverse SAR. The primary STD is reconfigured as the BCV for R in the new or temporary remote recovery site.

Referring now to shown is an example illustrating a fourth step in reconfiguration for performing the reverse SAR. The recovery R is reconfigured as the STD device.

Referring now to shown is an example illustrating a fifth step in reconfiguration for performing the reverse SAR. The link configuration among the devices is altered. Farpoint configurations may require a director swap in addition to a device swap. This reconfiguration may be performed using technology included in the RDF product as available by EMC Corporation using a remote host system. Other embodiments may use other reconfiguration software for example that may be included on the remote host. The new STD device is configured to use its newly designated BCV as a mirror as indicated by arrow . The newly designated RBCV is linked to the newly designated R as indicated by arrow . The newly designated R is linked to its newly designated BCV as indicated by arrow . At this point the SAR process is redefined to perform the SAR processing steps from the previously designated recovery site to the primary or local site

Referring now to shown is a flowchart of an embodiment of more detailed processing steps for previously described step for reconfiguring and performing the reverse SAR process. This flowchart summarizes steps just described. At step the recovery BCV is reconfigured as the new RBCV. At step the primary RBCV is reconfigured as the new R. At step the primary STD is reconfigured as the new BCV for the new R. At step the recovery R is reconfigured as the new STD device. At step the device link configuration is altered. In one embodiment this configuration may be altered for example by modifying a configuration file by a customer service agent. At step the SAR process is redefined to execute propagating data from the previous recovery site to the previous primary site beginning with R. At step the SAR process steps are executed in the reverse direction.

It should be noted that the foregoing provides for reconfiguration and performing the reverse SAR processing using R as the starting point. The BCV in the recovery site may also be used as the starting point rather than R. If using the BCV as the starting point for the reverse SAR the reconfiguration just described is different.

Referring now to shown is a flowchart of one embodiment of more detailed processing steps for step for reconfiguration and performing reverse SAR processing. At step the recovery BCV for R is reconfigured as the new STD. At step the recovery R is reconfigured as the new RBCV. At step the primary RLBCV is reconfigured as the new R. At step the primary STD is reconfigured as the new BCV for R. At step the link configuration between devices is altered to provide data connections between devices to function in accordance with the new configuration. At step the SAR process is redefined to propagate data from the recovery site to the primary site. At step the reverse SAR process is started.

Referring now to shown are more detailed processing steps of step previously described in connection with flowchart of . At step the primary BCV is reconfigured as the STD. At step the primary R is reconfigured as the RBCV. At step the recovery STD is reconfigured to be the R device. At step the recovery RBCV is reconfigured as the BCV included in the remote or recovery site. At step link configuration is altered such that the links between the various devices are accordingly established. This is described in more detail elsewhere herein. At step applications at the primary site are started such that data operations may resume. At step the SAR process is redefined to run from the primary site as the start point using the recovery site as the end point. This redefinition within the SAR process may be done using commands such as those described herein issued by the host. At step the system is initialized with data such that data is propagated from the start to the end point such as from the primary to the recovery site in this example and SAR processing is resumed.

Referring now to shown is a flowchart of more detailed processing steps in one embodiment for step described in connection with flowchart of . At step the primary BCV is reconfigured as the STD. At step the primary R is reconfigured as the RBCV of the primary site. At step the recovery STD is reconfigured as the BCV of the recovery site. At step the recovery RBCV is reconfigured as the R device. The processing steps and respectively are similar to processing described in connection with steps and of flowchart .

It should be noted that the reconfiguration of the different devices as described herein may be performed using a variety of different techniques that may vary in accordance with each embodiment in the hardware and software residing therein. For example in one embodiment the reconfiguration of the devices may be performed by modifying configuration data as may be included in a configuration file stored in global memory of each of the data storage systems. A reconfiguration such as this may be defined in accordance with a static reconfiguration file. Another embodiment may perform the reconfiguration of the various devices by using techniques as described in connection with dynamic RDF as described in pending U.S. patent application Ser. No. 09 997 810 filed on Nov. 30 2001 entitled Dynamic RDF which is incorporated by reference herein. As described in the Dynamic RDF devices may be deleted and created in pairs using the delete pair and create pair commands executed by a host. Additionally using the Dynamic RDF techniques a dynamic configuration file may also be used rather than require static reconfiguration such as by modifying a system configuration file. It should be noted that other systems may include other types of files and use different techniques that may be used in connection with system configuration and the reconfiguration thereof to perform the processing steps described herein.

Referring now to shown is a flowchart of steps of one embodiment providing more detail of the processing steps associated with as described in connection with flowchart of . Generally the flowchart describes more detailed processing steps that may be included in an embodiment where there is no protection and the BCV has been selected in connection with performing the restart operation. The processing steps set forth in more detail sending data back to the primary site in order to return home to begin processing again from the initial primary or production site such as the local system . At step portions of data may be copied from the recovery site to the primary site while the recovery site is still up and running and applications are still executing. In one embodiment this may be performed for example as a background task without shutting down all operations of applications and data operations. At step a determination is made as to whether a predetermined or threshold amount of data has been copied or propagated from the recovery site to the production site. If this threshold has not been reached control proceeds to step where the data portions are continually copied until a threshold amount of data has been copied to the production site from the recovery site. Once this predetermined amount of data has been copied control proceeds to step where applications at the recovery site may be shut down. In other words applications performing data operations such as to the recovery site which is now acting as the temporary primary site may be halted in order to make the switchover to the primary site for going home. Control proceeds to step where the remaining data is copied from the recovery R to the RBCV device at the primary site. Subsequently control proceeds to step where data is restored from the primary RBCV to the STD device at the primary site. Subsequently at step applications may be restarted on the primary site.

It should be noted that the foregoing steps described in connection with the flowchart detailing more processing steps for step may be characterized as propagating data from the recovery site back to the production site while the recovery site is still up and running to process data operations. When the data propagation from the recovery site to the primary site reaches a predetermined level or threshold data operations on the recovery site may be shut down such that the remainder of data currently in the pipe being propagated may be pushed over to the production site akin to a pipe or data pipeline being emptied. At this point the primary site may resume its processing once data is synchronized. Alternatively an embodiment may choose to propagate data from the recovery site to the primary site using different techniques. For example and embodiment may choose to shut down the recovery site propagate or copy all of the data from the recovery site to the primary site prior to bringing up applications on the primary site. In other words data propagation from the recovery site back to the production site may not be performed piece meal while the recovery site is up and running. An embodiment may also determine that data is copied or synchronized between devices in accordance with an invalid track count table indicating any differences in data between devices. In accordance with the technique and steps described in connection with flowchart for example an invalid track table may be used to indicate which tracks or portions of a device differ from another device. An invalid track table may be used for example to indicate which portions of data have yet to be copied from one device to another device. This technique is described elsewhere herein in more detail. Other embodiments may use other techniques in connection with data propagation from one device to another as well as in propagating data from the recovery site to the primary site.

In connection with detailed processing of step the defined SAR processing steps for example as may be defined by the host system using commands described elsewhere herein is reconfigured such that the SAR processing steps described elsewhere herein propagate data once again from the primary site or production site to the remote or disaster recovery site. After the data restoration to the primary site is complete the system of the SAR processing may be initialized and again resume SAR processing from the production site to the disaster recovery site.

Referring now to shown is a flowchart of more detail processing steps of step previously described in connection with flowchart of . As previously described elsewhere herein step involves sending data back to the primary site from the recovery site subsequently shutting down the recovery site to return control to the primary site using the BCV as the starting point or device. At step a determination is made as to whether a restoration or reconfiguration technique is to be used. If a restoration technique is to be used control proceeds to step where applications of the recovery site are shut down. At step the recovery BCV is restored to the R device and subsequently control proceeds to step where applications are restarted on the R device on the recovery site. Control then proceeds to step where the detail processing steps previously described in connection with step as described in connection with may be performed. It should be noted that as an alternative to the processing steps outlined in flowchart for step of as also described elsewhere herein rather than propagate data from the remote system for the data recovery site to the primary site an alternative technique that may be performed in connection with the processing of step may be to have an embodiment shutdown applications at the recovery site copy changed data from the recovery site to the primary site and resume operations at the primary site. This may be performed rather than propagating data while running at the recovery site for a predetermined time period as outlined in .

If a determination is made at step that a reconfiguration technique is to be used in an embodiment control proceeds to step where the recovery BCV is reconfigured to be device R. At step the recovery R is reconfigured to be the BCV included in the disaster recovery or remote site. At step partnering devices for the primary RLBCV are reassigned to the new R. This establishes the relationships necessary for the processing in step to succeed in bringing the data back to the primary site such as by performing necessary device pairing and partnering. Subsequently control proceeds to step for further processing.

It should be noted that other embodiments may use other techniques to propagate or copy data from the BCV on the remote site to the R device. An embodiment may use a technique that may be characterized as a restore and swap operation at the recovery site between the BCV and the R device located at the recovery site such as in this example which is the remote data storage system . I O may be first redirected from the R device to the BCV device on the remote or recovery site.

Referring now to shown are more detailed processing steps that may also be included in an embodiment in connection with processing of step . In other words an embodiment may include the processing steps of step prime as outlined in rather than the detailed processing steps outlined for step in connection with . At step the restore and swap functionality at the recovery site between the R and the BCV device may be performed. Generally the restore and swap functionality may be described as copying data from the BCV on the remote site to the R device and subsequently redirecting any I O operations from the BCV device to the R device. Applications continue to run at the remote site. Control proceeds to step where additional processing steps are performed as described previously in connection with step . It should be noted that step is similar to the processing described in connection with step which includes step detailed processing and any equivalents also described herein. In one embodiment using Symmetrix data storage systems data may be propagated from the BCV device to the R device using the RESTORE functionality.

Referring now to shown are more detailed processing steps in a flowchart for processing step previously described in connection with flowchart of . As described elsewhere herein step involves reconfiguring the SAR process to begin using the primary site as the origination or starting point for SAR processing. At step there is a wait for the data to be restored onto the STD of the primary site.

Control proceeds to step where a determination is made as to whether a redefinition or a reconfiguration is needed. The circumstances when a redefinition or reconfiguration may be needed is dependent upon other processing steps or choices previously made. The redefinition applies to the SAR process at the primary site. If the BCV and the R at the restart site are reconfigured their attributes are swapped to execute the presynchronization process of going home as in step then the SAR process needs to be redefined to reflect these changes. Alternatively the SAR process does not have to be redefined for example if the attributes of the R and the BCV are swapped back after the presynchronization step in connection with the reconfiguration processing option. At step if it is determined that no redefinition or reconfiguration is needed control proceeds to step where processing continues otherwise if a determination is made at step that a redefinition or reconfiguration may be needed control proceeds to step where a determination is made as to which of the redefinition or reconfiguration is to be used. If the redefinition or to be used at step control proceeds to step where the SAR process is redefined to use the new devices at the recovery site. Otherwise at step a reconfiguration process may be performed by proceeding to step with recovery BCV is reconfigured to be the R and at step the recovery R is reconfigured to be the BCV. Subsequently at step the partner devices for the primary site RBCV is reassigned to the R device. Subsequently processing continues with step as described elsewhere herein.

Referring now to shown is an example of an embodiment of a single hop configuration that may be used in connection with performing an RDF R R swap option for returning home to the primary site. The returning home R R swap option processing that will be described may be used as an alternative to the presynchronization option and others described herein. One difference between the presynchronization option and the R R swap option that will now be described is that after using the swap command the resynchronization is a continuous operation. In contrast when using the presynchronization option multiple resynchronization cycles are performed. An embodiment in which the R R swap option may be preferred is one having a relatively large number of invalid tracks that also generates a high number of invalid tracks for a predefined time interval. As described herein the RDF extended distance configuration that uses the remote fiber adapter or RFA supports the R R swap command of the RDF host component as described in pending U.S. patent application Ser. No. 09 998 683 filed on Nov. 30 2001 entitled Reversing a Communications Path Between Devices which is herein incorporated by reference. An RDF extended distance configuration that uses the RA ESCON adapter supports only the director R R swap.

Referring now to shown is a flowchart of processing steps that may be performed in connection with the configuration of . It should be noted that is annotated to illustrate processing steps that will now be described in connection with the flowchart . At step the R R swap processing steps are performed. As will be described in more detail in paragraphs that follow the R R swap is an option that uses an existing relationship between two devices and reverses the direction in which the data is propagated. This is in contrast to other techniques described herein for example using dynamic RDF processing in which relationships between devices are created and deleted rather than using an established or existing device relationship.

At step R on the primary site is synchronized with R on the production site such that the data copy of the RBCV on the production site includes a copy of the data as it appears on the R of the target site. At step applications are shut down on the target site. There is a wait until there are no invalid tracks indicating that data has been propagated from the R at the target site to the production site device RBCV. At step an incremental restore is performed such that any changed or different tracks are propagated from the RBCV to the STD device at the primary or production site. At step applications are restarted and brought up at the primary site. At step an R R swap processing is again performed. At step the SAR process may be restarted as executing from the primary site now that returning home processing is complete.

Referring back to each of the processing steps through of the flowchart are illustrated in by having corresponding element numbers. It should be noted that the processing steps described in connection with the R R swap starts off of the Rs at the target or restart site. It should be noted that if an embodiment restarts from the target site BCV as described elsewhere herein in connection with other single hop configurations data may be propagated to the BCV device and the system so configured to performed the processing described herein using that particular device.

Referring now to shown are more detailed processing steps in the flowchart that may be included in an embodiment for performing the processing described in flowchart . At step the R R swap procedure or routine may be performed. Control proceeds to a routine defined at step where a determination is made as to whether the RDF configuration uses remote adapters or RAs. If ESCON RAs are not used control proceeds to step where the R R swap may be performed using a command. Processing at step may be performed for example if an embodiment uses a fibre channel. Otherwise if the RDF configuration uses RAs control proceeds to step where a director R R swap may be performed for example by contacting a customer engineer to modify the configuration file.

At this point control returns to step where additional processing steps may be performed in connection with synchronizing the device at the source or primary site. At step the synchronization direction is set to propagate data from the target system to the source system. At step updated tracks are flagged as invalid in accordance with differences between the R device at the target or restart site and corresponding tracks in the RBCV at the primary site. At step normal RDF operations are resumed and synchronization between the target site and primary site device is commenced. Control proceeds to step where the resynchronization process is monitored. Control proceeds to step where a determination is made as to whether a desired synchronization level has been reached. If not control proceeds to step where the process of monitoring continues until a desired synchronization level has been achieved. It should be noted that the synchronization between the devices goes on while the applications are running at the restart site.

Once the desired level of synchronization between the R of the restart or target site and the RBCV at the primary site has been achieved control proceeds to step where applications are shut down on the recovery site. Step resynchronization process between the target site and the primary site is performed to move over any remaining tracks that have been changed. Once the number of invalid tracks at step has been determined as zero indicating that the data copied at RBCV is equivalent to that stored within the R device at the target site control proceeds to step where an incremental restoration operation is performed from the source RBCV to the source STD device. Control proceeds to step where applications executing on STD devices at the primary site are brought up for execution. Control proceeds to step where once again the R R swap is performed. Control proceeds to step where the synchronization direction is reset from the source to the target.

At step the procedure to restart SAR begins. At step a check is made of the BCV devices status availability at the target site. Step if all of the target BCVs are available control proceeds directly to step . Otherwise control proceeds to step where the target BCVs are split. Control proceeds to step where the current SAR process is deleted and redefined. At step the SAR process started originating with the primary site to propagate data once again to the target or restart site.

The foregoing description provides techniques that may be used in connection with automated data replication. Just described were techniques used in performing system restart and returning to the primary site or going home. Prior to a disaster occurring SAR processing techniques may be used in connection with performing automated data replication that as described herein utilize RDF in the single hop configuration to provide for asynchronous remote copy solutions for creating point in time copies of data and propagation of these copies to long distance remote locations over dedicated network links. This in connection with data consistency using the consistent SPLIT command ensures that a restartable image of data is automatically replicated to the disaster recovery site or target site.

Referring now to shown is an example of a multi hop embodiment that may be used in connection with performing SAR processing as described herein. In one embodiment as will be described herein the use of SAR processing in a multi hop environment may use RDF synchronous mode configurations with an asynchronous remote copy solution to provide for data protection in connection with long distance remote sites without the impact of the distance such as a propagation delay to the application response time.

Shown in the embodiment in the multi hop configuration are three Symmetrix data storage systems. The SAR processing as described in connection with the single hop may also be automated in connection with the multi hop embodiment using these three data storage systems and . At the source or production site a consistency group may be defined as as described elsewhere herein. The consistency group may provide for rolling disaster protection. A trigger event for this consistency group definition may signal for example a rolling disaster at the production site. Symmetrix data storage systems at the primary site may be connected to a bunker site . Data may further be propagated from the bunker site to the target site for storage of the device as .

As shown in the example the primary site or production site devices included in may be connected to the bunker site using synchronous remote mirroring. In this example the R devices at the bunker site contain an exact copy or image of the primary site data as stored in the device as . To propagate data from the bunker site to the target site SAR multi hop configuration may use the remote consistent split command as may be included and used in connection with the TimeFinder product to create consistent point in time copies of the production data that reside in the R devices at the bunker site. These copies of data may be propagated on the RBCV devices of the bunker site to the R devices in the target site. When this remote copy is concluded the data on the target Rs is synchronized with the target BCVs via incremental synchronization to preserve a point of consistency during the next cycle.

It should be noted that this resynchronization and operations between and at the target site do not affect the synchronous copy from the source or production site to the bunker site. The TimeFinder remote consistent split commands and the SAR automation processing may be controlled from the source site. This may be performed by host computer that may be connected to the devices such as .

Referring now to shown is an example of a representation of the different processes that may be included in the SAR processing cycle that may be performed in the multi hop and single hop environment. Generally the SAR cycle may be partitioned into three basic components involving a consistent split a remote copy and a local copy . Further as described in more detail elsewhere herein the remote copy may be divided into two further components including command processing to resume the RDF operations that facilitate communication between data storage systems and secondly an RDF copy command. A local copy for example within a data storage system may be further partitioned into two components such as command processing to establish BCVs using the established command as well as performing a BCV copy. The commands used to establish the BCVs to the STDs and additionally copy changed tracks from STDs to BCVs are examples of the local copy branch. In connection with the remote copy branch the command processing to resume the RDF operation may occur in connection with the RBCV R pairs in copying of changed tracks from R to R as may be associated with the RDF copy command.

It should be noted that the Establish command and the RDF Resume operation may be executed in parallel.

In connection with an unplanned outage or disaster occurring in the primary site the target site may contain a consistent and restartable copy of data in the BCV devices and the bunker site contains the last image of the production data from the production or source site.

Referring back to the use of consistency groups as described and illustrated ensures the integrity of data between the source system and the middle or bunker storage system. Upon the occurrence of an unplanned or rolling disaster the consistency group failure is detected. A dependent write consistent copy or a restartable image of the data at the point of the beginning of the rolling disaster is captured on the Rs in the bunker system . Subsequently one more SAR cycle propagates the point of disaster image from the bunker site to the target system . It should be noted that this additional SAR cycle may be controlled from a target site such as in the event that the source site or production site and associated data storage system have a disaster occur.

Referring now to shown is an illustration of a disaster occurrence at a primary or source site . In the case of a disaster happening at the primary site as illustrated in the target site contains a consistent and restartable copy of the data and the BCV devices and the bunker site contains the last image of the production site data.

Referring now to shown is a flowchart of steps that may be executed in an embodiment for determining the most current consistent copy of data and restarting applications in the event of a disaster happening at the primary site as illustrated in connection with in a multi hop environment. At step the status of devices in the bunker site are determined. The status may be one of available or split as described also in connection with processing of the single hop environment. At step a determination is made as to whether the BCV status is available for all of the BCVs. If so control proceeds to procedure as defined in connection with step processing. Otherwise if all of the BCV statuses are not available control proceeds to step where a determination is made as to whether none of the Rs at the bunker site are split from the BCVs. If so control proceeds to procedure at step . Otherwise control proceeds to step .

Referring now to shown are more detailed processing steps in the flowchart in connection with the previously described procedure through procedure . Procedure has more detailed processing steps as outlined in flowchart . Procedure has more detailed processing steps as outlined in the flowchart . Procedure has more detailed processing steps as outlined in the flowchart indicated by

Referring now to the processing steps in connection with procedure a determination has been made that all bunker site Rs are split from the BCVs indicating that the SAR process was copying data from the bunker to the target site. Control proceeds to step where there is a check for any invalid tracks owed to any R in the target site. At step a determination is made as to whether there are invalid tracks owed to Rs of the target system. If so control proceeds to step where there is a wait for the synchronization to complete. The process remains in the loop formed by steps and until there is a determination that there are no invalid tracks owed to Rs of the target system. Upon proceeding to step the remaining tracks are copied to the Rs in the target system from the bunker site control proceeds to steps and which may be performed in parallel in this example to reestablish RBCVs to Rs at the bunker site as well as reestablish the BCVs to the Rs at the target site.

Subsequently control proceeds to step where the target system devices are resynchronized and then split. In particular at step there is a wait for the completion of the reestablish and split of the BCVs from the Rs at the target site. Control proceeds to step where there is a wait for the completion of the reestablish and subsequently the BCVs at the bunker site are split with the option of RSYNC Y . The RSYNC Y option causes the data from the RBCV at the bunker site to be propagated to the R device at the target site. Control proceeds to step where there is a wait for the completion of the resynchronization of Rs at the target site. Subsequently the Rs are made read and write enabled. The R device is available for restarting.

In connection with executing more detailed processing steps as outlined in the embodiment of flowchart for procedure control proceeds to step if none of the Rs at the bunker site are split from the BCVs. Control then proceeds to step where there is a check to see if the BCVs at the target site are established or in use. At step a determination is made as to whether the BCVs at the target site are in use. If not control proceeds to step where the BCVs are reestablished to the Rs at the target site and then control proceeds to step where the target BCVs are split to preserve the restartable image in the BCV. If at step it is determined that the BCVs at the target site are in use control proceeds directly to step bypassing the processing of step .

Subsequently from step control proceeds to step where there is a wait for the split of the BCVs at the target site. At step there is a check for the BCV status in use at the bunker site and the BCVs are split with the option RSYNCH Y providing for synchronization of the R on the target site as described elsewhere herein. Control proceeds to step where there is a wait for the completion of the resynchronization of Rs at the target site. The Rs are then made read write and the R is available for restarting.

In connection with performing procedure an embodiment may execute the more detailed processing steps as outlined in connection with . At step procedure may be executed if it has been determined that some of the bunker site Rs are split from the BCVs. Control proceeds to step where there is a reestablish of the BCVs with the Rs at the bunker site. Control then proceeds to step where there is a wait for the completion of the reestablish and the split of the BCVs at the bunker site with the option of RSYNC. At step there is a wait for completion of the resynchronization of the Rs at the target site. Subsequently the Rs are enabled for read and write operations and I O operations and the R device is available for restarting.

A SAR processing session may be interrupted because of a situation that prevents the flow of data to the target site. This may be any one of a variety of different situations such as for example a software failure a network failure a hardware failure and the like. This is to be distinguished from the other more serious event occurrence discussed herein of a primary site disaster. In connection with the interruption the primary site SAR process is able to be started or recovered. In the event of an interrupt the SAR process interrupts the SAR cycle and may for example stop sending messages to the console that may be displayed to a user. Once problem diagnostics and corrections are performed restart procedures may be executed.

Referring now to in connection with a multi hop embodiment detailed processing steps included in a flowchart will be described for performing a restart in a multi hop embodiment in the event of an interruption. At step a determination is made that the SAR process was abnormally terminated. At step device locks at both the source and target site may be released. This may be performed by executing commands from the remote system. Similarly as described in following steps other commands may also be executed from the remote system to perform processing steps described herein.

Control proceeds to step where there is a check for the BCV status of available at the target site. A determination is made at step as to whether all of the target BCVs are available. If so control proceeds to step . Otherwise control proceeds to step where the target BCVs are split and then control proceeds to step . At step a check for the BCV status in use at the source or bunker site is determined. Control proceeds to step where a determination is made as to whether the source BCVs are in use. If so control proceeds to step . Otherwise control proceeds to step where the source and bunker BCVs are established. Control then proceeds to step where there is a delete and a redefine of the SAR process. At step the SAR process may be started.

It should be noted that similar processing steps may be performed in a single hop embodiment in connection with an interruption.

What will now be described in connection with the following figures is the use of the SAR process in connection with the multi hop configuration. It should be noted that much of the processing as described herein is similar and uses techniques that are described elsewhere in connection with a single hop configuration.

Referring now to shown is a multi hop configuration of a system that may be used with SAR processing. Also included in the example is a table containing some definitions that may be used in connection with the configuration defined in . The configuration includes a source of primary site or bunker site and a target system . In this particular example when building device lists for multi hop configuration those devices included in the target system may be considered remote devices with respect to the source system . The is in contrast to the relationship between and which are in close geographic proximity.

In a multi hop configuration all TimeFinder commands executed by a source or host system connected to the source devices in may be considered remote commands. To access target BCVs from the source location in this example two RDF groups are used. In sample commands explained in following figures and paragraphs SAR automatically identifies the RA groups used in both the source and the bunker Symmetrix data storage systems. When initializing the RA groups are specified in this particular embodiment.

It should be noted that the table includes some example names of groups and device numbers that may be used in connection with following examples of commands used in connection with the multi hop configuration.

Referring now to shown are processing steps in a flowchart that may be used in connection with initializing the system with data in connection with the SAR process in a multi hop configuration. It should be noted that these steps are similar to those described in connection with the single hop embodiment except that the SAR process operates with respect to the bunker and target sites. At step the source BCVs are established at the bunker site. At step target site BCVs may be established. At step source BCVs may be split and are synchronized with the Rs in the target site. At step source BCVs may be re established at the bunker site. At step target site BCVs may be split.

Subsequent to performing the processing steps of flowchart the SAR processing steps as described elsewhere herein in connection with the single hop embodiment may be performed to propagate date from the bunker site to the target site.

Referring now to shown are commands that may be executed from a host at the source site such as of in connection with priming the pump or initializing the system with data in connection with using the SAR processing techniques. It should be noted that each of the series of commands corresponds to one of the processing steps of flowchart previously described. The commands may be used in connection with performing processing of step . The commands of portion may be used in performing the processing of steps . Similarly the commands of and respectively are more detailed processing steps of commands that may be used in implementing steps and previously described in flowchart . These commands are examples that may be used in an embodiment to perform the foregoing steps. Other embodiments may use different commands and techniques that may vary with each embodiment.

Referring now to shown are commands that may be executed from the host system at the source or production site to define the SAR process. It should be noted that the automation process of the SAR single hop and multi hop configurations are similar. However the devices defined in connection with for example the device list command vary in connection with the multi hop versus a single hop configuration since data is being propagated from the bunker site to the target site in the multi hop embodiment. As described elsewhere herein in connection with a single hop configuration the SAR process may be controlled using actions such as the START STOP RESTART CLEAR and DELETE commands described elsewhere herein. These commands may be executed from a host computer at the source of production site. The SAR processing steps which provides for data replication are such that the production site and the bunker site are connected in synchronous mode and the data replication from the second to the third are the bunker site to the target or recovery site may be performed using RDF adaptive copy mode. Information is propagated from the bunker site to the target site using the remote consistent split command to split the R and the RBCV devices at the bunker site. This creates consistent point in time copies of the production data residing in the R devices of the bunker site and propagates these copies on the RBCV devices of the bunker site to the R devices in the target site.

What will now be described are various procedures that may be used in returning home in a multi hop configuration. In particular an RDF presynchronization option procedure R R swap procedure and a returning home procedure for a multi hop configuration using dynamic RDF are described.

Referring now to shown is a flowchart of processing steps that may be used in a multi hop embodiment when performing an RDF presynchronization option to return home from a target site to a source or primary site. It should be noted that the processing steps that described for this multi hop environment are similar to those described for use with a single hop embodiment except for the multi hop embodiment there is an additional step of synchronization of the source R device. In particular as will be described in following paragraphs the source R is synchronized with the bunker site R during the restoration of the bunker site BCV R to the R device.

At step the presynchronization process is initialized and begun to propagate data from the target site to the source site where applications are still executing at the target site. At step the synchronization direction is changed such that data is propagated from the target R to the bunker site RLBCV device. In other words the RBCV device is synchronized to be the same as the data included in the R device at the target site. At step the RBCV at the bunker site is placed in an RDF Not Ready state making it unavailable to host input or RDF data flow. At step preparations are made at the RBCV device to refresh the RBCV device at the bunker site from the updated R tracks. At step synchronization between the R device at the target site and the RBCV bunker site begins. Control proceeds to step where at the end of the presynchronization an incremental restore is performed from the bunker site RBCV to the bunker R device.

At step the RBCV device is split from the R device at the bunker site. At step the number of invalid tracks of the target R device is determined. If a threshold amount of data has not be propagated from the R device to the RBCV device another cycle of resynchronization is performed at step by having control proceed to step . If another resynchronization cycle is not needed control proceeds to step where applications that are executing on the target site are shut down. The target R devices are placed off line step made read only step and have flags and status bits set to indicate that the Rs are not ready step .

At step changed tracks on the R device are flagged. At step RDF operation is resumed. At step a monitoring process is started in connection with the resynchronization of the RBCV device at the bunker site such that it is synchronized with the R device at the target site. At step a determination is made as to whether the number of invalid tracks denoting the differences between the R device and the RBCV device is equal to zero. If not control proceeds to step where the process of monitoring the resynchronization of the devices continues while data is copied from the R target system to the RBCV of the bunker system.

When the synchronization is complete control proceeds to step where an incremental restoration operation is performed from the bunker site RLBCV device to the bunker site R device using the R synchronization option. The R synchronization option in this example further propagates the data to the source site. At step applications are brought up for execution on the STD devices at the source site.

At step procedure for restarting SARs begins. At step the synchronization direction is changed to propagate data from the bunker site to the target site. Control proceeds to step where a check is made of all of the BCV status available flags at the target site. A determination is made at step as to whether all of the target BCVs are available. If so control proceeds to step . Otherwise control proceeds to step where the target BCVs are split. Control then proceeds to step where the SAR process is deleted and then redefined. At step the SAR process may again be started with origination at the source site.

It should be noted that as described herein in connection with the multi hop and the single hop embodiments the presynchronization process may be performed by executing a configuration command from the RDF host component that may be included in a computer system connected to the target site. In one embodiment this presynchronization command may be found in an RDF Host Component version 5.0 or above using the PRE FRESH and PRE RSUM options that provide a way to begin the synchronization of data of an R device from an R device that is still read write accessible to a host. Other embodiments may provide other techniques in connection with providing similar functionality to perform the processing steps described herein.

The foregoing processing propagates data from the target site to the source site while applications are still executing at the target site producing more invalid tracks on the R target system. While the group of invalid tracks is moving new invalid tracks are accumulating on the R devices. Each time the sequence of commands is executed to propagate data from the target system to the bunker site the number of invalid tracks is decreased. This cycle may be periodically repeated until the number of invalid tracks reaches a minimum or threshold level for example that may be used in connection with performing the determination at step . It should be noted that the invalid tracks account does not reach zero in this embodiment until the write activity on the R device stops.

Referring now to shown is a flowchart of processing steps that may be used in performing a returning home procedure using the R R swap option in a multi hop configuration. It should be noted that these processing steps are similar to those described elsewhere herein in connection with a single hop configuration with the additional processing to synchronize the source R with the bunker site R during the restoration of the bunker site RBCV to the R device.

At step R R swap processing is performed. These processing steps transfer control and execute processing steps and optionally either or . The R R swap option is similar to that as described in connection with the single hop configuration. Control proceeds to step where there is a resynchronization of the RDF pair R on the target site and the RBCV at the bunker site to flag any tracks that were updated on the target R volume. At step the synchronization direction is set from the target site to the bunker site. At step updated tracks are flagged as invalid with respect to R tracks and valid R tracks to detect differences between the R device at the target site and the RBCV at the bunker site. At step normal RDF operations are resumed and synchronization of the bunker site RLBCV with that of the R at the target site are commenced.

At step the monitoring process for the resynchronization is performed to determine at step whether an achieved desired level of synchronization has been reached. In other words data is propagated into the system beginning with the target device without shutting down the applications on the target site and moved in incremental amounts until a desired level of synchronization between the R at the target site and the RLBCV on the bunker site has been achieved. Once this desired level of synchronization has been achieved control proceeds to step where applications running on the target site are shut down. At step the resynchronization process is monitored to move over any remaining invalid tracks from the target site R to the RLBCV on the bunker site. Once this additional data has been moved to the bunker site control proceeds to step where an incremental restoration is performed from the bunker site RBCV to the bunker site R device using the R synchronization option. At step applications on the STD devices at the primary site are brought up. It should be noted that at step the R synchronization option further propagates data from the bunker site R to the STD device at the primary or source site. Control proceeds to step where an R R swap is performed between the bunker and the target site devices. At step the synchronization direction is reset from the bunker to the target and control proceeds to step where the procedure is executed for restarting SAR processing.

At step a check is made of all of the BCV statuses regarding the availability of the devices at the target site. A determination at step as to whether all of the target site BCVs are available. If so control proceeds to step . Otherwise control proceeds to step where the target site BCVs are split and control proceeds to step where the SAR process is deleted and then redefined. At step the SAR process is then started.

As described herein in connection with performing the R R swap option when applications are running off of the Rs the R devices are ready and read write enabled. RDF operations cannot be resumed for data protection reasons when the system is in this state. The swap command on the RDF host component may be used in connection with swapping the RDF relationships between two RDF devices such as R and R where R becomes R and the R device becomes or operates as the R device. After this swap the RDF operation may be resumed without interrupting the applications.

Referring now to shown is a flowchart of steps of an embodiment that may be used in connection with using dynamic RDF to perform the returning home procedure in a multi hop configuration. It should be noted that in the following description and flowcharts the returning home network configuration is the same as that prior to the disaster.

At step steps are performed in connection with reconfiguring RDF to run SAR from the target to the bunker site. In other words in connection with the dynamic RDF processing the SAR process may be used in connection with propagating data back to or returning home to the source site. This is in contrast to using other options and techniques described herein in connection with a multi hop configuration that do not rely on the SAR process for propagating data from the target back to the source or primary site.

At step the bunker site RLBCV and the target site R pair are deleted using the DELETE PAIR Dynamic RDF command. After the execution of the delete command at step the bunker site RBCV becomes a BCV and the target R becomes an STD device. At step the source R and the bunker site R pair are deleted such that the source R now becomes an STD and a bunker site STD and the bunker site R becomes an STD as well or functions as a standard device. At step a new RDF relationship using a CREATE PAIR command for example is created between the STD device in the target site and the STD device in the bunker site. At step a determination is made as to whether the RDF configuration uses RAs or fiber channels. If fiber channels are used control proceeds to step . Otherwise control proceeds to step where a director R R swap may be performed for example by a customer engineer editing the configuration file. At step resynchronization processing is begun to synchronize the bunker site to that of the target site device. At step the synchronization direction is changed from the target to the bunker site. At step updated tracks are flagged as invalid R tracks and valid R tracks in connection with determining data differences between the target site and the bunker site device. At step RDF operations are resumed and the synchronization between the target and bunker site device is commenced. At step the resynchronization process is monitored until a desired level of synchronization determined at step has been achieved. Once this achieved level of synchronization has been reached control proceeds to step where applications executing on the recovery site are shut down. At step another monitoring process is executed in connection with the resynchronization of any remaining data from the R at the target site to the bunker site device.

When there are no invalid tracks detected at step the resynchronization process is complete and the bunker site device is synchronized with that of the target device. Control proceeds to step where RDF is reconfigured to resynchronize the bunker R with the source STD. Control proceeds to step where a delete pair command may be used to delete the target R and bunker R pair. At step a new RDF relationship may be created using the create pair command between the STD device and the source site and the STD device of the bunker site. Control proceeds to step where the synchronization direction has changed from the bunker site to the source site. At step updated tracks are flagged as invalid R tracks and valid R tracks in order to propagate any changed data from the bunker site to the source site. At step normal RDF operations are resumed and synchronization of the bunker site device and the source site device is commenced. Control proceeds to step of where the resynchronization process from the bunker site to the source site is monitored until there are no invalid tracks as determined at step .

Once there are no invalid tracks control proceeds to step where the synchronization direction is set from the source to the bunker site and applications are started at the source site in step . At step a create pair command may be used to create a new RDF relationship between the BCV device in the bunker site and the STD device at the target site. At step the SAR process may be restarted where at step a check is made of the BCV status available at the target site. If it is determined that all of the target BCVs at the target site are available control proceeds to step . Otherwise control proceeds to step where the target BCVs are split and then control proceeds to step where the SAR process is deleted and then redefined such that the SAR process may begin again originating from the source site to the target site as prior to the disaster occurring.

As described herein a zero data loss may be obtained in a multi hop embodiment utilizing the automated data replication processes in the event of a disaster at the primary site. In connection with a single hop embodiment there may be some data loss using similar techniques.

It should be noted that the cycle time described herein in connection with SAR process execution may vary in accordance with each embodiment due to factors such as for example system data bandwidth and the amount of changed data in each particular system. Cycle time may be tuned in accordance with each of these characteristics and others that may vary with each embodiment.

In the multi hop embodiments described herein the source and the bunker sites are typically in close physical proximity resulting in particular communication and data transfer techniques that may be used as described herein. For the multi hop embodiments described herein the restart and returning home procedures execute in no protection mode that is without having a reverse SAR process execute because the bunker and target sites in the instance of returning home are remotely located typically and not subject to the same physical proximity that the bunker and source sites are. An embodiment may select a new bunker site when performing the returning home procedure to run in a protected mode using the reverse SAR process. However in this instance the returning home procedure described herein may be varied since data is not being propagated and returned to the primary site through the same path of the original configuration prior to the disaster occurring.

It should be noted that the dynamic RDF techniques as described herein in connection with a multi hop embodiment may not typically be used in connection with a single hop embodiment which also chooses the option of no protection that is in which an alternative to executing reverse SAR processing is used to propagate data back to the primary site. In connection with such a single hop embodiment with no protection it may not justify the configuration overhead associated with using dynamic RDF unless reverse SAR processing is also running.

The foregoing provides a flexible and efficient technique that may be used in connection with a single hop and a multi hop embodiment for automated data replication. The foregoing creates a restartable image using consistency technology for disaster recovery on an ongoing basis performed in an automated fashion. The SAR processes described herein may be characterized as asynchronous with respect to the host providing for propagation of data over long distances without propagation delays with respect to host operations. Additionally in the event of a disaster at the primary site making the primary site unavailable a zero data loss restartable image may be obtained in connection with a multi hop embodiment. The restart in the returning home procedures as described herein may use any one of a variety of different options and techniques as well as others to return data back to the originating point or primary site.

It should be noted that processing steps and data structures used in performing the steps described herein may be implemented in hardware software or some combination thereof in accordance with the particular requirements of each embodiment. For example in one embodiment data structures such as a bitmap used in connection with determining and maintaining changed device tracks may be implemented in hardware.

While the invention has been disclosed in connection with preferred embodiments shown and described in detail their modifications and improvements thereon will become readily apparent to those skilled in the art. Accordingly the spirit and scope of the present invention should be limited only by the following claims.

