---

title: Universal Plug-and-Play latency and delay compensation
abstract: A Universal Plug-and-Play (UPnP) device () determines a latency and propagation delay period (LPDP) that is added to a UPnP network () response time, based on UPnP network () conditions. The UPnP device () transmits a search command when connecting to the UPnP network (), and waits a period of time based on the LPDP for a response to the search command from other UPnP devices () in the UPnP network () before the UPnP device () stops listening for other UPnP devices ().
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07821955&OS=07821955&RS=07821955
owner: Motorola, Inc.
number: 07821955
owner_city: Schaumburg
owner_country: US
publication_date: 20061228
---
The invention relates to Universal Plug and Play UPnP networks. In particular the invention relates to latency and delay compensation in UPnP networks.

Universal Plug and Play UPnP is a set of computer network protocols promulgated by the UPnP Forum. The goals of UPnP are to allow devices to connect seamlessly and to simplify the implementation of networks in the home data sharing communications and entertainment and corporate environments. UPnP achieves this by defining and publishing UPnP device control protocols built upon open Internet based communication standards.

The UPnP standard was defined for device discovery over local area networks. Latency was not explicitly accounted for under the assumption that it would be nearly negligible in LANs.

When a UPnP control point is powered on one of the first things it does is to multicast a search command to discover other UPnP devices on the network. Recipients of this command are to respond within an amount of time specified by a parameter embedded in the command. The UPnP standard states that The control point should wait at least the amount of time specified in the header for responses to arrive from devices. The wait for responses should be extended by additional time a second or two to allow for network propagation and processing delays. The standard does not specify what this additional time should be other than suggesting that it be a second or two. 

The UPnP standard is also now being extended to consider device discovery over the wide area network for example through a UPnP tunnel in the WAN between a cell phone a home gateway. Clearly latency is non negligible over the WAN. The UPnP standards body is currently working to address latency through the use of a proxy element in the home that acts on behalf of the remote mobile device. UPnP proxy elements are known in the art but the implementation of these proxy elements may be complex and not applicable in all systems.

The present disclosure is defined by the appended claims. This description summarizes some aspects of the present embodiments and should not be used to limit the claim.

While the present disclosure may be embodied in various forms there are shown in the drawings and will hereinafter be described some exemplary and non limiting embodiments with the understanding that the present disclosure is to be considered an exemplification of the disclosure and is not intended to limit the invention to the specific embodiments illustrated.

In this application the use of the disjunctive is intended to include the conjunctive. The use of definite or indefinite articles is not intended to indicate cardinality. In particular a reference to the object or a and an object is to denote also one of a possible plurality of such objects.

In a preferred embodiment a latency and propagation delay compensation system is disclosed for a Universal Plug and Play network UPnP network. The delay compensation system assess network conditions either initially continuously or periodically to determine a round trip latency and propagation delay period LPDP and adjusts the timing requirements on the remote UPnP device.

The system memory may retain data related to system parameters UPnP discovery logic operable to initiate and process a discovery protocol for the UPnP control point LPDP values associated with network transport layer protocols search parameters associated with M SEARCH commands and MX values for the Data network selection logic operable to select the fixed value of the LPDP based on the network transport layer protocol network sense logic operable to determine the network transport layer protocol and network latency determination logic operable to determine a network latency measure such as the LPDP associated with a network transport layer.

Any of the logic may comprise series of instructions retained in the system memory . In other embodiments the logic may comprise circuitry configured to execute instructions. The processor may comprise a microprocessor an embedded processor a microcontroller a field programmable gate array FPGA an application specific integrated circuit ASIC a network appliance a network processor a discrete circuit and or other semiconductor circuits. The system memory may comprise volatile or nonvolatile memory including a dynamic random access memory DRAM an electrically eraseable programmable read only memory EEPROM a flash memory a static random access memory SRAM a magnetic random access memory MRAM a bubble memory compact discs CDs digital versatile discs DVDs a hard drive floppy disks or other memory storage modules.

When a UPnP enabled device such as the portable UPnP device is added to the data network a UPnP discovery protocol allows that device to advertise its services to control points on the data network . Similarly when a control point is added to the data network the UPnP discovery protocol allows that control point to search for devices of interest on the network. The exchange in both cases is a discovery message containing data about the UPnP device or one of its services for example its type identifier and a pointer to more detailed information.

In the discovery phase the UPnP control point multicasts a search command to discover other UPnP devices on the data network . Recipients of this M SEARCH command are to respond within an amount of time specified by an MX parameter embedded in the M SEARCH command. The UPnP standard states that the control point should wait at least the amount of time specified in the MX header for responses to arrive from devices. The wait for responses should be extended by additional time a second or two to allow for network propagation and processing delays. The standard does not specify what this additional time should be beyond the vague one or two second requirement.

When UPnP discovery is conducted over uncongested LANs the additional wait time may be negligible. IEEE 802.11b g wireless LAN routers for example used in many data networks have peak speeds of 11 Mb s and 54 Mb s respectively all but guaranteeing timely receipt of M SEARCH responses. However when the data network is congested the response to the M SEARCH command can be delayed by more than a second or two. For example congestion may occur if a UPnP control point issues an M SEARCH command while other users on the LAN are conducting large file transfers media streaming or other bandwidth intensive action. If the control point that issued the M SEARCH command waits only a second or two the control point may stop listening before the response arrives and may have no knowledge of devices that properly responded within MX seconds.

This latency effect may occur when issuing M SEARCH commands over a wide area network WAN such over the network connections and . Although the UPnP standard was originally defined to be a local area networking protocol a UPnP device may remotely connect to the home network in different ways such as by using a tunneling method e.g. virtual private network VPN . For example extensions to the existing standard currently being considered will specify how a UPnP enabled mobile phone can connect to a user s home data network over a wide area network.

Referring to round trip latency and propagation delay can accrue not only because of delays inherent to cellular protocols e.g. GPRS within the carrier but also because of inherent delays in the Internet connection . Variations in these delays i.e. jitter can occur as well. More than a second or two delay can accrue over the WAN. When this happens the remote control point device such as the UPnP enabled portable device may stop listening for responses to its M SEARCH command before the responses have time to arrive.

In an embodiment of the disclosure a UPnP control point is configured to wait a determined amount of time for M SEARCH responses depending on network conditions. As mentioned previously the only requirement is that the control point waits for MX seconds for responses to its M SEARCH request with an additional wait time of one or two seconds to account for network latencies. This additional wait time may be referred to as a latency and propagation delay period LPDP .

It is not sufficient for the UPnP control point to only increase the value of MX to compensate for network latency since devices have the option to wait between 0 and MX seconds before responding. For example if MX 50 seconds and there is a network latency of 8 seconds increasing MX to 58 would allow the responding device to wait for 58 seconds before replying. In this case the UPnP control point would not receive the response for 66 seconds after the responding device replies or a total of 74 seconds after the initial search command is sent.

In a preferred embodiment of the disclosure the UPnP control point transmits an M SEARCH command with fixed values of LPDP based on the physical transport network. illustrates an example process that compensates for latency in a UPnP network. Any of the elements of may implement the steps of . The UPnP control point may be initialized at start up of the device at step . The UPnP control point may perform power up checks on modules within the device load parameters data and instructions for operation of the device and or other start up actions. The UPnP control point connects at step to a data network including other UPnP enabled devices such as the data network . The UPnP control point may register provide identification and security data transmit data packets related to the device address or location and or other login actions. The UPnP control point may discover other UPnP enabled devices connected to the network during the discovery period.

The UPnP control point determines values for LPDP available to the UPnP control point for different network transport layer protocols at step . The UPnP control point may access the system memory to determine LPDP values . The UPnP control point may determine at step whether the device can determine the network transport layer protocol. The UPnP control point may transmit data packets configured to determine network connectivity. If the UPnP control point can determine a connection to the data network the UPnP control point receives underlying IP network transport layer data at step . The UPnP control point may use non UPnP protocol methods to determine the underlying transport being used for data transmission for example IEEE 802.11b g WLAN Bluetooth or GPRS UMTS. The UPnP control point may use Application Programming Interfaces APIs that can provide this information. Once the UPnP control point receives network transport layer data the UPnP control point selects an LPDP from among several predetermined fixed values at step . In an example embodiment LPDP could be 1 second if the network is WiFi and seconds if the network is GPRS.

The UPnP control point then transmits a search command at step to other UPnP devices on the data network . The search command may be implemented as an M SEARCH command formatted based on the UPnP standard. The M SEARCH command may further include a UPnP header wait time such as an MX value based on the UPnP standard. The UPnP control point then waits a mandatory wait time period based on the delay period LPDP and the MX wait time at step . The UPnP control point preferably waits a mandatory wait time equal to a sum of the LPDP and the MX wait time before the control point stops listening. If the UPnP control point is unable to determine the network transport layer protocol or does not receive network latency data the UPnP control point stops listening for other UPnP devices at step .

In another preferred embodiment the UPnP control point periodically assesses network latency conditions and adjusts the LPDP accordingly. illustrates an example process that compensates for latency in a UPnP network. Any of the elements of may implement the steps of . In one embodiment the UPnP control point transmits an echo request packet at step using an IP protocol such as PING to determine a round trip time between the UPnP control point and the home network gateway router . PING is a computer network tool used to test whether a particular host is reachable across an IP network. PING works by sending ICMP echo request packets to the target host and listening for ICMP echo response packet replies.

The UPnP control point determines at step whether an echo response packet has been received. Using interval timing and response rate the UPnP control point estimates the round trip time generally in milliseconds although the unit is often omitted and packet loss if any rate between hosts at step . The LPDP value can be set to this round trip time. The PING process may accurately assess propagation delay between the UPnP control point and the home network gateway router . The UPnP control point determines the LPDP value based on the round trip time at step and the UPnP control point waits. Because devices inside the home network may be subject to Network Address Translation NAT sending a PING message to individual devices may not be possible.

The UPnP control point then transmits a search command at step to other UPnP devices on the Data network . The search command may be implemented as an M SEARCH command formatted based on the UPnP standard. The M SEARCH command may further include a wait time period header such as an MX value based on the UPnP standard. The UPnP control point then waits a mandatory wait time period based on the delay period LPDP value and the MX wait time at step . The UPnP control point preferably waits a mandatory wait time equal to a sum of the LPDP and the MX wait time before the device stops listening. If the UPnP control point does not receive echo response packets and is therefore unable to determine a round trip time for the LPDP value the UPnP control point stops listening for other UPnP devices at step . Alternatively the UPnP control point may select a determined LPDP value to use to determine the mandatory wait time.

In another embodiment the UPnP device initially determines MX to a low value and the LPDP value to a high value. The LPDP value can then be estimated based on the time it takes to receive the first reply i.e. the LPDP value is less than or equal to the time it takes to receive the first reply. LPDP may be adjusted each time a device search is performed. illustrates an example process that compensates for network latency. Any of the elements of can implement the steps in . The UPnP control point sets a response time value to a lowest value and delay period value to a highest value at step . The UPnP control point may set the LPDP value to 10 seconds for example and sets a UPnP header wait time to a value of 1 second.

The UPnP control point then transmits a search command at step to other UPnP devices on the data network . The search command may be implemented as an M SEARCH command formatted based on the UPnP standard. The M SEARCH command may further include a wait time period header such as an MX value based on the UPnP standard. The UPnP control point then determines at step if a response from other UPnP devices is received such as from other UPnP devices in the data network . The network latency determination logic determines the LPDP value based on a time period to receive the first reply to the search command at block .

The UPnP control point waits for a mandatory wait time based on the delay period such as the LPDP value plus the MX value at step . If a response from other UPnP devices is not received the UPnP control point stops listening for other devices at step .

In another embodiment the UPnP device uses an internal timer to estimate network latency by measuring the average elapsed time between packet transmissions and receipts. The network latency determination logic determines the LPDP value based on a function such as an average value of the elapsed times between the packet transmissions and the packet receipts. This may accurately assess propagation delay between the UPnP control point and a targeted device e.g. wireless electronic device in the home that is behind the home data network gateway .

In another embodiment the UPnP control point receives data from the data network provider such as the carrier related to current network latency conditions. The network latency determination logic determines delays in either the carrier or the Internet depending on the network provider such as the carrier .

In another embodiment a UPnP device on the home network such as the wireless electronic device is left in an always on state. The UPnP control point knows a priori of the existence of the device. The always on device responds in a pre specified amount of time t. In general devices may respond between 0 and MX seconds. illustrates an example process that compensates for network latency in a data network . The UPnP control point transmits a search command such as an M SEARCH command with a high LPDP value to discover the always on device on the UPnP network at step . The UPnP control point determines if it has received a response from the always on network device at step . If the UPnP control point receives a response from the always on network device the UPnP control point then determines a round trip response time t for the always on UPnP device at step and determines the LPDP as t tat step . The UPnP control point may repeat this process periodically to assess network conditions. This may assess end to end i.e. UPnP control point to home device delay. The UPnP control point then waits for a mandatory wait time at step for time period based on the delay period such as a sum of the determined LPDP and MX for example.

In an alternative embodiment the UPnP control point may transmit a search command with a low value of LPDP e.g. starting with LPDP 0 . If the UPnP control point does not receive a response the UPnP control point increases the LPDP value until it receives a response from the always on device.

The disclosed UPnP control point makes it mandatory for a control point to wait a specific amount of time for M SEARCH responses depending on network conditions. As mentioned previously the only current UPnP protocol requirement is that the control point wait for MX seconds for responses to its M SEARCH request with an additional wait time of one or two seconds to account for network latencies. Many UPnP control points do not wait any additional time beyond MX relying instead on devices to respond in a period less than MX seconds. The disclosed UPnP control point may compensate for network congestion and latency delays when connecting portable devices to a data network outside of a home network .

The methods shown in the sequence diagrams may be encoded in a signal bearing medium a computer readable medium such as a memory programmed within a device such as one or more integrated circuits or processed by a controller or a computer. If the methods are performed by software the software may reside in a memory resident to or interfaced to the UPnP control point a communication interface or any other type of non volatile or volatile memory interfaced or resident to the data network or UPnP control point . The memory may include an ordered listing of executable instructions for implementing logical functions. A logical function may be implemented through digital circuitry through source code through analog circuitry or through an analog source such as through an analog electrical audio or video signal. The software may be embodied in any computer readable or signal bearing medium for use by or in connection with an instruction executable system apparatus or device. Such a system may include a computer based system a processor containing system or another system that may selectively fetch instructions from an instruction executable system apparatus or device that may also execute instructions.

A computer readable medium machine readable medium propagated signal medium and or signal bearing medium may comprise any module that contains stores communicates propagates or transports software for use by or in connection with an instruction executable system apparatus or device. The machine readable medium may selectively be but not limited to an electronic magnetic optical electromagnetic infrared or semiconductor system apparatus device or propagation medium. A non exhaustive list of examples of a machine readable medium would include an electrical connection having one or more wires a portable magnetic or optical disk a volatile memory such as a Random Access Memory RAM electronic a Read Only Memory ROM electronic an Erasable Programmable Read Only Memory EPROM or Flash memory electronic or an optical fiber optical . A machine readable medium may also include a tangible medium upon which software is printed as the software may be electronically stored as an image or in another format e.g. through an optical scan then compiled and or interpreted or otherwise processed. The processed medium may then be stored in a computer and or machine memory.

While the principles of the invention have been described above in connection with specific apparatus it is to be clearly understood that this description is made only by way of example and not as a limitation on the scope of the invention. It is therefore intended that the foregoing detailed description be regarded as illustrative rather than limiting and that it be understood that it is the following claims including all equivalents that are intended to define the spirit and scope of this invention.

