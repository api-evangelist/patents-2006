---

title: Simplification of alpha compositing in the presence of transfer functions
abstract: A method determines a color at a plurality of locations in a region of overlap of a first graphic element and a second graphic element, with each graphic element having a color value and a partial opacity value defined at each location. The method includes the steps of determining a transfer color as a combination of the color value of the first graphic element and the color value of the second graphic element, with the transfer color being independent of the opacity values of each element, and determining a first color value of a set of possible color values. At least one color value in the set of possible color values is derived from the transfer color, and another color value in the set of possible color values is derived from the color value of at least one of the first graphical element and the second graphical element. Additional steps include selecting the first color value from the set of possible color values to determine the color at a first selected location in the region of overlap, and determining a second color value from the set of possible color values, and selecting the second color value for a second selected location in the region of overlap. The selection of the first and second color values is at least dependent upon the partial opacity value of the first or second graphical elements.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07982746&OS=07982746&RS=07982746
owner: Canon Kabushiki Kaisha
number: 07982746
owner_city: Tokyo
owner_country: JP
publication_date: 20060505
---
The present invention relates generally to image processing and in particular to a method and apparatus for combining a first graphic element and a second graphic element. The present invention also relates to a computer readable medium having recorded thereon a computer program for combining a first graphic element and a second graphic element.

Two raster graphic elements both of which have color and opacity also known as alpha and transparency defined at each point of the elements may be combined. These two elements may be combined through a method of compositing for example as described by Porter and Duff in the publication entitled Compositing Digital Images Vol. 18 No. 3 1984 pp. 253 259 hereafter Porter and Duff . In particular in this method an upper or source graphic element s and a lower or destination graphic element d may be composited together with an over operator one of several operators defined in the publication . The composition of the graphic elements produces a resultant graphic clement r in accordance with the following Equations 1 and 2 applied at each point e.g. a pixel 1 1 1 2 where 

To simplify the compositing equations and operations for simple compositing it is sometimes convenient to use pre multiplied color values. A pre multiplied color value is the color value multiplied by the corresponding opacity value. For example in pre multiplied form the Porter and Duff over operation becomes 1 3 1 4 where 

However pre multiplied forms of the Porter and Duff compositing operations are only usefull to a sub set of compositing operations. In the remainder of this description operations will be described in terms of un premultiplied values unless otherwise stated.

A second known method of combining two graphic elements is based upon combining the colors of pairs of opaque graphic elements. Examples of such color combining operations include bit wise logical raster operations raster ops as exercised by Microsoft Windows Graphical Device Interface GDI Application Programming Interface API with operations such as R2 MERGEPEN bitwise OR and R2 MASKPEN bitwise AND . Such color combining operations also include transfer modes as exercised by Adobe Photoshop with functions such as LIGHTEN and DARKEN. The above operations which are just examples of a large class of functions are defined in Table 1 as follows 

Many such operations are possible and exercised by various graphic systems. However the above definitions assume both s and d are completely opaque elements. A generalization of color combining operations where a graphic element with non unity opacity referred to herein as a semi transparent element is being combined with a transfer function onto i.e. over an opaque background element is exercised in Adobe PhotoShop and described in U.S. Pat. No. 6 421 460 Hamburg . Hamburg discloses the following compositing equation ro 1 5 1 6 where T is the transfer function such as LIGHTEN or DARKEN producing a transfer color.

U.S. Pat. No. 6 483 519 by Long et. al. also U.S. patent application Ser. No. 10 176 644 filed Nov. 24 2002 by Long et. al. describes a method of combining two graphical objects an upper graphic element and a lower graphic element with a transfer function both objects having a non unity opacity value. U.S. Pat. No. 6 421 460 by Hamburg describes a less generic method for combining an upper graphic element and a lower graphic element. The method of combining two graphic elements described above uses the equations 1 1 7 1 1 8 These equations can be derived by extending the ideas of Porter and Duff. They allow the combination of semi transparent graphic elements with raster operations such as R2 MERGEPEN or transfer functions such as LIGHTEN. Such color combining operations had previously been considered incompatible with partial opacity of the lower graphic element.

Whilst Long et. al. U.S. Pat. No. 6 483 519 describes a graphics accelerator capable of efficiently performing the above generalized technique for systems without such an accelerator there are a number of practical difficulties in using the above technique. Firstly the compositing equations are computationally expensive and must be performed on every pixel pair of the two operands of an operation. Such computation is a heavy burden when carried out in a software system. Compounding this problem is the common use of graphics acceleration based on application specific integrated circuits. Graphics accelerators are now commonly used in desktop computers and printers to achieve an acceptable level of graphics performance. However such accelerators have only a limited repertoire of primitive operations. These primitive operations may include both Porter and Duff compositing and or raster operations or transfer functions however they do not usually allow the general case of Porter and Duff compositing in the presence of raster operations or transfer functions where both operands can have transparency as described above. This can present considerable difficulties since there are large time penalties for stopping the pipeline of a graphics accelerator in order to substitute software calculations for aspects that the graphics accelerator is unable to compute. When combined with the very expensive calculations described above the performance penalty is large.

Thus a need clearly exists for a more efficient method of combining a first graphic element and a second graphic element where this combining may be performed by accelerators that have a limited repertoire of primitive operations as described above.

It is an object of the present invention to substantially overcome or at least ameliorate one or more disadvantages of existing arrangements.

According to one aspect of the present invention there is provided a method of determining a color at a location in a region of overlap of a first graphic element and a second graphic element each said graphic element having a color value and an opacity value defined at a plurality of locations the method comprising the steps of 

a determining a transfer color as a combination of the color value of the first graphic element and the color value of the second graphic element said transfer color being independent of the opacity values of each said element 

b determining at least one color value of possible color values with said at least one color value being derived from the transfer color and

c selecting for at least one location in said overlap region said at least one color value from the possible color values said selection being dependent upon at least one of the opacity value of the first or second graphical element.

According to another aspect of the present invention there is provided a method of combining an upper graphic element and a lower graphic element each with color and opacity defined at a plurality of locations and a background graphic element with color defined at a plurality of locations to produce an updated background graphic element said method being characterized in that 

According to still another aspect of the present invention there is provided a method of combining an upper graphic element and a lower graphic element each with color and opacity defined at a plurality of locations said method comprising the steps of 

According to still another aspect of the present invention there is provided an apparatus for determining a color at a location in a region of overlap of a first graphic element and a second graphic element each said graphic element having a color value and an opacity value defined at a plurality of locations said apparatus comprising 

transfer color determining means for determining a transfer color as a combination of the color value of the first graphic element and the color value of the second graphic element said transfer color being independent of the opacity values of each said element 

color value determining means for determining at least one color value of possible color values with said at least one color value being derived from the transfer color 

selection means for selecting for at least one location in said overlap region said at least one color value from the possible color values said selection being dependent upon at least one of the opacity value of the first or second graphical element.

According to still another aspect of the present invention there is provided an apparatus for combining an upper graphic element and a lower graphic element each with color and opacity defined at a plurality of locations and a background graphic element with color defined at a plurality of locations to produce an updated background graphic element said apparatus being characterized in that 

According to still another aspect of the present invention there is provided an apparatus for combining an upper graphic element and a lower graphic element each with color and opacity defined at a plurality of locations said apparatus comprising 

first combining means for combining the said upper graphic element with the color of said lower graphic element using a transfer function without regard to the opacity of said lower graphic element to determine a combination graphic element 

mask determining means for determining at least one mask using the opacity of said lower graphic element or the opacity of said upper graphic element or both and

second combining means for combining said combination graphic element with either the upper graphic element or the lower graphic element or both subject to masking by said at least one mask.

According to still another aspect of the present invention there is provided a computer program product having a computer readable medium having a computer program recorded therein for determining a color at a location in a region of overlap of a first graphic element and a second graphic element each said graphic element having a color value and an opacity value defined at a plurality of locations the computer program comprising 

code for determining a transfer color as a combination of the color value of the first graphic element and the color value of the second graphic element said transfer color being independent of the opacity values of each said element 

code for determining at least one color value of possible color values with said at least one color value being derived from the transfer color and

code for selecting for at least one location in said overlap region said at least one color value from the possible color values said selection being dependent upon at least one of the opacity value of the first or second graphical element.

According to still another aspect of the present invention there is provided a computer program product having a computer readable medium having a computer program recorded therein for combining an upper graphic element and a lower graphic element each with color and opacity defined at a plurality of locations and a background graphic element with color defined at a plurality of locations to produce an updated background graphic element said computer program product being characterized in that 

According to still another aspect of the present invention there is provided a computer program product having a computer readable medium having a computer program recorded therein for combining an upper graphic element and a lower graphic element each with color and opacity defined at a plurality of locations said computer program product comprising 

computer program code means for combining the said upper graphic element with the color of said lower graphic element using a transfer function without regard to the opacity of said lower graphic element to determine a combination graphic element 

computer program code means for determining at least one mask using the opacity of said lower graphic element or the opacity of said upper graphic element or both and

computer program code means for combining said combination graphic element with either the upper graphic element or the lower graphic element or both subject to masking by said at least one mask.

According to still another aspect of the present invention there is provided a method of combining an upper graphic element and a lower graphic element to produce a result graphic element said upper graphic element and said lower graphic element comprising color and opacity said method comprising the steps of 

combining the color of said upper graphic element with the color of said lower graphic element using a transfer function without regard to either opacity of said upper graphic element or opacity of said lower graphic element to determine a combination graphic element 

combining said combination graphic element with said upper graphic element according to said mask to produce said result graphic element wherein color of a location in said result graphic element is one of a palette of colors defined for said location said one color being dependent on one of either the opacity of said upper graphic element or the opacity of said lower graphic element.

Where reference is made in any one or more of the accompanying drawings to steps and or features which have the same reference numerals those steps and or features have for the purposes of this description the same function s or operation s unless the contrary intention appears.

A method see of combining an upper or first graphic element and a lower or second graphic element according to one embodiment of the present invention will now be described below with reference to . The method achieves a substantially similar visual result to generalized Porter and Duff compositing in the presence of a transfer function while only using a series of simpler graphical operations. These simpler graphical operations may be performed by a graphics accelerator that does not support generalized Porter and Duff compositing in the presence of a transfer function. One or both of the graphic elements are treated as purely opaque elements and are combined by a transfer function using available simple preferably accelerated operations.

Using a series of masked and or un masked painting operations preferably accelerated the upper graphic element the lower graphic element or the combination of the two graphic elements are painted to the result in patterns. These patterns achieve a visually similar result to generalized Porter and Duff compositing in the presence of a transfer function described in Long et. al. U.S. Pat. No. 6 483 519 . The result although different in detailed pixel values from the true color generated by generalized Porter and Duff compositing in the presence of a transfer function has a similar overall visual appearance. This similar visual appearance is produced through a set of simple operations that may be accelerated by many graphics accelerators which do not support generalized Porter and Duff compositing in the presence of transfer functions.

The method is preferably practiced using a general purpose computer system such as that shown in wherein the processes of may be implemented as software such as an application program executing within the computer system . Preferably the software uses a graphics accelerator to accelerate certain primitive operations. In particular the steps of the method are effected by instructions in the software that are carried out by the computer. The instructions may be formed as one or more code modules each for performing one or more particular tasks. The software may also be divided into two separate parts in which a first part performs the method and a second part manages a user interface between the first part and the user. The software may be stored in a computer readable medium including the storage devices described below for example. The software is loaded into the computer from the computer readable medium and then executed by the computer. A computer readable medium having such software or computer program recorded on it is a computer program product. The use of the computer program product in the computer preferably effects an advantageous apparatus for implementing the method .

The computer system is formed by a computer module input devices such as a keyboard and mouse output devices including a printer a display device and loudspeakers . A Modulator Demodulator Modem transceiver device is used by the computer module for communicating to and from a communications network for example connectable via a telephone line or other functional medium. The modem can be used to obtain access to the Internet and other network systems such as a Local Area Network LAN or a Wide Area Network WAN and may be incorporated into the computer module in some implementations.

The computer module typically includes at least one processor unit and a memory unit for example formed from semiconductor random access memory RAM and read only memory ROM . The module also includes an number of input output I O interfaces including an audio video interface that couples to the video display and loudspeakers an I O interface for the keyboard and mouse and optionally a joystick not illustrated and an interface for the modem and printer . In some implementations the modem may be incorporated within the computer module for example within the interface . A storage device is provided and typically includes a hard disk drive and a floppy disk drive . A magnetic tape drive not illustrated may also be used. A CD ROM drive is typically provided as a non volatile source of data. The components to of the computer module typically communicate via an interconnected bus and in a manner which results in a conventional mode of operation of the computer system known to those in the relevant art. Examples of computers on which the described arrangements can be practised include IBM PC s and compatibles Sun Sparcstations or alike computer systems evolved therefrom.

Typically the application program is resident on the hard disk drive and read and controlled in its execution by the processor . Intermediate storage of the program and any data fetched from the network may be accomplished using the semiconductor memory possibly in concert with the hard disk drive . In some instances the application program may be supplied to the user encoded on a CD ROM or floppy disk and read via the corresponding drive or or alternatively may be read by the user from the network via the modem device . Still further the software can also be loaded into the computer system from other computer readable media. The term computer readable medium as used herein refers to any storage or transmission medium that participates in providing instructions and or data to the computer system for execution and or processing. Examples of storage media include floppy disks magnetic tape CD ROM hard disk drive ROM or integrated circuit magneto optical disk or computer readable card and the like whether or not such devices are internal or external of the computer module .

The method may alternatively be implemented in dedicated hardware such as one or more integrated circuits performing the functions or sub functions of the described method. Such dedicated hardware may include graphic processors digital signal processors or one or more microprocessors and associated memories.

In the alpha compositing method disclosed by Porter and Duff the opacity value of a pixel is the proportion of a background or background graphic element that the pixel covers. That is a pixel is conceptually regarded as an area of opaque color with a hole through which the color of the background graphic element is visible. In this conceptual model the transparency of a pixel is represented by the size of the hole. Of course this model of a pixel regards a digital image as being tessellated into an array of pixels each of which covers an area. Other models such as that used by sampling theory are different but will not be considered here.

In the absence of primitive operations to support the determination of the result opacity and color in accordance Equations 7 and 8 the method uses a series of available primitive operations. The exact sequence of primitive operations depends on the available primitive operations of the graphics accelerator being used by the computer system . Examples of primitive capabilities of graphics accelerators include the following 

The methods of the preferred embodiment concern the efficient achievement of capability E in environments with capabilities limited to one of the capabilities A. through D. The methods of the preferred embodiment are based on recognition that certain of the color and opacity values contributing to the true pixel color hereafter contributing values may be generated with lower capability graphics accelerator operations. In particular the opaque transfer color T sc dc alone of region may be achieved with capability A. as may the opaque color sc of region and the opaque color dc of the region . Opaque color values may be obtained from partially opaque color values simply by ignoring i.e. without having regard to associated opacity. Purely transparent pixels may also be achieved. Further certain pair wise blends of the colors may also be achieved with capability D. specifically the weighted average between the opaque transfer color T sc dc of area and the opaque destination color dc of area .

The methods of the preferred embodiment achieve a similar visual result by selecting one contributing value at each pixel where the probability of selecting any one contributing value is weighted in the same manner as a weighted average which would be used to achieve the true color. Thus for example if a palette of contributing values representing colors consists of each of the opaque colors T sc dc sc and dc the relative probability of a result pixel being each of those colors will be by construction the area of regions and respectively. There is a remaining probability that the result pixel will be none of these colors representing the transparent hole . In this case the result pixel is fully transparent.

There are a number of different palettes from which contributing values may be selected. The ones of interest to the described methods are listed in the Table 2 below where dotted lines delimit alternative palettes.

There are other palette combinations possible such as those based on regions and however the complexity of their color and opacity equations means they are not of interest to the methods described herein.

The palette of contributing values of interest to the preferred embodiment of the present invention comprises s and dtc. As can be seen from Table 2 the formula for dtc is ro 1 T 1 which is identical to the formula for a graphic element with non unity opacity combined using a transfer function onto an opaque background graphic element see Equations 5 and 6 . Further the relative frequency of use of each of these values is simply the opacity component of the lower element and its complement.

There are a number of methods of determining the probability based selection required. In the methods described herein the techniques of color halftoning are adapted.

In halftoning a true color image in which each color component of each true color pixel has a large number of possible values is reduced to a halftoned image in which each color component of each halftoned pixel has just one of a small set of discrete color values. The probability of each discrete value is related to the true color value. There are many halftoning methods however two of the most commonly used methods are error diffusion and dither matrices both of which are well known in the art.

In the described methods a dither matrix is adapted for use. However an analogous adaptation of any halftoning method such as error diffusion is possible. A dither matrix such as the dither matrix of may be used. The dither matrix is conceptually tiled over the surface of a lower graphic element and used to derive a mask image with one bit of information per pixel. This is achieved by addressing the dither matrix with modulus arithmetic. At each location i.e. pixel the opacity channel is compared to the corresponding value in the dither matrix. If the opacity value is greater than the value of the dither matrix the mask has a one 1 value at that location else the mask has a value of zero 0 .

To achieve the appropriate probability or relative frequency of each of the contributing colors while still taking maximum advantage of graphics acceleration one or more such single bit per pixel image masks are generated by halftoning the relative contribution that is required for each contributing color. These image masks are used to mask painting operations of objects consisting of the contributing values which in some cases are the original operands.

In the preferred embodiment the final result is achieved using a graphics accelerator e.g. the graphics accelerator having capability D by the following numbered steps of the method described with reference to .

In the common case that the result of step is to be further composited over an opaque background the above method may be simplified. In particular the method may be simplified by at step compositing the upper graphic element s directly over the background instead of copying to the result buffer result then at step copying the temporary buffer temp where the mask mask is one 1 to the background instead of the result buffer result. This eliminates the need for an intermediate result buffer.

The preferred embodiment relies on the observation that the dtc contribution is completely opaque so may be copied over the previously painted s contribution thus overriding the value of s. Alternatively either dtc or s may be generated at each pixel depending on the mask value.

An example of the method will now be described with reference to . shows a 5 5 pixel upper graphic element which has a color and opacity at each pixel or location . In this example the opacity of each pixel of the upper graphic element is 0.5. The 50 opacity is represented diagrammatically by the half shading of each pixel. Similarly shows a lower graphic element which is a triangle. The lower graphic element also has a color and opacity at each pixel or location and the opacity is similarly 0.5 at each pixel. The color and opacity may be different from object to object and pixel to pixel however for simplicity in this example the color and opacity will be assumed to have only one value.

The upper graphic element is to be composited over the lower graphic clement at a location indicated by the dotted outline as seen in . The example will now be explained in the same numbered steps used to describe above 

As at the opacity component of the lower graphic element is used via the halftone dither matrix to determine a mask as seen in . The dither matrix is a 4 4 dither matrix for the simplicity of the example. In practice a larger dither matrix may be used. When a threshold value of 0.5 is applied to the dither matrix a checkerboard pattern results which is reflected in the checkerboard pattern of the mask . Values outside the bounds of the lower graphic element result in zero blank values in the mask .

The result graphic element as seen in although different from a true result graphic element in detail see has similar visual appearance for large collections of pixels especially in high resolution prints.

The method requires accelerator capability D. for step of the method . Where capabilities are more limited each of the contributing color values sc dc and tc may be copied to the result graphic element in the same manner using the relative probabilities for those values listed in the first palette of Table 1 above. This approach only requires accelerator capability A. above which is common to almost all graphic accelerators. However the result graphic element has a higher granularity than the method .

Thus by using a series of masked and or un masked painting operations preferably accelerated an upper graphic element a lower graphic element or a combination of the two may be painted to a result graphic element in patterns. These patterns achieve a visually similar result graphic element to generalized Porter and Duff compositing in the presence of a transfer function although different in detailed pixel values from the true color.

The aforementioned preferred method s comprise a particular control flow. There are many other variants of the preferred method s which use different control flows without departing the spirit or scope of the invention. Furthermore one or more of the steps of the preferred method s may be performed in parallel rather sequentially.

It is apparent from the above that the arrangements described are applicable to the computer and data processing industries.

The foregoing describes only some embodiments of the present invention and modifications and or changes can be made thereto without departing from the scope and spirit of the invention the embodiments being illustrative and not restrictive.

In the context of this specification the word comprising means including principally but not necessarily solely or having or including and not consisting only of . Variations of the word comprising such as comprise and comprises have correspondingly varied meanings.

